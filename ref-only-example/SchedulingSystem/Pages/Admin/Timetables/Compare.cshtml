@page
@using SchedulingSystem.Models
@model SchedulingSystem.Pages.Admin.Timetables.CompareModel
@{
    ViewData["Title"] = "Compare Timetables";
    var hasComparison = Model.Timetables.Any();
    var stats = Model.GetComparisonStats();
}

<div class="container-fluid py-4">
    @Html.AntiForgeryToken()

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-columns-gap"></i> Compare Timetables</h2>
            <p class="text-muted mb-0">View and compare multiple timetables side by side</p>
            @if (Model.TempTimetableId.HasValue)
            {
                <p class="text-warning mb-0 mt-1">
                    <i class="bi bi-exclamation-circle"></i> <small>Comparing with a temporary timetable</small>
                </p>
            }
        </div>
        <div>
            @if (Model.TempTimetableId.HasValue)
            {
                <button type="button" class="btn btn-danger me-2" id="deleteTempBtn" data-temp-id="@Model.TempTimetableId">
                    <i class="bi bi-trash"></i> Delete Temporary and Close
                </button>
            }
            @if (hasComparison)
            {
                <a href="/Admin/Timetables/Compare" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> New Comparison
                </a>
            }
            <a href="/Admin/Timetables/Index" class="btn btn-outline-primary">
                <i class="bi bi-calendar3"></i> All Timetables
            </a>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!hasComparison)
    {
        <!-- Selection Interface -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-check2-square"></i> Select Timetables to Compare</h5>
            </div>
            <div class="card-body">
                @if (!Model.AllTimetables.Any())
                {
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No timetables available. Create a timetable first.
                    </div>
                }
                else
                {
                    <p class="text-muted mb-3">Select at least 2 timetables to compare:</p>
                    <form method="get" id="comparisonForm">
                        <div class="row">
                            @foreach (var timetable in Model.AllTimetables)
                            {
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 timetable-selection-card">
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input timetable-checkbox" type="checkbox"
                                                       name="ids" value="@timetable.Id" id="tt-@timetable.Id">
                                                <label class="form-check-label w-100" for="tt-@timetable.Id">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="mb-0">@timetable.Name</h6>
                                                        <span class="badge bg-@(timetable.Status == TimetableStatus.Published ? "success" : timetable.Status == TimetableStatus.Draft ? "warning" : "secondary")">
                                                            @timetable.Status
                                                        </span>
                                                    </div>
                                                    <div class="small text-muted">
                                                        <div><i class="bi bi-calendar"></i> @timetable.SchoolYear?.Name</div>
                                                        @if (timetable.Term != null)
                                                        {
                                                            <div><i class="bi bi-calendar-range"></i> @timetable.Term.Name</div>
                                                        }
                                                        <div><i class="bi bi-clock"></i> @timetable.CreatedDate.ToString("MMM dd, yyyy")</div>
                                                        <div><i class="bi bi-book"></i> @timetable.ScheduledLessons.Count lessons</div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="mt-4 d-flex justify-content-between align-items-center">
                            <div class="text-muted">
                                <span id="selectedCount">0</span> timetable(s) selected
                            </div>
                            <button type="submit" class="btn btn-primary" id="compareBtn" disabled>
                                <i class="bi bi-columns-gap"></i> Compare Selected Timetables
                            </button>
                        </div>
                    </form>
                }
            </div>
        </div>
    }
    else
    {
        <!-- Comparison View -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Comparison Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-value">@stats.TotalTimetables</div>
                            <div class="stat-label">Timetables</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            <div class="stat-value">@stats.CommonLessons</div>
                            <div class="stat-label">Common Lessons (avg)</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-box">
                            @foreach (var kvp in stats.LessonsPerTimetable)
                            {
                                <div class="small">@kvp.Key: <strong>@kvp.Value lessons</strong></div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Merged Timetable View with XOR Results -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Merged Comparison (Showing Only Differences)</h5>
                <div class="d-flex gap-2">
                    <!-- View Mode Toggle -->
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="viewDetailed" value="detailed" checked>
                        <label class="btn btn-outline-primary" for="viewDetailed">
                            <i class="bi bi-card-text"></i> Detailed
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="viewCompact" value="compact">
                        <label class="btn btn-outline-primary" for="viewCompact">
                            <i class="bi bi-dash-square"></i> Compact
                        </label>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filters -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <i class="bi bi-funnel"></i> <strong>Filter Lessons</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="filterTeacher">
                                    <option value="">All Teachers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="filterSubject">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="filterClass">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm" id="filterRoom">
                                    <option value="">All Rooms</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-secondary" onclick="clearAllFilters()">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Timetable Grid -->
                <div class="table-responsive">
                    <table class="table table-bordered comparison-grid-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 120px;">Period</th>
                                @foreach (var day in Model.DaysWithDifferences)
                                {
                                    <th class="text-center day-header">
                                        <div class="fw-bold">@day.ToString().Substring(0, 3)</div>
                                        <div class="small text-muted">@day</div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var period in Model.Periods)
                            {
                                <tr>
                                    <td class="period-column text-center align-middle fw-bold bg-light">
                                        <div>@period.Name</div>
                                        <div class="small text-muted">
                                            @period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")
                                        </div>
                                    </td>
                                    @foreach (var day in Model.DaysWithDifferences)
                                    {
                                        var mergedLessons = Model.GetMergedLessonsForSlot(day, period.Id);
                                        <td class="lesson-cell" data-day="@day" data-period="@period.Id">
                                            <div class="lesson-cell-content">
                                                @if (mergedLessons.Any())
                                                {
                                                    @foreach (var mergedLesson in mergedLessons)
                                                {
                                                    var lesson = mergedLesson.Lesson;
                                                    var timetableIndex = mergedLesson.TimetableIndex;
                                                    var timetableName = mergedLesson.TimetableName;
                                                    var colorClass = timetableIndex == 0 ? "timetable-1" : "timetable-2";
                                                    var isMultiTeacher = lesson.Lesson?.LessonTeachers.Count > 1;
                                                    var isMultiSubject = lesson.Lesson?.LessonSubjects.Count > 1;
                                                    var isMultiClass = lesson.Lesson?.LessonClasses.Count > 1;
                                                    var isMultiRoom = lesson.ScheduledLessonRooms.Count > 1;

                                                    var teacherNames = string.Join("|", lesson.Lesson?.LessonTeachers.Select(lt => lt.Teacher?.FullName ?? "") ?? Array.Empty<string>());
                                                    var subjectNames = string.Join("|", lesson.Lesson?.LessonSubjects.Select(ls => ls.Subject?.Name ?? "") ?? Array.Empty<string>());
                                                    var classNames = string.Join("|", lesson.Lesson?.LessonClasses.Select(lc => lc.Class?.Name ?? "") ?? Array.Empty<string>());
                                                    var roomNumbers = lesson.ScheduledLessonRooms.Any()
                                                        ? string.Join("|", lesson.ScheduledLessonRooms.Select(slr => slr.Room?.RoomNumber ?? ""))
                                                        : (lesson.Room?.RoomNumber ?? "");

                                                    <div class="lesson-card @colorClass"
                                                         data-lesson-id="@lesson.LessonId"
                                                         data-scheduled-lesson-id="@lesson.Id"
                                                         data-timetable-index="@timetableIndex"
                                                         data-teacher="@teacherNames"
                                                         data-subject="@subjectNames"
                                                         data-class="@classNames"
                                                         data-room="@roomNumbers">

                                                        @if (lesson.IsLocked)
                                                        {
                                                            <i class="bi bi-lock-fill lock-icon" title="Locked"></i>
                                                        }

                                                        <!-- Detailed View Content -->
                                                        <div class="lesson-content-detailed">
                                                            <div class="lesson-subject">
                                                                <i class="bi bi-book"></i>
                                                                @string.Join(", ", lesson.Lesson?.LessonSubjects.Select(ls => ls.Subject?.Code ?? ls.Subject?.Name ?? "?") ?? Array.Empty<string>())
                                                                @if (isMultiSubject) { <span class="badge badge-multisubject">MS</span> }
                                                            </div>
                                                            <div class="lesson-class">
                                                                <i class="bi bi-people"></i>
                                                                @string.Join(", ", lesson.Lesson?.LessonClasses.Select(lc => lc.Class?.Name ?? "?") ?? Array.Empty<string>())
                                                                @if (isMultiClass) { <span class="badge badge-multiclass">MC</span> }
                                                            </div>
                                                            <div class="lesson-teacher">
                                                                <i class="bi bi-person"></i>
                                                                @string.Join(", ", lesson.Lesson?.LessonTeachers.Select(lt => lt.Teacher?.ShortName ?? "?") ?? Array.Empty<string>())
                                                                @if (isMultiTeacher) { <span class="badge badge-coteaching">CT</span> }
                                                            </div>
                                                            <div class="lesson-room">
                                                                <i class="bi bi-door-closed"></i> @Model.GetRoomDescription(lesson)
                                                                @if (isMultiRoom) { <span class="badge badge-multiroom">MR</span> }
                                                            </div>
                                                            <div class="lesson-source">
                                                                <span class="badge bg-secondary">@timetableName</span>
                                                            </div>
                                                        </div>

                                                        <!-- Compact View Content -->
                                                        <div class="lesson-content-compact" style="display: none;">
                                                            <span class="fw-bold" style="font-size: 0.85rem;">
                                                                @{
                                                                    var subjects = lesson.Lesson?.LessonSubjects ?? Enumerable.Empty<LessonSubject>();
                                                                    var classes = lesson.Lesson?.LessonClasses ?? Enumerable.Empty<LessonClass>();
                                                                    var teachers = lesson.Lesson?.LessonTeachers ?? Enumerable.Empty<LessonTeacher>();
                                                                }
                                                                @if (subjects.Count() > 1)
                                                                {
                                                                    @string.Join("/", subjects.Select(ls => ls.Subject?.Code ?? "?"))
                                                                }
                                                                else
                                                                {
                                                                    @(subjects.FirstOrDefault()?.Subject?.Code ?? "N/A")
                                                                }
                                                                ·
                                                                @if (classes.Count() > 1)
                                                                {
                                                                    @string.Join("+", classes.Select(lc => lc.Class?.Name ?? "?"))
                                                                }
                                                                else
                                                                {
                                                                    @(classes.FirstOrDefault()?.Class?.Name ?? "N/A")
                                                                }
                                                                @if (!string.IsNullOrEmpty(roomNumbers.Replace("|", "")))
                                                                {
                                                                    <span> · @roomNumbers.Replace("|", ", ")</span>
                                                                }
                                                            </span>
                                                        </div>

                                                        <!-- Info Button -->
                                                        <button class="btn btn-sm btn-link info-btn"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#lessonInfoModal"
                                                                data-subjects="@string.Join(", ", lesson.Lesson?.LessonSubjects.Select(ls => ls.Subject?.Name ?? "") ?? Array.Empty<string>())"
                                                                data-classes="@string.Join(", ", lesson.Lesson?.LessonClasses.Select(lc => lc.Class?.Name ?? "") ?? Array.Empty<string>())"
                                                                data-teachers="@string.Join(", ", lesson.Lesson?.LessonTeachers.Select(lt => lt.Teacher?.FullName ?? "") ?? Array.Empty<string>())"
                                                                data-rooms="@Model.GetRoomDescription(lesson)"
                                                                data-timetable="@timetableName">
                                                            <i class="bi bi-info-circle"></i>
                                                        </button>
                                                    </div>
                                                }
                                                }
                                                else
                                                {
                                                    <div class="text-muted text-center small">—</div>
                                                }
                                            </div>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h6 class="mb-3"><i class="bi bi-info-circle"></i> Legend</h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="legend-item">
                            <span class="legend-badge timetable-1-badge">Timetable 1</span>
                            <span>= @(Model.Timetables.Count > 0 ? Model.Timetables[0].Timetable.Name : "First Timetable")</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-badge timetable-2-badge">Timetable 2</span>
                            <span>= @(Model.Timetables.Count > 1 ? Model.Timetables[1].Timetable.Name : "Second Timetable")</span>
                        </div>
                        <div class="legend-item">
                            <i class="bi bi-lock-fill"></i>
                            <span>= Locked lesson</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="legend-item">
                            <span class="badge badge-coteaching">CT</span>
                            <span>= Co-teaching</span>
                        </div>
                        <div class="legend-item">
                            <span class="badge badge-multisubject">MS</span>
                            <span>= Multi-subject</span>
                        </div>
                        <div class="legend-item">
                            <span class="badge badge-multiclass">MC</span>
                            <span>= Multi-class</span>
                        </div>
                        <div class="legend-item">
                            <span class="badge badge-multiroom">MR</span>
                            <span>= Multi-room</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Lesson Info Modal -->
    <div class="modal fade" id="lessonInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> Lesson Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-detail">
                        <strong>Subject(s):</strong>
                        <span id="modal-subjects"></span>
                    </div>
                    <div class="info-detail">
                        <strong>Class(es):</strong>
                        <span id="modal-classes"></span>
                    </div>
                    <div class="info-detail">
                        <strong>Teacher(s):</strong>
                        <span id="modal-teachers"></span>
                    </div>
                    <div class="info-detail">
                        <strong>Room(s):</strong>
                        <span id="modal-rooms"></span>
                    </div>
                    <div class="info-detail">
                        <strong>From Timetable:</strong>
                        <span id="modal-timetable"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>

@section Scripts {
    <script src="~/js/filter-state.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.timetable-checkbox');
            const compareBtn = document.getElementById('compareBtn');
            const selectedCount = document.getElementById('selectedCount');

            function updateSelection() {
                const checked = document.querySelectorAll('.timetable-checkbox:checked').length;
                if (selectedCount) selectedCount.textContent = checked;
                if (compareBtn) compareBtn.disabled = checked < 2;

                // Update card highlighting
                checkboxes.forEach(cb => {
                    const card = cb.closest('.timetable-selection-card');
                    if (cb.checked) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
            }

            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateSelection);
            });

            updateSelection();

            // Handle delete temporary timetable button
            const deleteTempBtn = document.getElementById('deleteTempBtn');
            if (deleteTempBtn) {
                deleteTempBtn.addEventListener('click', async function() {
                    const tempId = this.dataset.tempId;

                    if (!confirm('Are you sure you want to delete the temporary timetable and close this comparison?')) {
                        return;
                    }

                    try {
                        const response = await fetch('/Admin/Timetables/Compare?handler=DeleteTemp', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                            },
                            body: JSON.stringify({ tempId: parseInt(tempId) })
                        });

                        const result = await response.json();
                        if (result.success) {
                            alert('Temporary timetable deleted successfully');
                            window.close();
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch (error) {
                        alert('Error: ' + error.message);
                    }
                });
            }

            // Initialize merged comparison view features
            initializeFilters();
            initializeViewMode();
            initializeHoverHighlighting();
            initializeInfoModal();
        });

        // Initialize cascading filters
        function initializeFilters() {
            const allLessons = [];

            // Collect all lesson data
            document.querySelectorAll('.lesson-card').forEach(card => {
                const teachers = (card.dataset.teacher || '').split('|').filter(t => t.trim());
                const subjects = (card.dataset.subject || '').split('|').filter(s => s.trim());
                const classes = (card.dataset.class || '').split('|').filter(c => c.trim());
                const rooms = (card.dataset.room || '').split('|').filter(r => r.trim());

                allLessons.push({
                    element: card,
                    teachers: teachers,
                    subjects: subjects,
                    classes: classes,
                    rooms: rooms
                });
            });

            // Populate initial filter options
            populateFilterOptions(allLessons);

            // Add change listeners with filter state saving
            document.getElementById('filterTeacher')?.addEventListener('change', () => {
                applyFilters(allLessons);
                saveFilterState();
            });
            document.getElementById('filterSubject')?.addEventListener('change', () => {
                applyFilters(allLessons);
                saveFilterState();
            });
            document.getElementById('filterClass')?.addEventListener('change', () => {
                applyFilters(allLessons);
                saveFilterState();
            });
            document.getElementById('filterRoom')?.addEventListener('change', () => {
                applyFilters(allLessons);
                saveFilterState();
            });

            // Save current filter values
            function saveFilterState() {
                FilterState.save({
                    teacher: document.getElementById('filterTeacher')?.value || '',
                    subject: document.getElementById('filterSubject')?.value || '',
                    class: document.getElementById('filterClass')?.value || '',
                    room: document.getElementById('filterRoom')?.value || ''
                });
            }

            // Restore saved filters
            const savedFilters = FilterState.restore();
            if (savedFilters.teacher || savedFilters.subject || savedFilters.class || savedFilters.room) {
                if (savedFilters.teacher) {
                    const teacherSelect = document.getElementById('filterTeacher');
                    if (teacherSelect) teacherSelect.value = savedFilters.teacher;
                }
                if (savedFilters.subject) {
                    const subjectSelect = document.getElementById('filterSubject');
                    if (subjectSelect) subjectSelect.value = savedFilters.subject;
                }
                if (savedFilters.class) {
                    const classSelect = document.getElementById('filterClass');
                    if (classSelect) classSelect.value = savedFilters.class;
                }
                if (savedFilters.room) {
                    const roomSelect = document.getElementById('filterRoom');
                    if (roomSelect) roomSelect.value = savedFilters.room;
                }
                applyFilters(allLessons);
            }

            function populateFilterOptions(allLessons) {
                const teachers = new Set();
                const subjects = new Set();
                const classes = new Set();
                const rooms = new Set();

                allLessons.forEach(lesson => {
                    lesson.teachers.forEach(t => teachers.add(t));
                    lesson.subjects.forEach(s => subjects.add(s));
                    lesson.classes.forEach(c => classes.add(c));
                    lesson.rooms.forEach(r => rooms.add(r));
                });

                // Populate dropdowns
                populateSelect('filterTeacher', Array.from(teachers).sort());
                populateSelect('filterSubject', Array.from(subjects).sort());
                populateSelect('filterClass', Array.from(classes).sort());
                populateSelect('filterRoom', Array.from(rooms).sort());
            }

            function populateSelect(selectId, options) {
                const select = document.getElementById(selectId);
                if (!select) return;

                // Keep the "All" option
                const currentValue = select.value;
                const allOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(allOption);

                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    select.appendChild(opt);
                });

                select.value = currentValue;
            }

            function applyFilters(allLessons) {
                const filterTeacher = document.getElementById('filterTeacher')?.value || '';
                const filterSubject = document.getElementById('filterSubject')?.value || '';
                const filterClass = document.getElementById('filterClass')?.value || '';
                const filterRoom = document.getElementById('filterRoom')?.value || '';

                allLessons.forEach(lesson => {
                    let show = true;

                    if (filterTeacher && !lesson.teachers.includes(filterTeacher)) show = false;
                    if (filterSubject && !lesson.subjects.includes(filterSubject)) show = false;
                    if (filterClass && !lesson.classes.includes(filterClass)) show = false;
                    if (filterRoom && !lesson.rooms.includes(filterRoom)) show = false;

                    lesson.element.style.display = show ? '' : 'none';
                });

                // Hide empty cells
                document.querySelectorAll('.lesson-cell').forEach(cell => {
                    const visibleCards = Array.from(cell.querySelectorAll('.lesson-card'))
                        .filter(card => card.style.display !== 'none');

                    if (visibleCards.length === 0) {
                        const emptyMsg = cell.querySelector('.text-muted');
                        if (emptyMsg) emptyMsg.style.display = '';
                    } else {
                        const emptyMsg = cell.querySelector('.text-muted');
                        if (emptyMsg) emptyMsg.style.display = 'none';
                    }
                });
            }
        }

        function clearAllFilters() {
            document.getElementById('filterTeacher').value = '';
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterClass').value = '';
            document.getElementById('filterRoom').value = '';

            // Clear saved filter state
            FilterState.clear();

            // Show all lessons
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.style.display = '';
            });

            // Reset empty cells
            document.querySelectorAll('.lesson-cell .text-muted').forEach(msg => {
                const cell = msg.closest('.lesson-cell');
                const hasVisibleCards = cell.querySelectorAll('.lesson-card:not([style*="display: none"])').length > 0;
                msg.style.display = hasVisibleCards ? 'none' : '';
            });
        }

        // Initialize view mode toggle (detailed vs compact)
        function initializeViewMode() {
            const detailedRadio = document.getElementById('viewDetailed');
            const compactRadio = document.getElementById('viewCompact');

            if (detailedRadio) {
                detailedRadio.addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('.lesson-content-detailed').forEach(el => el.style.display = '');
                        document.querySelectorAll('.lesson-content-compact').forEach(el => el.style.display = 'none');
                        document.querySelectorAll('.lesson-card').forEach(card => card.classList.remove('compact-mode'));
                    }
                });
            }

            if (compactRadio) {
                compactRadio.addEventListener('change', function() {
                    if (this.checked) {
                        document.querySelectorAll('.lesson-content-detailed').forEach(el => el.style.display = 'none');
                        document.querySelectorAll('.lesson-content-compact').forEach(el => el.style.display = '');
                        document.querySelectorAll('.lesson-card').forEach(card => card.classList.add('compact-mode'));
                    }
                });
            }
        }

        // Initialize hover highlighting for same LessonID
        function initializeHoverHighlighting() {
            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    const lessonId = this.dataset.lessonId;

                    // Highlight all cards with same lessonId
                    document.querySelectorAll('.lesson-card').forEach(otherCard => {
                        if (otherCard.dataset.lessonId === lessonId) {
                            otherCard.classList.add('highlight-same-lesson');
                        } else {
                            otherCard.classList.add('dimmed');
                        }
                    });
                });

                card.addEventListener('mouseleave', function() {
                    // Remove all highlighting
                    document.querySelectorAll('.lesson-card').forEach(otherCard => {
                        otherCard.classList.remove('highlight-same-lesson', 'dimmed');
                    });
                });
            });
        }

        // Initialize info button modal
        function initializeInfoModal() {
            const infoModal = document.getElementById('lessonInfoModal');
            if (!infoModal) return;

            infoModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;

                document.getElementById('modal-subjects').textContent = button.dataset.subjects || 'N/A';
                document.getElementById('modal-classes').textContent = button.dataset.classes || 'N/A';
                document.getElementById('modal-teachers').textContent = button.dataset.teachers || 'N/A';
                document.getElementById('modal-rooms').textContent = button.dataset.rooms || 'N/A';
                document.getElementById('modal-timetable').textContent = button.dataset.timetable || 'N/A';
            });
        }
    </script>
}

@section Styles {
    <style>
        /* Selection Interface */
        .timetable-selection-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .timetable-selection-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .timetable-selection-card.selected {
            border-color: #198754;
            background-color: #f8fff9;
        }

        .timetable-selection-card .form-check-input {
            cursor: pointer;
            width: 1.5rem;
            height: 1.5rem;
        }

        .timetable-selection-card .form-check-label {
            cursor: pointer;
            padding-left: 0.5rem;
        }

        /* Statistics */
        .stat-box {
            padding: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0d6efd;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            text-transform: uppercase;
        }

        /* Comparison Table */
        .comparison-table {
            font-size: 0.85rem;
        }

        .comparison-header {
            min-width: 200px;
            background-color: #f8f9fa;
        }

        .day-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-width: 60px;
        }

        .lesson-cell {
            padding: 0.5rem;
            vertical-align: top;
            min-height: 80px;
            background-color: #fff;
            position: relative;
        }

        .period-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .lesson-card.compact {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .lesson-card.compact:last-child {
            margin-bottom: 0;
        }

        .lesson-card.locked-lesson {
            border: 2px solid #ffc107;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .lock-icon {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            font-size: 0.75rem;
            color: #ffc107;
        }

        .lesson-subject {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .lesson-class {
            margin-bottom: 0.25rem;
        }

        .lesson-teacher {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .lesson-room {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        /* Badges */
        .badge-coteaching,
        .badge-multisubject,
        .badge-multiclass,
        .badge-multiroom {
            font-size: 0.6rem;
            padding: 0.15rem 0.3rem;
            margin-left: 0.25rem;
        }

        .badge-coteaching {
            background-color: #fd7e14;
        }

        .badge-multisubject {
            background-color: #0dcaf0;
        }

        .badge-multiclass {
            background-color: #20c997;
        }

        .badge-multiroom {
            background-color: #6f42c1;
        }

        /* Highlight differences */
        .slot-different {
            background-color: #fff3cd;
        }

        .cell-highlight {
            border-left: 3px solid #ffc107;
        }

        /* Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .legend-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        /* Print styles */
        @@media print {
            .btn, .card-header .btn-group {
                display: none !important;
            }

            .comparison-table {
                font-size: 0.7rem;
            }

            .lesson-card.compact {
                page-break-inside: avoid;
            }
        }

        /* Sticky header */
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* ===== Merged Comparison View Styles ===== */

        /* Timetable Grid */
        .comparison-grid-table {
            font-size: 0.9rem;
        }

        .comparison-grid-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .comparison-grid-table .day-header {
            min-width: 120px;
        }

        .comparison-grid-table .period-column {
            font-weight: 600;
            min-width: 120px;
        }

        .comparison-grid-table .lesson-cell {
            vertical-align: top;
            padding: 0;
            min-height: 80px;
            position: relative;
        }

        .lesson-cell-content {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-content: flex-start;
            padding: 8px;
        }

        /* Lesson Cards */
        .lesson-card {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
            flex: 0 0 auto;
            width: 100%;
        }

        /* Compact mode: allow cards to flow inline */
        .lesson-card.compact-mode {
            width: auto;
            padding: 4px 8px;
            display: inline-flex;
            align-items: center;
            max-width: 100%; /* Prevent cards from exceeding container width */
        }

        /* Color coding for different timetables */
        .lesson-card.timetable-1 {
            background-color: #e3f2fd; /* Light blue */
            border-color: #2196f3;
        }

        .lesson-card.timetable-2 {
            background-color: #fff3e0; /* Light orange */
            border-color: #ff9800;
        }

        /* Hover highlighting */
        .lesson-card.highlight-same-lesson {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
            border-width: 3px;
        }

        .lesson-card.timetable-1.highlight-same-lesson {
            border-color: #1976d2;
            background-color: #bbdefb;
        }

        .lesson-card.timetable-2.highlight-same-lesson {
            border-color: #f57c00;
            background-color: #ffe0b2;
        }

        .lesson-card.dimmed {
            opacity: 0.3;
            filter: grayscale(50%);
        }

        /* Lesson content */
        .lesson-content-detailed > div {
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .lesson-content-detailed > div:last-child {
            margin-bottom: 0;
        }

        .lesson-content-compact {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 28px; /* Make room for info button */
            flex: 1;
            min-width: 0; /* Allow flex item to shrink below content size */
        }

        .lesson-subject {
            font-weight: 600;
            color: #2c3e50;
        }

        .lesson-class {
            color: #34495e;
        }

        .lesson-teacher {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        .lesson-room {
            color: #95a5a6;
            font-size: 0.8rem;
        }

        .lesson-source {
            margin-top: 4px;
            font-size: 0.75rem;
        }

        /* Info button */
        .info-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 2px 6px;
            font-size: 0.85rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .lesson-card:hover .info-btn {
            opacity: 1;
        }

        /* Lock icon */
        .lock-icon {
            position: absolute;
            top: 4px;
            left: 4px;
            color: #f39c12;
            font-size: 0.9rem;
        }

        /* Timetable badges in legend */
        .timetable-1-badge {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            color: #1565c0;
        }

        .timetable-2-badge {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
            color: #e65100;
        }

        /* Modal */
        .info-detail {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .info-detail:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .info-detail strong {
            display: block;
            margin-bottom: 4px;
            color: #495057;
            font-size: 0.9rem;
        }

        .info-detail span {
            color: #212529;
            font-size: 1rem;
        }
    </style>
}
