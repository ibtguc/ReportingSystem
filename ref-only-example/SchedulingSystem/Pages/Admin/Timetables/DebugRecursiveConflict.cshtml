@page
@model SchedulingSystem.Pages.Admin.Timetables.DebugRecursiveConflictModel
@{
    ViewData["Title"] = "Debug: Recursive Conflict Resolution";
}

<style>
    /* Tree structure styles */
    .debug-tree {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
    }

    .tree-node {
        margin-left: 20px;
        border-left: 2px solid #dee2e6;
        padding-left: 15px;
        margin-top: 5px;
    }

    .tree-node-header {
        cursor: pointer;
        padding: 8px 12px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 5px;
        transition: all 0.2s;
    }

    .tree-node-header:hover {
        background: #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .tree-node-header.success {
        background: #d1e7dd;
        border-color: #badbcc;
    }

    .tree-node-header.failure {
        background: #f8d7da;
        border-color: #f5c2c7;
    }

    .tree-node-header.resolving {
        background: #fff3cd;
        border-color: #ffecb5;
    }

    .tree-node-header.timeout {
        background: #ced4da;
        border-color: #adb5bd;
    }

    .tree-node-content {
        padding: 10px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .tree-node-content.collapsed {
        display: none;
    }

    .depth-indicator {
        display: inline-block;
        padding: 2px 8px;
        background: #6c757d;
        color: white;
        border-radius: 3px;
        font-size: 11px;
        margin-right: 8px;
    }

    .depth-0 { background: #0d6efd; }
    .depth-1 { background: #6610f2; }
    .depth-2 { background: #6f42c1; }
    .depth-3 { background: #d63384; }
    .depth-4 { background: #dc3545; }
    .depth-5 { background: #fd7e14; }

    .expand-icon {
        transition: transform 0.2s;
        display: inline-block;
        margin-right: 5px;
    }

    .expand-icon.collapsed {
        transform: rotate(-90deg);
    }

    .conflict-badge {
        background: #ffc107;
        color: #000;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: bold;
    }

    .stats-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .stat-item {
        display: inline-block;
        margin-right: 20px;
    }

    .stat-label {
        font-weight: bold;
        color: #6c757d;
    }

    .stat-value {
        font-size: 1.2em;
        color: #212529;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        text-align: center;
        min-width: 300px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .hidden {
        display: none;
    }
</style>

<div class="container-fluid py-4">
    @Html.AntiForgeryToken()

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2>
                <i class="bi bi-bug"></i> Debug: Recursive Conflict Resolution
            </h2>
            <p class="text-muted">
                Complete visualization of the algorithm execution tree
            </p>
        </div>
    </div>

    <!-- Configuration Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Timetable:</strong> @Model.Timetable?.Name
                        </div>
                        <div class="col-md-3">
                            <strong>Algorithm:</strong> @Model.Algorithm
                        </div>
                        <div class="col-md-3">
                            <strong>Max Depth:</strong> @Model.MaxDepth
                        </div>
                        <div class="col-md-3">
                            <strong>Max Time:</strong> @Model.MaxTimeMinutes minutes
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>Selected Lessons:</strong>
                            <ul class="list-unstyled ms-3 mt-2">
                                @foreach (var lesson in Model.SelectedLessons)
                                {
                                    var subject = lesson.Lesson.LessonSubjects.FirstOrDefault()?.Subject.Name ?? "Unknown";
                                    var className = lesson.Lesson.LessonClasses.FirstOrDefault()?.Class.Name ?? "Unknown";
                                    <li>
                                        <i class="bi bi-book"></i>
                                        @subject - @className
                                        <span class="badge bg-secondary">@lesson.DayOfWeek @lesson.Period?.Name</span>
                                    </li>
                                }
                            </ul>
                        </div>
                        <div class="col-md-6">
                            @if (!string.IsNullOrEmpty(Model.DestinationDay))
                            {
                                <strong>Destination Slot:</strong>
                                <span class="badge bg-info">@Model.DestinationDay, Period @Model.DestinationPeriodId</span>
                            }
                            @if (!string.IsNullOrEmpty(Model.IgnoredConstraints))
                            {
                                <div class="mt-2">
                                    <strong>Ignored Constraints:</strong> @Model.IgnoredConstraints
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-box">
                <div class="stat-item">
                    <span class="stat-label">Status:</span>
                    <span class="stat-value" id="debugStatus">Ready</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Nodes Explored:</span>
                    <span class="stat-value" id="nodesExplored">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Max Depth Reached:</span>
                    <span class="stat-value" id="maxDepthReached">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Solutions Found:</span>
                    <span class="stat-value" id="solutionsFound">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Elapsed Time:</span>
                    <span class="stat-value" id="elapsedTime">0ms</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Buttons -->
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-success" id="startDebugBtn">
                <i class="bi bi-play-fill"></i> Start Algorithm
            </button>
            <button type="button" class="btn btn-secondary" id="expandAllBtn" disabled>
                <i class="bi bi-arrows-expand"></i> Expand All
            </button>
            <button type="button" class="btn btn-secondary" id="collapseAllBtn" disabled>
                <i class="bi bi-arrows-collapse"></i> Collapse All
            </button>
            <button type="button" class="btn btn-outline-secondary" id="exportJsonBtn" disabled>
                <i class="bi bi-download"></i> Export JSON
            </button>
        </div>
    </div>

    <!-- Debug Tree -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Execution Tree</h5>
                </div>
                <div class="card-body">
                    <div id="debugTree" class="debug-tree">
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-hourglass-split" style="font-size: 3em;"></i>
                            <p class="mt-3">Click "Start Algorithm" to begin debugging</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-content">
        <div class="spinner"></div>
        <h4>Running Algorithm...</h4>
        <p class="text-muted mb-0">Please wait while the algorithm explores all possibilities</p>
        <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 4px;">
            <div class="mb-2">
                <strong>Started at:</strong> <span id="algorithmStartTime" class="text-primary">--:--:--</span>
            </div>
            <div>
                <strong>Time elapsed:</strong> <span id="algorithmElapsedTime" class="text-success fw-bold">0s</span>
            </div>
        </div>
        <p class="text-muted small mt-2">Maximum time: @Model.MaxTimeMinutes minutes</p>
    </div>
</div>

@section Scripts {
    <script>
        let debugData = null;
        let loadingStartTime = null;
        let loadingTimerInterval = null;

        // Format time as HH:MM:SS
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour12: false });
        }

        // Format elapsed time
        function formatElapsed(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Start loading timer
        function startLoadingTimer() {
            loadingStartTime = new Date();
            document.getElementById('algorithmStartTime').textContent = formatTime(loadingStartTime);
            document.getElementById('algorithmElapsedTime').textContent = '0s';

            loadingTimerInterval = setInterval(() => {
                const elapsed = Date.now() - loadingStartTime.getTime();
                document.getElementById('algorithmElapsedTime').textContent = formatElapsed(elapsed);
            }, 1000);
        }

        // Stop loading timer
        function stopLoadingTimer() {
            if (loadingTimerInterval) {
                clearInterval(loadingTimerInterval);
                loadingTimerInterval = null;
            }
        }

        // Start algorithm
        document.getElementById('startDebugBtn').addEventListener('click', async function() {
            const startBtn = this;
            startBtn.disabled = true;

            // Show loading overlay with timer
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('debugStatus').textContent = 'Running...';
            startLoadingTimer();

            try {
                // Call API and wait for complete result
                const response = await fetch('?handler=StartDebug', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        sessionId: '@Model.SessionId',
                        timetableId: @Model.TimetableId,
                        selectedLessonIds: '@Model.SelectedLessonIds',
                        maxDepth: @Model.MaxDepth,
                        maxTimeMinutes: @Model.MaxTimeMinutes,
                        ignoredConstraints: '@Model.IgnoredConstraints'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Algorithm failed');
                }

                // Store data for export
                debugData = data;

                // Update statistics
                document.getElementById('nodesExplored').textContent = data.nodesExplored || 0;
                document.getElementById('maxDepthReached').textContent = data.maxDepth || 0;
                document.getElementById('solutionsFound').textContent = data.solutionsFound || 0;
                document.getElementById('elapsedTime').textContent = (data.elapsedMs || 0) + 'ms';
                document.getElementById('debugStatus').textContent = 'Complete';

                // Build tree from debug events
                buildTreeFromEvents(data.debugEvents || []);

                // Enable buttons
                document.getElementById('expandAllBtn').disabled = false;
                document.getElementById('collapseAllBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;

            } catch (error) {
                console.error('Error:', error);
                alert('Error running algorithm: ' + error.message);
                document.getElementById('debugStatus').textContent = 'Error';
                startBtn.disabled = false;
            } finally {
                // Stop timer and hide loading overlay
                stopLoadingTimer();
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        });

        // Build tree from debug events
        function buildTreeFromEvents(events) {
            const tree = document.getElementById('debugTree');
            tree.innerHTML = '';

            if (events.length === 0) {
                tree.innerHTML = '<div class="text-center text-muted p-3">No debug events recorded</div>';
                return;
            }

            // Build node map for quick lookup
            const nodeMap = new Map();
            const childrenMap = new Map();

            // Group events by parent
            events.forEach(event => {
                if (!childrenMap.has(event.parentId || 'root')) {
                    childrenMap.set(event.parentId || 'root', []);
                }
                childrenMap.get(event.parentId || 'root').push(event);
            });

            // Recursive function to build tree
            function buildNode(event, isRoot = false) {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = isRoot ? '' : 'tree-node';

                // Determine status class
                let statusClass = 'resolving';
                if (event.result === 'success') statusClass = 'success';
                else if (event.result === 'failure' || event.result === 'cycle' || event.result === 'locked') statusClass = 'failure';
                else if (event.result === 'timeout' || event.result === 'max_depth') statusClass = 'timeout';

                // Create node content
                let detailsHtml = `
                    <div class="mt-2">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <strong>üìö Lesson:</strong> ${event.lessonDescription || `ID ${event.lessonId}`}
                            </div>
                            <div class="col-md-6">
                                <strong>üéØ Target Slot:</strong> <code>${event.targetSlot}</code>
                            </div>
                        </div>
                        <div class="row g-2 mt-1">
                            <div class="col-md-6">
                                <strong>üìç Original Position:</strong> <code>${event.originalPosition || 'N/A'}</code>
                            </div>
                            <div class="col-md-6">
                                <strong>‚è±Ô∏è Elapsed:</strong> ${event.elapsedMs || 0}ms
                            </div>
                        </div>
                `;

                // Show conflicts if any
                if (event.conflicts > 0 && event.conflictingLessons && event.conflictingLessons.length > 0) {
                    detailsHtml += `
                        <div class="mt-2">
                            <strong>‚ö†Ô∏è Conflicts Found (${event.conflicts}):</strong>
                            <ul class="small mb-0 mt-1">
                                ${event.conflictingLessons.map(c => `
                                    <li>${c.description || 'Lesson ' + c.lessonId} at <code>${c.slot}</code> ${c.isLocked ? '<span class="badge bg-danger">Locked</span>' : ''}</li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Show visited lessons (cycle prevention)
                if (event.visitedLessons && event.visitedLessons.length > 0) {
                    detailsHtml += `
                        <div class="mt-2">
                            <strong>üëÅÔ∏è Visited Lessons (Cycle Prevention):</strong>
                            <div class="small"><code>${event.visitedLessons.join(', ')}</code></div>
                        </div>
                    `;
                }

                // Show proposed moves (shared state)
                if (event.proposedMoves && event.proposedMoves.length > 0) {
                    detailsHtml += `
                        <div class="mt-2">
                            <strong>üìù Proposed Moves (Shared State):</strong>
                            <ul class="small mb-0 mt-1">
                                ${event.proposedMoves.map(m => `
                                    <li>Lesson ${m.lessonId} ‚Üí <code>${m.slot}</code></li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                // Show quality score if available
                if (event.qualityScore !== undefined && event.qualityScore !== null) {
                    detailsHtml += `
                        <div class="mt-2">
                            <strong>‚≠ê Quality Score:</strong> ${event.qualityScore.toFixed(2)}
                        </div>
                    `;
                }

                // Show result message
                if (event.message) {
                    const messageClass = statusClass === 'success' ? 'text-success' : statusClass === 'failure' ? 'text-danger' : 'text-muted';
                    detailsHtml += `
                        <div class="mt-2">
                            <strong>üí¨ Result:</strong>
                            <span class="${messageClass}">${event.message}</span>
                        </div>
                    `;
                }

                detailsHtml += `</div>`;

                // Build header
                const hasChildren = childrenMap.has(event.nodeId);
                nodeDiv.innerHTML = `
                    <div class="tree-node-header ${statusClass}" onclick="toggleNode(this)">
                        ${hasChildren ? '<span class="expand-icon">‚ñº</span>' : '<span class="expand-icon" style="visibility:hidden">‚ñº</span>'}
                        <span class="depth-indicator depth-${Math.min(event.depth, 5)}">D${event.depth}</span>
                        <strong>${event.type}</strong>: ${event.lessonDescription || 'Lesson ' + event.lessonId} ‚Üí ${event.targetSlot}
                        ${event.conflicts > 0 ? `<span class="conflict-badge">${event.conflicts} conflicts</span>` : ''}
                        <span class="badge ${statusClass === 'success' ? 'bg-success' : statusClass === 'failure' ? 'bg-danger' : statusClass === 'timeout' ? 'bg-secondary' : 'bg-warning'} ms-2">
                            ${event.result || 'processing'}
                        </span>
                    </div>
                    <div class="tree-node-content">
                        ${detailsHtml}
                        ${hasChildren ? '<div class="tree-node-children"></div>' : ''}
                    </div>
                `;

                // Add children recursively
                if (hasChildren) {
                    const childrenContainer = nodeDiv.querySelector('.tree-node-children');
                    const children = childrenMap.get(event.nodeId);
                    children.forEach(child => {
                        childrenContainer.appendChild(buildNode(child));
                    });
                }

                return nodeDiv;
            }

            // Build root nodes
            const rootEvents = childrenMap.get('root') || [];
            rootEvents.forEach(event => {
                tree.appendChild(buildNode(event, true));
            });
        }

        // Toggle node collapse/expand
        function toggleNode(headerElement) {
            const content = headerElement.nextElementSibling;
            const icon = headerElement.querySelector('.expand-icon');

            if (content) {
                content.classList.toggle('collapsed');
            }
            if (icon) {
                icon.classList.toggle('collapsed');
            }
        }

        // Expand all nodes
        document.getElementById('expandAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.tree-node-content').forEach(el => {
                el.classList.remove('collapsed');
            });
            document.querySelectorAll('.expand-icon').forEach(el => {
                el.classList.remove('collapsed');
            });
        });

        // Collapse all nodes
        document.getElementById('collapseAllBtn').addEventListener('click', function() {
            document.querySelectorAll('.tree-node-content').forEach(el => {
                el.classList.add('collapsed');
            });
            document.querySelectorAll('.expand-icon').forEach(el => {
                el.classList.add('collapsed');
            });
        });

        // Export JSON
        document.getElementById('exportJsonBtn').addEventListener('click', function() {
            if (!debugData) {
                alert('No data to export');
                return;
            }

            const json = JSON.stringify(debugData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-log-${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
}
