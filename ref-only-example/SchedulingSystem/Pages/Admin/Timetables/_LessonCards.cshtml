@using SchedulingSystem.Models
@functions {
    public static string ConvertDecimalColorToHex(string? decimalColor, string defaultColor = "#e9ecef")
    {
        if (string.IsNullOrWhiteSpace(decimalColor))
            return defaultColor;

        if (decimalColor.StartsWith("#"))
            return decimalColor;

        if (!long.TryParse(decimalColor, out long colorValue))
            return defaultColor;

        int r = (int)(colorValue & 0xFF);
        int g = (int)((colorValue >> 8) & 0xFF);
        int b = (int)((colorValue >> 16) & 0xFF);

        return $"#{r:X2}{g:X2}{b:X2}";
    }

    public static string GetContrastingTextColor(string hexBgColor)
    {
        if (string.IsNullOrWhiteSpace(hexBgColor) || !hexBgColor.StartsWith("#") || hexBgColor.Length < 7)
            return "#000000";

        try
        {
            int r = Convert.ToInt32(hexBgColor.Substring(1, 2), 16);
            int g = Convert.ToInt32(hexBgColor.Substring(3, 2), 16);
            int b = Convert.ToInt32(hexBgColor.Substring(5, 2), 16);

            double luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            return luminance > 0.5 ? "#000000" : "#FFFFFF";
        }
        catch
        {
            return "#000000";
        }
    }
}
@{
    var lessons = ViewData["Lessons"] as IEnumerable<ScheduledLesson> ?? Enumerable.Empty<ScheduledLesson>();
    var hideTeacher = ViewData["HideTeacher"] as bool? ?? false;
    var hideSubject = ViewData["HideSubject"] as bool? ?? false;
    var hideClass = ViewData["HideClass"] as bool? ?? false;
    var hideRoom = ViewData["HideRoom"] as bool? ?? false;
}

@foreach (var lesson in lessons)
{
    var lessonAssignments = lesson.Lesson.LessonAssignments?.OrderBy(la => la.Order).ToList() ?? new List<LessonAssignment>();
    var scheduledRooms = lesson.ScheduledLessonRooms.ToList();

    // Check if this lesson has LessonAssignments defined
    if (lessonAssignments.Any())
    {
        // NEW: Display one card per LessonAssignment
        foreach (var assignment in lessonAssignments)
        {
            // Find which room(s) this assignment is in via ScheduledLessonRoomAssignment
            var assignedRooms = scheduledRooms
                .Where(slr => slr.RoomAssignments?.Any(ra => ra.LessonAssignmentId == assignment.Id) == true)
                .Select(slr => slr.Room?.RoomNumber ?? "?")
                .ToList();

            // If no specific room assignment, check if there's a single room for the whole lesson
            if (!assignedRooms.Any())
            {
                if (lesson.Room != null)
                {
                    assignedRooms.Add(lesson.Room.RoomNumber);
                }
                else if (scheduledRooms.Count == 1)
                {
                    assignedRooms.Add(scheduledRooms.First().Room?.RoomNumber ?? "");
                }
            }

            var roomDisplay = string.Join(", ", assignedRooms.Where(r => !string.IsNullOrEmpty(r)));

            // Get color from subject
            var subject = assignment.Subject;
            var rawBgColor = subject?.BackgroundColor ?? lesson.Lesson.BackgroundColor ?? "#e9ecef";
            var bgColor = ConvertDecimalColorToHex(rawBgColor, "#e9ecef");
            var fgColor = GetContrastingTextColor(bgColor);

            <div class="lesson-card assignment-card"
                 style="background-color: @bgColor; color: @fgColor;">
                @if (!hideSubject && subject != null)
                {
                    <span class="subject-code">@(subject.Code ?? subject.Name ?? "N/A")</span>
                }
                <div class="details">
                    @if (!hideClass && assignment.Class != null)
                    {
                        <span class="detail-class">@assignment.Class.Name</span>
                    }
                    @if (!hideTeacher && assignment.Teacher != null)
                    {
                        <span class="detail-teacher"> @assignment.Teacher.ShortName</span>
                    }
                    @if (!hideRoom && !string.IsNullOrEmpty(roomDisplay))
                    {
                        <span class="detail-room"> @roomDisplay</span>
                    }
                </div>
            </div>
        }
    }
    else
    {
        // FALLBACK: Original behavior when no LessonAssignments exist
        var subjects = lesson.Lesson.LessonSubjects.OrderByDescending(ls => ls.IsPrimary).ThenBy(ls => ls.Order).ToList();
        var teachers = lesson.Lesson.LessonTeachers.OrderByDescending(lt => lt.IsLead).ThenBy(lt => lt.Order).ToList();
        var classes = lesson.Lesson.LessonClasses.OrderByDescending(lc => lc.IsPrimary).ThenBy(lc => lc.Order).ToList();

        var primarySubject = subjects.FirstOrDefault()?.Subject;
        var secondarySubject = subjects.Skip(1).FirstOrDefault()?.Subject;

        // Get colors from subject(s) - convert decimal COLORREF to hex RGB
        var rawBgColor = primarySubject?.BackgroundColor ?? lesson.Lesson.BackgroundColor;
        var bgColor = ConvertDecimalColorToHex(rawBgColor, "#e9ecef");
        var fgColor = GetContrastingTextColor(bgColor);

        // Get all rooms with their room assignments
        var allRoomNumbers = (lesson.Room != null ? new[] { lesson.Room.RoomNumber } : Array.Empty<string>())
            .Concat(scheduledRooms.Select(slr => slr.Room?.RoomNumber ?? ""))
            .Where(r => !string.IsNullOrEmpty(r))
            .ToList();
        var roomsDisplay = allRoomNumbers.Any() ? string.Join(", ", allRoomNumbers) : "";

        // Check if there are room-specific assignments (legacy display)
        var hasRoomAssignments = scheduledRooms.Any(slr => slr.RoomAssignments?.Any() == true);

        @if (hasRoomAssignments && scheduledRooms.Count > 1)
        {
            // Room-specific assignments layout: show each room with its assigned combination
            <div class="room-assignments-card lesson-card" style="background-color: @bgColor; color: @fgColor; border: 1px solid #dee2e6;">
                @if (!hideSubject)
                {
                    <span class="subject-code">@(primarySubject?.Code ?? "N/A")</span>
                }
                <div class="room-assignments">
                    @foreach (var slr in scheduledRooms.Where(r => r.RoomAssignments?.Any() == true))
                    {
                        var roomNumber = slr.Room?.RoomNumber ?? "?";
                        var assignedItems = slr.RoomAssignments
                            .Where(ra => ra.LessonAssignment != null)
                            .Select(ra => ra.LessonAssignment!)
                            .ToList();

                        <div class="room-assignment-row">
                            <span class="room-label">@roomNumber:</span>
                            @foreach (var la in assignedItems)
                            {
                                var parts = new List<string>();
                                if (la.Teacher != null && !hideTeacher) parts.Add(la.Teacher.ShortName);
                                if (la.Subject != null && !hideSubject) parts.Add(la.Subject.Code ?? la.Subject.Name);
                                if (la.Class != null && !hideClass) parts.Add(la.Class.Name);
                                <span class="assignment-item">@string.Join("-", parts)</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
        else if (secondarySubject != null && !hideSubject)
        {
            // Multi-subject layout: split cells for each subject + teacher row below
            var rawBgColor2 = secondarySubject.BackgroundColor ?? "#e9ecef";
            var bgColor2 = ConvertDecimalColorToHex(rawBgColor2, "#e9ecef");
            var fgColor2 = GetContrastingTextColor(bgColor2);

            <div class="multi-subject-card lesson-card" style="border: 1px solid #dee2e6;">
                <div class="subject-row">
                    <div class="subject-cell" style="background-color: @bgColor; color: @fgColor;">
                        @(primarySubject?.Code ?? "N/A")
                    </div>
                    <div class="subject-cell" style="background-color: @bgColor2; color: @fgColor2;">
                        @(secondarySubject.Code ?? "N/A")
                    </div>
                </div>
                <div class="teachers-row">
                    @if (!hideClass)
                    {
                        <span class="detail-class">@string.Join("+", classes.Select(lc => lc.Class?.Name ?? ""))</span>
                    }
                    @if (!hideTeacher)
                    {
                        <span class="detail-teacher"> @string.Join("+", teachers.Select(lt => lt.Teacher?.ShortName ?? ""))</span>
                    }
                    @if (!hideRoom && allRoomNumbers.Any())
                    {
                        <span class="detail-room"> @roomsDisplay</span>
                    }
                </div>
            </div>
        }
        else
        {
            // Single-subject card with centered subject
            <div class="lesson-card"
                 style="background-color: @bgColor; color: @fgColor;">
                @if (!hideSubject)
                {
                    <span class="subject-code">@(primarySubject?.Code ?? "N/A")</span>
                }
                <div class="details">
                    @if (!hideClass)
                    {
                        <span class="detail-class">
                            @if (classes.Count > 1)
                            {
                                @string.Join("+", classes.Select(lc => lc.Class?.Name ?? ""))
                            }
                            else
                            {
                                @(classes.FirstOrDefault()?.Class?.Name ?? "")
                            }
                        </span>
                    }
                    @if (!hideTeacher)
                    {
                        <span class="detail-teacher">
                            @if (teachers.Any())
                            {
                                <text> </text>@string.Join("+", teachers.Select(lt => lt.Teacher?.ShortName ?? ""))
                            }
                        </span>
                    }
                    @if (!hideRoom && allRoomNumbers.Any())
                    {
                        <span class="detail-room"> @roomsDisplay</span>
                    }
                </div>
            </div>
        }
    }
}
