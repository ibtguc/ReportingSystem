@page
@using SchedulingSystem.Models
@model SchedulingSystem.Pages.Admin.Timetables.PrintModel
@functions {
    /// <summary>
    /// Converts a decimal COLORREF value to hex RGB color code.
    /// Colors stored as Windows COLORREF in BGR format: 0x00BBGGRR
    /// </summary>
    public static string ConvertDecimalColorToHex(string? decimalColor, string defaultColor = "#e9ecef")
    {
        if (string.IsNullOrWhiteSpace(decimalColor))
            return defaultColor;

        // If already a hex color, return as-is
        if (decimalColor.StartsWith("#"))
            return decimalColor;

        if (!long.TryParse(decimalColor, out long colorValue))
            return defaultColor;

        // Extract RGB from COLORREF (BGR format: 0x00BBGGRR)
        int r = (int)(colorValue & 0xFF);
        int g = (int)((colorValue >> 8) & 0xFF);
        int b = (int)((colorValue >> 16) & 0xFF);

        return $"#{r:X2}{g:X2}{b:X2}";
    }

    /// <summary>
    /// Determines appropriate foreground color (black or white) based on background luminance.
    /// </summary>
    public static string GetContrastingTextColor(string hexBgColor)
    {
        if (string.IsNullOrWhiteSpace(hexBgColor) || !hexBgColor.StartsWith("#") || hexBgColor.Length < 7)
            return "#000000";

        try
        {
            int r = Convert.ToInt32(hexBgColor.Substring(1, 2), 16);
            int g = Convert.ToInt32(hexBgColor.Substring(3, 2), 16);
            int b = Convert.ToInt32(hexBgColor.Substring(5, 2), 16);

            // Calculate relative luminance using sRGB formula
            double luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            return luminance > 0.5 ? "#000000" : "#FFFFFF";
        }
        catch
        {
            return "#000000";
        }
    }
}
@{
    Layout = null; // No layout for print page
    var printDate = DateTime.Now;
    var isAllMode = !string.IsNullOrEmpty(Model.PrintMode);
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Print Schedule - @Model.Timetable?.Name</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        /* Screen styles */
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
        }

        .no-print {
            margin-bottom: 20px;
        }

        .print-container {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Page break for multi-page printing */
        .page-break {
            page-break-before: always;
        }

        /* Page header */
        .print-header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
        }

        .print-header h1 {
            font-size: 18px;
            margin: 0 0 5px 0;
            font-weight: bold;
        }

        .print-header .subtitle {
            font-size: 14px;
            color: #333;
            margin: 0;
        }

        .print-header .meta {
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }

        /* Timetable Grid */
        .timetable-grid {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .timetable-grid th,
        .timetable-grid td {
            border: 1px solid #333;
            padding: 8px;
            vertical-align: top;
        }

        .timetable-grid th {
            background-color: #e9ecef;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }

        .timetable-grid .period-cell {
            width: 90px;
            background-color: #f8f9fa;
            font-weight: bold;
            font-size: 14px;
        }

        .timetable-grid .period-cell .time {
            font-size: 11px;
            color: #666;
            font-weight: normal;
        }

        .timetable-grid .day-cell {
            min-height: 50px;
        }

        /* Lesson Card */
        .lesson-card {
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 3px;
            font-size: 13px;
            line-height: 1.3;
            /* Force background colors to print */
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        .lesson-card .subject-code {
            font-weight: bold;
            font-size: 15px;
            display: block;
            text-align: center;
        }

        .lesson-card .details {
            font-size: 12px;
            text-align: center;
        }

        /* Multi-subject split layout */
        .multi-subject-card {
            margin-bottom: 4px;
            border-radius: 3px;
            overflow: hidden;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        .multi-subject-card .subject-row {
            display: flex;
        }

        .multi-subject-card .subject-cell {
            flex: 1;
            padding: 4px 6px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        .multi-subject-card .teachers-row {
            padding: 3px 6px;
            text-align: center;
            font-size: 11px;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        /* Room assignments layout (when teacher-subject-class combos are assigned to specific rooms) */
        .room-assignments-card {
            margin-bottom: 4px;
            border-radius: 3px;
            overflow: hidden;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
        }

        .room-assignments-card .subject-code {
            font-weight: bold;
            font-size: 14px;
            display: block;
            text-align: center;
            padding: 3px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .room-assignments {
            padding: 4px 6px;
            font-size: 11px;
        }

        .room-assignment-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 2px;
        }

        .room-assignment-row:last-child {
            margin-bottom: 0;
        }

        .room-assignment-row .room-label {
            font-weight: bold;
            margin-right: 4px;
            color: inherit;
        }

        .room-assignment-row .assignment-item {
            margin-right: 6px;
            padding: 1px 4px;
            background-color: rgba(255,255,255,0.3);
            border-radius: 2px;
            font-size: 10px;
        }

        /* Assignment card (one card per LessonAssignment) */
        .assignment-card {
            border: 1px solid #dee2e6;
        }

        /* Print button area */
        .print-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Scale control */
        .scale-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scale-control label {
            font-size: 11px;
            font-weight: bold;
            margin: 0;
            white-space: nowrap;
        }

        .scale-control select {
            width: auto;
            font-size: 12px;
        }

        /* Scaled print container */
        .print-container {
            transform-origin: top left;
            transition: transform 0.2s ease;
        }

        /* Print-specific styles */
        @@media print {
            /* Force all background colors to print */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-container {
                box-shadow: none;
                padding: 0;
                margin: 0;
            }

            .page-break {
                page-break-before: always;
            }

            .timetable-grid {
                page-break-inside: avoid;
            }

            .timetable-grid th,
            .timetable-grid .period-cell {
                background-color: #e9ecef !important;
            }

            .print-header {
                page-break-after: avoid;
            }

            .lesson-card {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        @@page {
            size: A4 landscape;
            margin: 10mm;
        }

        /* Filter styles */
        .filter-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .filter-panel .form-select {
            font-size: 12px;
        }

        .filter-panel .form-label {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        /* All mode info panel */
        .all-mode-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    @if (Model.Timetable == null)
    {
        <div class="alert alert-danger">Timetable not found.</div>
        return;
    }

    @if (isAllMode)
    {
        <!-- All Mode Info Panel (not printed) -->
        <div class="no-print">
            <div class="all-mode-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            @if (Model.PrintMode == "all-teachers")
                            {
                                <i class="bi bi-people"></i> <text>Print All Teachers' Schedules</text>
                            }
                            else if (Model.PrintMode == "all-subjects")
                            {
                                <i class="bi bi-book"></i> <text>Print All Subjects' Schedules</text>
                            }
                            else if (Model.PrintMode == "all-classes")
                            {
                                <i class="bi bi-mortarboard"></i> <text>Print All Classes' Schedules</text>
                            }
                        </h5>
                        <p class="mb-0 text-muted">
                            @if (Model.PrintMode == "all-teachers")
                            {
                                <text>@Model.AllTeachers.Count teachers will be printed, each on a separate page (sorted alphabetically)</text>
                            }
                            else if (Model.PrintMode == "all-subjects")
                            {
                                <text>@Model.AllSubjects.Count subjects will be printed, each on a separate page (sorted alphabetically)</text>
                            }
                            else if (Model.PrintMode == "all-classes")
                            {
                                <text>@Model.AllClasses.Count classes will be printed, each on a separate page (sorted alphabetically)</text>
                            }
                        </p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="scale-control">
                            <label for="printScaleAll"><i class="bi bi-zoom-in"></i> Scale:</label>
                            <select id="printScaleAll" class="form-select form-select-sm" onchange="updateAllScale(this.value)">
                                <option value="0.5">50%</option>
                                <option value="0.6">60%</option>
                                <option value="0.7">70%</option>
                                <option value="0.75">75%</option>
                                <option value="0.8">80%</option>
                                <option value="0.9">90%</option>
                                <option value="1" selected>100%</option>
                                <option value="1.1">110%</option>
                                <option value="1.25">125%</option>
                                <option value="1.5">150%</option>
                            </select>
                        </div>
                        <button onclick="window.print()" class="btn btn-primary">
                            <i class="bi bi-printer"></i> Print All
                        </button>
                    </div>
                </div>
            </div>
            <script>
                function updateAllScale(scale) {
                    const containers = document.querySelectorAll('.print-container');
                    containers.forEach(container => {
                        container.style.transform = `scale(${scale})`;
                        if (scale < 1) {
                            container.style.width = `${100 / scale}%`;
                        } else {
                            container.style.width = '';
                        }
                    });
                }
            </script>
        </div>

        @* Print All Teachers *@
        @if (Model.PrintMode == "all-teachers")
        {
            var isFirst = true;
            foreach (var teacher in Model.AllTeachers)
            {
                <div class="print-container @(isFirst ? "" : "page-break")">
                    @{ isFirst = false; }
                    <!-- Print Header -->
                    <div class="print-header">
                        <h1>Teacher Schedule</h1>
                        <p class="subtitle">@teacher.FullName</p>
                        <p class="meta">
                            @Model.Timetable.Name (@Model.Timetable.SchoolYear?.Name - @Model.Timetable.Term?.Name) | Printed: @printDate.ToString("dd MMM yyyy HH:mm")
                        </p>
                    </div>

                    <!-- Timetable Grid -->
                    <table class="timetable-grid">
                        <thead>
                            <tr>
                                <th class="period-cell">Period</th>
                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                {
                                    <th>@day.ToString()</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var period in Model.Periods)
                            {
                                <tr>
                                    <td class="period-cell">
                                        <div>@period.Name</div>
                                        <div class="time">@period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")</div>
                                    </td>
                                    @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                    {
                                        var lessons = Model.GetLessonsForSlotByTeacher(day, period.Id, teacher.Id);
                                        <td class="day-cell">
                                            @await Html.PartialAsync("_LessonCards", new ViewDataDictionary(ViewData) {
                                                { "Lessons", lessons },
                                                { "HideTeacher", true },
                                                { "HideSubject", false },
                                                { "HideClass", false },
                                                { "HideRoom", false }
                                            })
                                        </td>
                                    }
                                </tr>

                                @* Supervision row for this teacher (if applicable) *@
                                var nextPeriod = period.PeriodNumber + 1;
                                var teacherSupervisionPeriod = Model.GetSupervisionPeriodBefore(nextPeriod);
                                if (teacherSupervisionPeriod.HasValue && Model.BreakSupervisionDuties.Any(d => d.TeacherId == teacher.Id))
                                {
                                    <tr class="break-supervision-row">
                                        <td class="period-cell" style="background-color: #f8f9fa; color: #000; border: 1px solid #dee2e6;">
                                            <div><i class="bi bi-cup-hot"></i> @Model.GetBreakLabel(teacherSupervisionPeriod.Value)</div>
                                            <div class="time">Supervision</div>
                                        </td>
                                        @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                        {
                                            var teacherDuty = Model.GetSupervisionForTeacher(day, teacherSupervisionPeriod.Value, teacher.Id);
                                            <td class="day-cell" style="background-color: #fff; padding: 4px; text-align: center; border: 1px solid #dee2e6;">
                                                @if (teacherDuty != null)
                                                {
                                                    <span style="background-color: #fff; color: #000; padding: 2px 8px; border-radius: 3px; font-size: 11px; border: 1px solid #dee2e6;">
                                                        <i class="bi bi-geo-alt"></i> @teacherDuty.Room?.RoomNumber
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted" style="font-size: 10px;">-</span>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
        }

        @* Print All Subjects *@
        @if (Model.PrintMode == "all-subjects")
        {
            var isFirst = true;
            foreach (var subject in Model.AllSubjects)
            {
                <div class="print-container @(isFirst ? "" : "page-break")">
                    @{ isFirst = false; }
                    <!-- Print Header -->
                    <div class="print-header">
                        <h1>Subject Schedule</h1>
                        <p class="subtitle">@subject.Name (@subject.Code)</p>
                        <p class="meta">
                            @Model.Timetable.Name (@Model.Timetable.SchoolYear?.Name - @Model.Timetable.Term?.Name) | Printed: @printDate.ToString("dd MMM yyyy HH:mm")
                        </p>
                    </div>

                    <!-- Timetable Grid -->
                    <table class="timetable-grid">
                        <thead>
                            <tr>
                                <th class="period-cell">Period</th>
                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                {
                                    <th>@day.ToString()</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var period in Model.Periods)
                            {
                                <tr>
                                    <td class="period-cell">
                                        <div>@period.Name</div>
                                        <div class="time">@period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")</div>
                                    </td>
                                    @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                    {
                                        var lessons = Model.GetLessonsForSlotBySubject(day, period.Id, subject.Id);
                                        <td class="day-cell">
                                            @await Html.PartialAsync("_LessonCards", new ViewDataDictionary(ViewData) {
                                                { "Lessons", lessons },
                                                { "HideTeacher", false },
                                                { "HideSubject", true },
                                                { "HideClass", false },
                                                { "HideRoom", false }
                                            })
                                        </td>
                                    }
                                </tr>

                                @* Supervision row (if applicable) *@
                                var subjectNextPeriod = period.PeriodNumber + 1;
                                var subjectSupervisionPeriod = Model.GetSupervisionPeriodBefore(subjectNextPeriod);
                                if (subjectSupervisionPeriod.HasValue && Model.BreakSupervisionDuties.Any())
                                {
                                    <tr class="break-supervision-row">
                                        <td class="period-cell" style="background-color: #f8f9fa; color: #000; border: 1px solid #dee2e6;">
                                            <div><i class="bi bi-cup-hot"></i> @Model.GetBreakLabel(subjectSupervisionPeriod.Value)</div>
                                            <div class="time">Supervision</div>
                                        </td>
                                        @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                        {
                                            var supervisions = Model.GetSupervisionForSlot(day, subjectSupervisionPeriod.Value);
                                            <td class="day-cell" style="background-color: #fff; padding: 2px; border: 1px solid #dee2e6;">
                                                @if (supervisions.Any())
                                                {
                                                    <div style="display: flex; flex-wrap: wrap; gap: 2px; font-size: 10px;">
                                                        @foreach (var duty in supervisions)
                                                        {
                                                            <span style="background-color: @(duty.TeacherId.HasValue ? "#fff" : "#6c757d"); color: @(duty.TeacherId.HasValue ? "#000" : "#fff"); padding: 1px 4px; border-radius: 2px; white-space: nowrap; border: 1px solid #dee2e6;">
                                                                @duty.Room?.RoomNumber: @(duty.Teacher?.FirstName ?? "-")
                                                            </span>
                                                        }
                                                    </div>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
        }

        @* Print All Classes *@
        @if (Model.PrintMode == "all-classes")
        {
            var isFirst = true;
            foreach (var cls in Model.AllClasses)
            {
                <div class="print-container @(isFirst ? "" : "page-break")">
                    @{ isFirst = false; }
                    <!-- Print Header -->
                    <div class="print-header">
                        <h1>Class Schedule</h1>
                        <p class="subtitle">@cls.Name</p>
                        <p class="meta">
                            @Model.Timetable.Name (@Model.Timetable.SchoolYear?.Name - @Model.Timetable.Term?.Name) | Printed: @printDate.ToString("dd MMM yyyy HH:mm")
                        </p>
                    </div>

                    <!-- Timetable Grid -->
                    <table class="timetable-grid">
                        <thead>
                            <tr>
                                <th class="period-cell">Period</th>
                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                {
                                    <th>@day.ToString()</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var period in Model.Periods)
                            {
                                <tr>
                                    <td class="period-cell">
                                        <div>@period.Name</div>
                                        <div class="time">@period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")</div>
                                    </td>
                                    @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                    {
                                        var lessons = Model.GetLessonsForSlotByClass(day, period.Id, cls.Id);
                                        <td class="day-cell">
                                            @await Html.PartialAsync("_LessonCards", new ViewDataDictionary(ViewData) {
                                                { "Lessons", lessons },
                                                { "HideTeacher", false },
                                                { "HideSubject", false },
                                                { "HideClass", true },
                                                { "HideRoom", false }
                                            })
                                        </td>
                                    }
                                </tr>

                                @* Supervision row (if applicable) *@
                                var classNextPeriod = period.PeriodNumber + 1;
                                var classSupervisionPeriod = Model.GetSupervisionPeriodBefore(classNextPeriod);
                                if (classSupervisionPeriod.HasValue && Model.BreakSupervisionDuties.Any())
                                {
                                    <tr class="break-supervision-row">
                                        <td class="period-cell" style="background-color: #f8f9fa; color: #000; border: 1px solid #dee2e6;">
                                            <div><i class="bi bi-cup-hot"></i> @Model.GetBreakLabel(classSupervisionPeriod.Value)</div>
                                            <div class="time">Supervision</div>
                                        </td>
                                        @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                        {
                                            var supervisions = Model.GetSupervisionForSlot(day, classSupervisionPeriod.Value);
                                            <td class="day-cell" style="background-color: #fff; padding: 2px; border: 1px solid #dee2e6;">
                                                @if (supervisions.Any())
                                                {
                                                    <div style="display: flex; flex-wrap: wrap; gap: 2px; font-size: 10px;">
                                                        @foreach (var duty in supervisions)
                                                        {
                                                            <span style="background-color: @(duty.TeacherId.HasValue ? "#fff" : "#6c757d"); color: @(duty.TeacherId.HasValue ? "#000" : "#fff"); padding: 1px 4px; border-radius: 2px; white-space: nowrap; border: 1px solid #dee2e6;">
                                                                @duty.Room?.RoomNumber: @(duty.Teacher?.FirstName ?? "-")
                                                            </span>
                                                        }
                                                    </div>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
        }
    }
    else
    {
        <!-- Filter Panel and Print Controls (not printed) - Single schedule mode -->
        <div class="no-print">
            <div class="filter-panel">
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <h5><i class="bi bi-funnel"></i> Filter Schedule</h5>
                        <small class="text-muted">Select a filter to customize the printed schedule. The selected filter will appear in the page header.</small>
                    </div>
                    <div class="col-md-3">
                        <label for="filterTeacher" class="form-label">Teacher</label>
                        <select id="filterTeacher" class="form-select form-select-sm">
                            <option value="">-- All Teachers --</option>
                            @foreach (var teacher in Model.FilterTeachers)
                            {
                                <option value="@teacher.FullName" data-id="@teacher.Id">@teacher.FullName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterSubject" class="form-label">Subject</label>
                        <select id="filterSubject" class="form-select form-select-sm">
                            <option value="">-- All Subjects --</option>
                            @foreach (var subject in Model.FilterSubjects)
                            {
                                <option value="@subject.Name" data-id="@subject.Id">@subject.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterClass" class="form-label">Class</label>
                        <select id="filterClass" class="form-select form-select-sm">
                            <option value="">-- All Classes --</option>
                            @foreach (var cls in Model.FilterClasses)
                            {
                                <option value="@cls.Name" data-id="@cls.Id">@cls.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterRoom" class="form-label">Room</label>
                        <select id="filterRoom" class="form-select form-select-sm">
                            <option value="">-- All Rooms --</option>
                            @foreach (var room in Model.FilterRooms)
                            {
                                <option value="@room.RoomNumber" data-id="@room.Id">@room.RoomNumber</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-12">
                        <div class="print-controls">
                            <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </button>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showTimetableName" checked>
                                <label class="form-check-label" for="showTimetableName">
                                    Show timetable name in header
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showBreakSupervision" checked>
                                <label class="form-check-label" for="showBreakSupervision">
                                    Show break supervision
                                </label>
                            </div>
                            <div class="scale-control">
                                <label for="printScale"><i class="bi bi-zoom-in"></i> Print Scale:</label>
                                <select id="printScale" class="form-select form-select-sm">
                                    <option value="0.5">50%</option>
                                    <option value="0.6">60%</option>
                                    <option value="0.7">70%</option>
                                    <option value="0.75">75%</option>
                                    <option value="0.8">80%</option>
                                    <option value="0.9">90%</option>
                                    <option value="1" selected>100%</option>
                                    <option value="1.1">110%</option>
                                    <option value="1.25">125%</option>
                                    <option value="1.5">150%</option>
                                </select>
                            </div>
                            <span id="matchCount" class="text-muted"></span>
                            <button id="printBtn" class="btn btn-primary ms-auto">
                                <i class="bi bi-printer"></i> Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Printable Content - Single schedule -->
        <div class="print-container">
            <!-- Print Header -->
            <div class="print-header">
                <h1 id="printTitle">Schedule</h1>
                <p class="subtitle" id="printSubtitle"></p>
                <p class="meta">
                    <span id="timetableNameSpan">@Model.Timetable.Name (@Model.Timetable.SchoolYear?.Name - @Model.Timetable.Term?.Name)</span>
                    <span id="metaSeparator"> | </span>
                    Printed: @printDate.ToString("dd MMM yyyy HH:mm")
                </p>
            </div>

            <!-- Timetable Grid -->
            <table class="timetable-grid">
                <thead>
                    <tr>
                        <th class="period-cell">Period</th>
                        @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                        {
                            <th>@day.ToString()</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var period in Model.Periods)
                    {
                        <tr>
                            <td class="period-cell">
                                <div>@period.Name</div>
                                <div class="time">@period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")</div>
                            </td>
                            @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                            {
                                var lessons = Model.GetLessonsForSlot(day, period.Id);
                                <td class="day-cell">
                                    @foreach (var lesson in lessons)
                                    {
                                        var subjects = lesson.Lesson.LessonSubjects.OrderByDescending(ls => ls.IsPrimary).ThenBy(ls => ls.Order).ToList();
                                        var teachers = lesson.Lesson.LessonTeachers.OrderByDescending(lt => lt.IsLead).ThenBy(lt => lt.Order).ToList();
                                        var classes = lesson.Lesson.LessonClasses.OrderByDescending(lc => lc.IsPrimary).ThenBy(lc => lc.Order).ToList();
                                        var lessonAssignments = lesson.Lesson.LessonAssignments?.OrderBy(la => la.Order).ToList() ?? new List<LessonAssignment>();
                                        var scheduledRooms = lesson.ScheduledLessonRooms.ToList();

                                        // Build data attributes for filtering (used by all cards for this lesson)
                                        var teacherNames = string.Join("|", teachers.Select(lt => lt.Teacher?.FullName ?? ""));
                                        var classNames = string.Join("|", classes.Select(lc => lc.Class?.Name ?? ""));
                                        var subjectNames = string.Join("|", subjects.Select(ls => ls.Subject?.Name ?? ""));
                                        var allRoomNumbers = (lesson.Room != null ? new[] { lesson.Room.RoomNumber } : Array.Empty<string>())
                                            .Concat(scheduledRooms.Select(slr => slr.Room?.RoomNumber ?? ""))
                                            .Where(r => !string.IsNullOrEmpty(r))
                                            .ToList();
                                        var roomsDisplay = allRoomNumbers.Any() ? string.Join(", ", allRoomNumbers) : "";
                                        var roomsForFilter = string.Join("|", allRoomNumbers);

                                        // Check if this lesson has LessonAssignments defined
                                        if (lessonAssignments.Any())
                                        {
                                            // Display one card per LessonAssignment
                                            foreach (var assignment in lessonAssignments)
                                            {
                                                // Find which room(s) this assignment is in via ScheduledLessonRoomAssignment
                                                var assignedRooms = scheduledRooms
                                                    .Where(slr => slr.RoomAssignments?.Any(ra => ra.LessonAssignmentId == assignment.Id) == true)
                                                    .Select(slr => slr.Room?.RoomNumber ?? "?")
                                                    .ToList();

                                                // If no specific room assignment, check if there's a single room for the whole lesson
                                                if (!assignedRooms.Any())
                                                {
                                                    if (lesson.Room != null)
                                                    {
                                                        assignedRooms.Add(lesson.Room.RoomNumber);
                                                    }
                                                    else if (scheduledRooms.Count == 1)
                                                    {
                                                        assignedRooms.Add(scheduledRooms.First().Room?.RoomNumber ?? "");
                                                    }
                                                }

                                                var assignmentRoomDisplay = string.Join(", ", assignedRooms.Where(r => !string.IsNullOrEmpty(r)));

                                                // Get color from subject
                                                var subject = assignment.Subject;
                                                var rawBgColor = subject?.BackgroundColor ?? lesson.Lesson.BackgroundColor ?? "#e9ecef";
                                                var bgColor = ConvertDecimalColorToHex(rawBgColor, "#e9ecef");
                                                var fgColor = GetContrastingTextColor(bgColor);

                                                <div class="lesson-card assignment-card"
                                                     data-subject="@(assignment.Subject?.Name ?? "")"
                                                     data-class="@(assignment.Class?.Name ?? "")"
                                                     data-teacher="@(assignment.Teacher?.FullName ?? "")"
                                                     data-room="@assignmentRoomDisplay"
                                                     data-rooms="@string.Join("|", assignedRooms)"
                                                     style="background-color: @bgColor; color: @fgColor;">
                                                    @if (subject != null)
                                                    {
                                                        <span class="subject-code">@(subject.Code ?? subject.Name ?? "N/A")</span>
                                                    }
                                                    <div class="details">
                                                        @if (assignment.Class != null)
                                                        {
                                                            <span class="detail-class">@assignment.Class.Name</span>
                                                        }
                                                        @if (assignment.Teacher != null)
                                                        {
                                                            <span class="detail-teacher"> @assignment.Teacher.ShortName</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(assignmentRoomDisplay))
                                                        {
                                                            <span class="detail-room"> @assignmentRoomDisplay</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            // FALLBACK: Original behavior when no LessonAssignments exist
                                            var primarySubject = subjects.FirstOrDefault()?.Subject;
                                            var secondarySubject = subjects.Skip(1).FirstOrDefault()?.Subject;

                                            // Get colors from subject(s) - convert decimal COLORREF to hex RGB
                                            var rawBgColor = primarySubject?.BackgroundColor ?? lesson.Lesson.BackgroundColor;
                                            var bgColor = ConvertDecimalColorToHex(rawBgColor, "#e9ecef");
                                            var fgColor = GetContrastingTextColor(bgColor);

                                            @if (secondarySubject != null)
                                            {
                                                // Multi-subject layout: split cells for each subject + teacher row below
                                                var rawBgColor2 = secondarySubject.BackgroundColor ?? "#e9ecef";
                                                var bgColor2 = ConvertDecimalColorToHex(rawBgColor2, "#e9ecef");
                                                var fgColor2 = GetContrastingTextColor(bgColor2);

                                                <div class="multi-subject-card lesson-card"
                                                     data-subject="@subjectNames"
                                                     data-class="@classNames"
                                                     data-teacher="@teacherNames"
                                                     data-room="@roomsDisplay"
                                                     data-rooms="@roomsForFilter"
                                                     style="border: 1px solid #dee2e6;">
                                                    <div class="subject-row">
                                                        <div class="subject-cell" style="background-color: @bgColor; color: @fgColor;">
                                                            @(primarySubject?.Code ?? "N/A")
                                                        </div>
                                                        <div class="subject-cell" style="background-color: @bgColor2; color: @fgColor2;">
                                                            @(secondarySubject.Code ?? "N/A")
                                                        </div>
                                                    </div>
                                                    <div class="teachers-row">
                                                        <span class="detail-class">@string.Join("+", classes.Select(lc => lc.Class?.Name ?? ""))</span>
                                                        <span class="detail-teacher"> @string.Join("+", teachers.Select(lt => lt.Teacher?.ShortName ?? ""))</span>
                                                        @if (allRoomNumbers.Any())
                                                        {
                                                            <span class="detail-room"> @roomsDisplay</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                            else
                                            {
                                                // Single-subject card with centered subject
                                                <div class="lesson-card"
                                                     data-subject="@subjectNames"
                                                     data-class="@classNames"
                                                     data-teacher="@teacherNames"
                                                     data-room="@roomsDisplay"
                                                     data-rooms="@roomsForFilter"
                                                     style="background-color: @bgColor; color: @fgColor;">
                                                    <span class="subject-code">@(primarySubject?.Code ?? "N/A")</span>
                                                    <div class="details">
                                                        <span class="detail-class">
                                                            @if (classes.Count > 1)
                                                            {
                                                                @string.Join("+", classes.Select(lc => lc.Class?.Name ?? ""))
                                                            }
                                                            else
                                                            {
                                                                @(classes.FirstOrDefault()?.Class?.Name ?? "")
                                                            }
                                                        </span>
                                                        <span class="detail-teacher">
                                                            @if (teachers.Any())
                                                            {
                                                                <text> </text>@string.Join("+", teachers.Select(lt => lt.Teacher?.ShortName ?? ""))
                                                            }
                                                        </span>
                                                        @if (allRoomNumbers.Any())
                                                        {
                                                            <span class="detail-room"> @roomsDisplay</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                    }
                                </td>
                            }
                        </tr>

                        @* Supervision row (if applicable) *@
                        var printNextPeriod = period.PeriodNumber + 1;
                        var printSupervisionPeriod = Model.GetSupervisionPeriodBefore(printNextPeriod);
                        if (printSupervisionPeriod.HasValue && Model.BreakSupervisionDuties.Any())
                        {
                            <tr class="break-supervision-row">
                                <td class="period-cell" style="background-color: #f8f9fa; color: #000; border: 1px solid #dee2e6;">
                                    <div><i class="bi bi-cup-hot"></i> @Model.GetBreakLabel(printSupervisionPeriod.Value)</div>
                                    <div class="time">Supervision</div>
                                </td>
                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                {
                                    var supervisions = Model.GetSupervisionForSlot(day, printSupervisionPeriod.Value);
                                    <td class="day-cell" style="background-color: #fff; padding: 2px; border: 1px solid #dee2e6;">
                                        @if (supervisions.Any())
                                        {
                                            <div style="display: flex; flex-wrap: wrap; gap: 2px; font-size: 10px;">
                                                @foreach (var duty in supervisions)
                                                {
                                                    <span class="supervision-badge" data-teacher="@(duty.Teacher?.FullName ?? "")" style="background-color: @(duty.TeacherId.HasValue ? "#fff" : "#6c757d"); color: @(duty.TeacherId.HasValue ? "#000" : "#fff"); padding: 1px 4px; border-radius: 2px; white-space: nowrap; border: 1px solid #dee2e6;">
                                                        @duty.Room?.RoomNumber: @(duty.Teacher?.FirstName ?? "-")
                                                    </span>
                                                }
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const filterTeacher = document.getElementById('filterTeacher');
                const filterSubject = document.getElementById('filterSubject');
                const filterClass = document.getElementById('filterClass');
                const filterRoom = document.getElementById('filterRoom');
                const clearFiltersBtn = document.getElementById('clearFilters');
                const printBtn = document.getElementById('printBtn');
                const showTimetableNameCheckbox = document.getElementById('showTimetableName');
                const showBreakSupervisionCheckbox = document.getElementById('showBreakSupervision');
                const timetableNameSpan = document.getElementById('timetableNameSpan');
                const metaSeparator = document.getElementById('metaSeparator');
                const printTitle = document.getElementById('printTitle');
                const printSubtitle = document.getElementById('printSubtitle');
                const matchCountSpan = document.getElementById('matchCount');
                const printScaleSelect = document.getElementById('printScale');
                const printContainer = document.querySelector('.print-container');
                const breakSupervisionRows = document.querySelectorAll('.break-supervision-row');

                // All lesson cards
                const lessonCards = document.querySelectorAll('.lesson-card');

                function updateFilters() {
                    const teacherVal = filterTeacher.value;
                    const subjectVal = filterSubject.value;
                    const classVal = filterClass.value;
                    const roomVal = filterRoom.value;

                    let matchCount = 0;
                    let totalCount = lessonCards.length;

                    lessonCards.forEach(card => {
                        const cardTeachers = (card.dataset.teacher || '').split('|');
                        const cardSubjects = (card.dataset.subject || '').split('|');
                        const cardClasses = (card.dataset.class || '').split('|');
                        const cardRooms = (card.dataset.rooms || '').split('|');

                        let matches = true;

                        if (teacherVal && !cardTeachers.includes(teacherVal)) {
                            matches = false;
                        }
                        if (subjectVal && !cardSubjects.includes(subjectVal)) {
                            matches = false;
                        }
                        if (classVal && !cardClasses.includes(classVal)) {
                            matches = false;
                        }
                        if (roomVal && !cardRooms.includes(roomVal)) {
                            matches = false;
                        }

                        if (matches) {
                            card.style.display = '';
                            matchCount++;
                        } else {
                            card.style.display = 'none';
                        }

                        // Hide/show details based on filter
                        const detailClass = card.querySelector('.detail-class');
                        const detailTeacher = card.querySelector('.detail-teacher');
                        const detailRoom = card.querySelector('.detail-room');

                        if (detailClass) {
                            detailClass.style.display = classVal ? 'none' : '';
                        }
                        if (detailTeacher) {
                            detailTeacher.style.display = teacherVal ? 'none' : '';
                        }
                        if (detailRoom) {
                            detailRoom.style.display = roomVal ? 'none' : '';
                        }
                    });

                    // Update title based on filter
                    let titleParts = [];
                    let subtitleParts = [];

                    if (teacherVal) {
                        titleParts.push('Teacher Schedule');
                        subtitleParts.push(teacherVal);
                    }
                    if (subjectVal) {
                        titleParts.push('Subject Schedule');
                        subtitleParts.push(subjectVal);
                    }
                    if (classVal) {
                        titleParts.push('Class Schedule');
                        subtitleParts.push(classVal);
                    }
                    if (roomVal) {
                        titleParts.push('Room Schedule');
                        subtitleParts.push('Room ' + roomVal);
                    }

                    if (titleParts.length > 0) {
                        printTitle.textContent = titleParts.join(' / ');
                        printSubtitle.textContent = subtitleParts.join(' | ');
                        printSubtitle.style.display = '';
                    } else {
                        printTitle.textContent = 'Full Schedule';
                        printSubtitle.textContent = '';
                        printSubtitle.style.display = 'none';
                    }

                    // Update match count
                    if (teacherVal || subjectVal || classVal || roomVal) {
                        matchCountSpan.textContent = `Showing ${matchCount} of ${totalCount} lessons`;
                    } else {
                        matchCountSpan.textContent = `${totalCount} lessons total`;
                    }

                    // Highlight supervision badges when teacher filter is selected
                    const supervisionBadges = document.querySelectorAll('.supervision-badge');
                    supervisionBadges.forEach(badge => {
                        const badgeTeacher = badge.dataset.teacher || '';
                        if (teacherVal && badgeTeacher === teacherVal) {
                            // Highlight matching teacher's supervision duties with bright color
                            badge.style.backgroundColor = '#28a745';
                            badge.style.color = '#fff';
                            badge.style.fontWeight = 'bold';
                            badge.style.border = '2px solid #1e7e34';
                        } else if (!badgeTeacher) {
                            // Keep unassigned in gray
                            badge.style.backgroundColor = '#6c757d';
                            badge.style.color = '#fff';
                            badge.style.fontWeight = '';
                            badge.style.border = '1px solid #dee2e6';
                        } else {
                            // Reset to white for assigned but non-matching
                            badge.style.backgroundColor = '#fff';
                            badge.style.color = '#000';
                            badge.style.fontWeight = '';
                            badge.style.border = '1px solid #dee2e6';
                        }
                    });
                }

                function updateTimetableNameVisibility() {
                    const show = showTimetableNameCheckbox.checked;
                    timetableNameSpan.style.display = show ? '' : 'none';
                    metaSeparator.style.display = show ? '' : 'none';
                }

                function updateBreakSupervisionVisibility() {
                    const show = showBreakSupervisionCheckbox.checked;
                    breakSupervisionRows.forEach(row => {
                        row.style.display = show ? '' : 'none';
                    });
                }

                function updateScale() {
                    const scale = parseFloat(printScaleSelect.value);
                    printContainer.style.transform = `scale(${scale})`;
                    // Adjust container width to prevent clipping when scaled down
                    if (scale < 1) {
                        printContainer.style.width = `${100 / scale}%`;
                    } else {
                        printContainer.style.width = '';
                    }
                }

                // Event listeners
                filterTeacher.addEventListener('change', updateFilters);
                filterSubject.addEventListener('change', updateFilters);
                filterClass.addEventListener('change', updateFilters);
                filterRoom.addEventListener('change', updateFilters);

                clearFiltersBtn.addEventListener('click', function() {
                    filterTeacher.value = '';
                    filterSubject.value = '';
                    filterClass.value = '';
                    filterRoom.value = '';
                    updateFilters();
                });

                showTimetableNameCheckbox.addEventListener('change', updateTimetableNameVisibility);
                showBreakSupervisionCheckbox.addEventListener('change', updateBreakSupervisionVisibility);

                printScaleSelect.addEventListener('change', updateScale);

                printBtn.addEventListener('click', function() {
                    window.print();
                });

                // Initial update
                updateFilters();
                updateTimetableNameVisibility();
                updateBreakSupervisionVisibility();
                updateScale();
            });
        </script>
    }
</body>
</html>
