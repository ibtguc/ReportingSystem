@page
@using SchedulingSystem.Models
@model SchedulingSystem.Pages.Admin.Timetables.MoveLessonsModel
@{
    ViewData["Title"] = Model.Timetable != null ? $"Move Lessons - {Model.Timetable.Name}" : "Move Lessons";
}

<div class="container-fluid py-4" data-timetable-id="@(Model.Timetable?.Id ?? 0)">
    <!-- Header with Timetable Selector -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h2 class="mb-3">
                <i class="bi bi-arrows-move"></i> Move Lessons
            </h2>

            <form method="post" id="timetableSelectionForm">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label for="SelectedTimetableId" class="form-label">
                            <strong>Select Timetable:</strong>
                        </label>
                        <select asp-for="SelectedTimetableId"
                                asp-items="Model.TimetableList"
                                class="form-select"
                                onchange="document.getElementById('timetableSelectionForm').submit()">
                            <option value="">-- Select a Timetable --</option>
                        </select>
                    </div>
                    @if (Model.Timetable != null)
                    {
                        <div class="col-md-4">
                            <span class="badge bg-@(Model.Timetable.Status == TimetableStatus.Published ? "success" : Model.Timetable.Status == TimetableStatus.Draft ? "warning" : "secondary") fs-6">
                                @Model.Timetable.Status
                            </span>
                            <a href="/Admin/Timetables/Validate?id=@Model.Timetable.Id" class="btn btn-outline-warning ms-2">
                                <i class="bi bi-shield-check"></i> Validate
                            </a>
                            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="showDeleteAllOptionsModal(@Model.Timetable.Id)">
                                <i class="bi bi-trash"></i> Delete All Options
                            </button>
                        </div>
                    }
                </div>
            </form>
        </div>
    </div>

    @if (Model.Timetable == null)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Please select a timetable to view and move lessons.
        </div>
        return;
    }

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> @Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Accordion Structure for Multi-Section Workflow -->
    <div class="accordion" id="moveLessonsAccordion">

        <!-- Section 1: Select Source -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingSelectSource">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSelectSource" aria-expanded="true" aria-controls="collapseSelectSource">
                    <i class="bi bi-1-circle-fill me-2"></i>
                    <strong>Select Source</strong>
                    <span class="ms-2 text-muted" id="selectedLessonsCount">(0 lessons selected)</span>
                </button>
            </h2>
            <div id="collapseSelectSource" class="accordion-collapse collapse show" aria-labelledby="headingSelectSource">
                <div class="accordion-body">

                    <!-- Advanced Highlighting Filter -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-funnel"></i> <strong>Highlight Lessons</strong>
                            <small class="ms-2">Select criteria to highlight matching lessons in the timetable</small>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label for="filterTeacher" class="form-label">Teacher</label>
                                    <select id="filterTeacher" class="form-select form-select-sm">
                                        <option value="">-- All Teachers --</option>
                                        @foreach (var teacher in Model.ScheduledLessons.SelectMany(sl => sl.Lesson.LessonTeachers.Select(lt => lt.Teacher)).Distinct().OrderBy(t => t.FullName))
                                        {
                                            <option value="@teacher.FullName">@teacher.FullName</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filterSubject" class="form-label">Subject</label>
                                    <select id="filterSubject" class="form-select form-select-sm">
                                        <option value="">-- All Subjects --</option>
                                        @foreach (var subject in Model.ScheduledLessons.SelectMany(sl => sl.Lesson.LessonSubjects.Select(ls => ls.Subject)).Distinct().OrderBy(s => s.Name))
                                        {
                                            <option value="@subject.Name">@subject.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filterClass" class="form-label">Class</label>
                                    <select id="filterClass" class="form-select form-select-sm">
                                        <option value="">-- All Classes --</option>
                                        @foreach (var cls in Model.ScheduledLessons.SelectMany(sl => sl.Lesson.LessonClasses.Select(lc => lc.Class)).Distinct().OrderBy(c => c.Name))
                                        {
                                            <option value="@cls.Name">@cls.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filterRoom" class="form-label">Room</label>
                                    <select id="filterRoom" class="form-select form-select-sm">
                                        <option value="">-- All Rooms --</option>
                                        @foreach (var room in Model.ScheduledLessons.Where(sl => sl.Room != null).Select(sl => sl.Room).Distinct().OrderBy(r => r.RoomNumber))
                                        {
                                            <option value="@room.RoomNumber">@room.RoomNumber</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12 d-flex align-items-center">
                                    <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-x-circle"></i> Clear All Filters
                                    </button>
                                    <span id="matchCount" class="ms-3 text-muted"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legend for Visual Indicators -->
                    <div class="alert alert-info mb-3">
                        <strong><i class="bi bi-info-circle"></i> Legend:</strong>
                        <span class="badge badge-coteaching ms-2"><i class="bi bi-people-fill"></i> Co-Teaching</span>
                        <span class="badge badge-multisubject ms-2"><i class="bi bi-book-half"></i> Multiple Subjects</span>
                        <span class="badge badge-multiroom ms-2"><i class="bi bi-door-open-fill"></i> Multiple Rooms</span>
                        <span class="badge badge-multiclass ms-2"><i class="bi bi-people"></i> Combined Classes</span>
                        <small class="ms-3 text-muted">
                            • Lead teacher shown in <strong>bold</strong>
                            • Co-teaching lessons have thicker left border
                        </small>
                    </div>

                    <!-- Timetable Grid -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <span><strong>Timetable Grid</strong></span>
                            <div class="d-flex gap-4 align-items-center">
                                <!-- Display Mode Toggle -->
                                <div class="btn-group btn-group-sm" role="group" aria-label="Display mode">
                                    <input type="radio" class="btn-check" name="displayMode" id="displayModeDetailed" value="detailed" autocomplete="off">
                                    <label class="btn btn-outline-primary" for="displayModeDetailed">
                                        <i class="bi bi-card-text"></i> Detailed
                                    </label>

                                    <input type="radio" class="btn-check" name="displayMode" id="displayModeCompact" value="compact" checked autocomplete="off">
                                    <label class="btn btn-outline-primary" for="displayModeCompact">
                                        <i class="bi bi-dash-square"></i> Compact
                                    </label>
                                </div>

                                <!-- Sort Dropdown -->
                                <div>
                                    <label class="me-2">Sort lessons by:</label>
                                    <select id="sortLessons" class="form-select form-select-sm d-inline-block w-auto">
                                        <option value="none">Default</option>
                                        <option value="subject">Subject</option>
                                        <option value="class">Class</option>
                                        <option value="teacher">Teacher</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0" id="sourceTimetable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 150px;">Time / Day</th>
                                            @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                            {
                                                <th class="text-center">@day.ToString()</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var period in Model.Periods)
                                        {
                                            <tr>
                                                <td class="fw-bold bg-light">
                                                    <div>@period.Name</div>
                                                    <small class="text-muted">
                                                        @period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")
                                                    </small>
                                                </td>
                                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                                {
                                                    var lessons = Model.GetLessonsForSlot(day, period.Id);

                                                    <td style="min-height: 100px; vertical-align: top; padding: 8px;">
                                                        @if (lessons.Any())
                                                        {
                                                            @foreach (var lesson in lessons)
                                            {
                                                // Get co-teaching data
                                                var subjects = lesson.Lesson.LessonSubjects.OrderByDescending(ls => ls.IsPrimary).ThenBy(ls => ls.Order).ToList();
                                                var teachers = lesson.Lesson.LessonTeachers.OrderByDescending(lt => lt.IsLead).ThenBy(lt => lt.Order).ToList();
                                                var classes = lesson.Lesson.LessonClasses.OrderByDescending(lc => lc.IsPrimary).ThenBy(lc => lc.Order).ToList();

                                                var primarySubject = subjects.FirstOrDefault()?.Subject;
                                                var primaryTeacher = teachers.FirstOrDefault()?.Teacher;
                                                var primaryClass = classes.FirstOrDefault()?.Class;

                                                var bgColor = primarySubject?.BackgroundColor ?? lesson.Lesson.BackgroundColor ?? "#e9ecef";
                                                var fgColor = primarySubject?.ForegroundColor ?? lesson.Lesson.ForegroundColor ?? "#000";

                                                // Get all rooms (legacy + multi-room) for filtering and display
                                                var allRoomNumbers = (lesson.Room != null ? new[] { lesson.Room.RoomNumber } : Array.Empty<string>())
                                                    .Concat(lesson.ScheduledLessonRooms.Select(slr => slr.Room?.RoomNumber ?? ""))
                                                    .Where(r => !string.IsNullOrEmpty(r))
                                                    .ToList();
                                                var roomsDisplay = allRoomNumbers.Any() ? string.Join(", ", allRoomNumbers) : "No room";
                                                var roomsForFilter = string.Join("|", allRoomNumbers);

                                                // Get room IDs with names
                                                var allRoomDetails = (lesson.Room != null ? new[] { $"{lesson.Room.RoomNumber} (ID: {lesson.Room.Id})" } : Array.Empty<string>())
                                                    .Concat(lesson.ScheduledLessonRooms.Select(slr => slr.Room != null ? $"{slr.Room.RoomNumber} (ID: {slr.Room.Id})" : ""))
                                                    .Where(r => !string.IsNullOrEmpty(r))
                                                    .ToList();
                                                var roomsWithIds = allRoomDetails.Any() ? string.Join(", ", allRoomDetails) : "No room assigned";

                                                // Check for special lesson types
                                                var isCoTeaching = teachers.Count > 1;
                                                var isMultiSubject = subjects.Count > 1;
                                                var isMultiRoom = allRoomNumbers.Distinct().Count() > 1;
                                                var isMultiClass = classes.Count > 1;
                                                var hasAssignments = lesson.Lesson.LessonAssignments?.Any() == true;

                                                var cardClasses = "lesson-card mb-2 position-relative";
                                                if (lesson.IsLocked) cardClasses += " locked-lesson";
                                                if (isCoTeaching) cardClasses += " co-teaching-lesson";
                                                if (isMultiSubject) cardClasses += " multi-subject-lesson";

                                                var borderWidth = isCoTeaching ? "6px" : "4px";

                                                // Build teacher names for filter (all teachers)
                                                var teacherNames = string.Join("|", teachers.Select(lt => lt.Teacher?.FullName ?? ""));
                                                // Build class names for filter (all classes)
                                                var classNames = string.Join("|", classes.Select(lc => lc.Class?.Name ?? ""));
                                                // Build subject names for filter (all subjects)
                                                var subjectNames = string.Join("|", subjects.Select(ls => ls.Subject?.Name ?? ""));

                                                // Prepare detailed info for tooltip and detailed view
                                                var teachersWithIds = string.Join(", ", teachers.Select(lt => $"{(lt.IsLead ? "★ " : "")}{lt.Teacher?.FullName ?? "N/A"} (ID: {lt.TeacherId})"));
                                                var classesWithIds = string.Join(", ", classes.Select(lc => $"{lc.Class?.Name ?? "N/A"} (ID: {lc.ClassId})"));
                                                var subjectsWithIds = string.Join(", ", subjects.Select(ls => $"{ls.Subject?.Name ?? "N/A"} (ID: {ls.SubjectId})"));

                                                // Clean ID lists for availability checking (comma-separated numeric IDs)
                                                var teacherIdList = string.Join(",", teachers.Select(lt => lt.TeacherId));
                                                var classIdList = string.Join(",", classes.Select(lc => lc.ClassId));
                                                var subjectIdList = string.Join(",", subjects.Select(ls => ls.SubjectId));
                                                var roomIdList = string.Join(",",
                                                    (lesson.Room != null ? new[] { lesson.Room.Id } : Array.Empty<int>())
                                                    .Concat(lesson.ScheduledLessonRooms.Select(slr => slr.RoomId)));
                                                var dayNum = (int)day;

                                                // Compact view: First 3 letters of teacher names
                                                var teacherShortNames = string.Join(", ", teachers.Select(lt =>
                                                {
                                                    var name = lt.Teacher?.ShortName ?? lt.Teacher?.FullName ?? "N/A";
                                                    return name.Length > 3 ? name.Substring(0, 3) : name;
                                                }));

                                                var tooltipText = $"<strong>Lesson ID:</strong> {lesson.LessonId}<br><strong>Scheduled ID:</strong> {lesson.Id}<br><strong>Subject(s):</strong> {subjectsWithIds}<br><strong>Teacher(s):</strong> {teachersWithIds}<br><strong>Class(es):</strong> {classesWithIds}<br><strong>Room(s):</strong> {roomsWithIds}";

                                                <div class="@cardClasses"
                                                     data-subject="@subjectNames"
                                                     data-class="@classNames"
                                                     data-teacher="@teacherNames"
                                                     data-room="@roomsDisplay"
                                                     data-rooms="@roomsForFilter"
                                                     data-subject-full="@subjectNames"
                                                     data-teacher-full="@teacherNames"
                                                     data-teacher-ids="@teacherIdList"
                                                     data-class-ids="@classIdList"
                                                     data-subject-ids="@subjectIdList"
                                                     data-room-ids="@roomIdList"
                                                     data-day-num="@dayNum"
                                                     data-period-id="@period.Id"
                                                     data-bs-toggle="tooltip"
                                                     data-bs-placement="top"
                                                     data-bs-html="true"
                                                     data-bs-title="@tooltipText"
                                                     style="background-color: @bgColor; color: @fgColor; border-left: @borderWidth solid @fgColor; border-radius: 4px; padding: 8px;">
                                                    @if (lesson.IsLocked)
                                                    {
                                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark"
                                                              style="font-size: 0.6rem; padding: 2px 4px;"
                                                              title="This lesson is locked and won't be moved during regeneration">
                                                            <i class="bi bi-lock-fill"></i>
                                                        </span>
                                                    }

                                                    <!-- Detailed View (default) -->
                                                    <div class="lesson-detailed-view">
                                                        <!-- Visual indicator badges -->
                                                        @if (isCoTeaching || isMultiSubject || isMultiRoom || isMultiClass || hasAssignments)
                                                        {
                                                            <div class="mb-1">
                                                                @if (isCoTeaching) { <span class="badge badge-coteaching" title="Co-Teaching"><i class="bi bi-people-fill"></i></span> }
                                                                @if (isMultiSubject) { <span class="badge badge-multisubject" title="Multiple Subjects"><i class="bi bi-book-half"></i></span> }
                                                                @if (isMultiRoom) { <span class="badge badge-multiroom" title="Multiple Rooms"><i class="bi bi-door-open-fill"></i></span> }
                                                                @if (isMultiClass) { <span class="badge badge-multiclass" title="Combined Classes"><i class="bi bi-people"></i></span> }
                                                                @if (hasAssignments) { <span class="badge badge-assignments" title="Has Teacher-Subject-Class Assignments"><i class="bi bi-diagram-3"></i></span> }
                                                            </div>
                                                        }
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <!-- Lesson and Scheduled IDs -->
                                                                <div class="mb-1">
                                                                    <small class="text-muted">Lesson ID: <code>@lesson.LessonId</code> | Scheduled ID: <code>@lesson.Id</code></small>
                                                                </div>

                                                                <!-- Show subject(s) with IDs -->
                                                                <div class="fw-bold">
                                                                    @foreach (var subj in subjects)
                                                                    {
                                                                        <span>@(subj.Subject?.Name ?? "N/A") <small class="text-muted">(ID: @subj.SubjectId)</small></span>
                                                                        if (subj != subjects.Last())
                                                                        {
                                                                            <span> / </span>
                                                                        }
                                                                    }
                                                                </div>

                                                                <!-- Show class(es) with IDs -->
                                                                <small class="d-block">
                                                                    @foreach (var cls in classes)
                                                                    {
                                                                        <span>@(cls.Class?.Name ?? "N/A") <span class="text-muted">(ID: @cls.ClassId)</span></span>
                                                                        if (cls != classes.Last())
                                                                        {
                                                                            <span> + </span>
                                                                        }
                                                                    }
                                                                </small>

                                                                <!-- Show teacher(s) with IDs - bold for lead teacher -->
                                                                <small class="d-block">
                                                                    @foreach (var teacherLink in teachers)
                                                                    {
                                                                        if (teacherLink.IsLead)
                                                                        {
                                                                            <strong>@(teacherLink.Teacher?.FullName ?? "N/A") <span class="text-muted">(ID: @teacherLink.TeacherId)</span></strong>
                                                                        }
                                                                        else
                                                                        {
                                                                            <span>@(teacherLink.Teacher?.FullName ?? "N/A") <span class="text-muted">(ID: @teacherLink.TeacherId)</span></span>
                                                                        }
                                                                        if (teacherLink != teachers.Last())
                                                                        {
                                                                            <span> + </span>
                                                                        }
                                                                    }
                                                                </small>

                                                                <!-- Show room(s) with IDs -->
                                                                <small class="d-block">
                                                                    <i class="bi bi-door-closed"></i>
                                                                    @if (allRoomDetails.Any())
                                                                    {
                                                                        @string.Join(", ", allRoomDetails)
                                                                    }
                                                                    else
                                                                    {
                                                                        <span>No room assigned</span>
                                                                    }
                                                                </small>
                                                            </div>
                                                            <div class="d-flex flex-column gap-1">
                                                                <button type="button" class="btn btn-sm btn-link p-0 text-secondary collapse-lesson-btn"
                                                                        title="Collapse to compact view"
                                                                        onclick="event.stopPropagation();">
                                                                    <i class="bi bi-arrows-angle-contract"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-link p-0 text-primary select-lesson-btn"
                                                                        title="Select/Unselect lesson"
                                                                        data-scheduled-id="@lesson.Id">
                                                                    <i class="bi bi-circle"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-sm btn-link p-0 text-info info-lesson-btn"
                                                                        title="View full lesson details"
                                                                        data-scheduled-id="@lesson.Id"
                                                                        data-lesson-id="@lesson.LessonId"
                                                                        data-period-id="@lesson.PeriodId"
                                                                        data-subjects="@string.Join(" / ", subjects.Select(ls => ls.Subject?.Name ?? "N/A"))"
                                                                        data-subject-ids="@subjectsWithIds"
                                                                        data-teachers="@string.Join(" + ", teachers.Select(lt => (lt.IsLead ? "★ " : "") + (lt.Teacher?.FullName ?? "N/A")))"
                                                                        data-teacher-ids="@teachersWithIds"
                                                                        data-classes="@string.Join(" + ", classes.Select(lc => lc.Class?.Name ?? "N/A"))"
                                                                        data-class-ids="@classesWithIds"
                                                                        data-rooms="@roomsDisplay"
                                                                        data-room-ids="@roomsWithIds"
                                                                        data-day="@lesson.DayOfWeek"
                                                                        data-period="@lesson.Period?.PeriodNumber"
                                                                        data-is-coteaching="@isCoTeaching"
                                                                        data-is-multisubject="@isMultiSubject"
                                                                        data-is-multiroom="@isMultiRoom"
                                                                        data-is-multiclass="@isMultiClass"
                                                                        data-is-locked="@lesson.IsLocked">
                                                                    <i class="bi bi-info-circle"></i>
                                                                </button>
                                                                <form method="post" asp-page-handler="ToggleLock" class="d-inline">
                                                                    <input type="hidden" name="lessonId" value="@lesson.Id" />
                                                                    <input type="hidden" name="timetableId" value="@Model.Timetable.Id" />
                                                                    <button type="submit"
                                                                            class="btn btn-sm btn-link p-0 @(lesson.IsLocked ? "text-warning" : "text-muted")"
                                                                            title="@(lesson.IsLocked ? "Unlock lesson (allow regeneration to move it)" : "Lock lesson (prevent regeneration from moving it)")">
                                                                        <i class="bi bi-@(lesson.IsLocked ? "lock-fill" : "unlock")"></i>
                                                                    </button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Compact View (hidden by default) -->
                                                    <div class="lesson-compact-view" style="display: none;">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="fw-bold" style="font-size: 0.85rem;">
                                                                @if (subjects.Count > 1)
                                                                {
                                                                    @string.Join("/", subjects.Select(ls => ls.Subject?.Code ?? ""))
                                                                }
                                                                else
                                                                {
                                                                    @(primarySubject?.Code ?? "N/A")
                                                                }
                                                                ·
                                                                @if (classes.Count > 1)
                                                                {
                                                                    @string.Join("+", classes.Select(lc => lc.Class?.Name ?? ""))
                                                                }
                                                                else
                                                                {
                                                                    @(primaryClass?.Name ?? "N/A")
                                                                }
                                                                · @teacherShortNames
                                                                · <small class="text-muted">S#@lesson.Id</small>
                                                            </span>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <button type="button" class="btn btn-sm btn-link p-0 text-primary select-lesson-btn compact-select"
                                                                        title="Select/Unselect lesson"
                                                                        data-scheduled-id="@lesson.Id"
                                                                        onclick="event.stopPropagation();">
                                                                    <i class="bi bi-circle"></i>
                                                                </button>
                                                                <form method="post" asp-page-handler="ToggleLock" class="d-inline" onclick="event.stopPropagation();">
                                                                    <input type="hidden" name="lessonId" value="@lesson.Id" />
                                                                    <input type="hidden" name="timetableId" value="@Model.Timetable.Id" />
                                                                    <button type="submit"
                                                                            class="btn btn-sm btn-link p-0 @(lesson.IsLocked ? "text-warning" : "text-muted")"
                                                                            title="@(lesson.IsLocked ? "Unlock lesson (allow regeneration to move it)" : "Lock lesson (prevent regeneration from moving it)")">
                                                                        <i class="bi bi-@(lesson.IsLocked ? "lock-fill" : "unlock")"></i>
                                                                    </button>
                                                                </form>
                                                                <i class="bi bi-arrows-angle-expand text-muted" style="font-size: 0.7rem;" title="Click to expand"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-muted text-center py-3">
                                                <small>Empty</small>
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Summary -->
                                    <div class="card mt-3">
                                        <div class="card-body">
                                            <h5>Summary</h5>
                                            <p class="mb-0">
                                                <strong>Total Scheduled Lessons:</strong> @Model.ScheduledLessons.Count
                                            </p>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

        <!-- Section 2: Move To (Enabled only when exactly 1 lesson is selected) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingMoveTo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMoveTo" aria-expanded="false" aria-controls="collapseMoveTo" id="moveToButton" disabled>
                    <i class="bi bi-2-circle-fill me-2"></i>
                    <strong>Move To</strong>
                    <span class="ms-2 text-muted">(Optional - Select destination slot)</span>
                </button>
            </h2>
            <div id="collapseMoveTo" class="accordion-collapse collapse" aria-labelledby="headingMoveTo">
                <div class="accordion-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Select exactly <strong>one destination timeslot</strong> where you want to move the selected lesson.
                    </div>

                    <!-- Empty Timetable for Destination Selection -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <strong>Destination Timetable</strong>
                            <small class="text-muted ms-2">Click on any slot to select it as the destination</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0" id="destinationTimetable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 150px;">Time / Day</th>
                                            @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                            {
                                                <th class="text-center">@day.ToString()</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var period in Model.Periods)
                                        {
                                            <tr>
                                                <td class="fw-bold bg-light">
                                                    <div>@period.Name</div>
                                                    <small class="text-muted">
                                                        @period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")
                                                    </small>
                                                </td>
                                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                                {
                                                    <td class="destination-slot"
                                                        data-day="@day"
                                                        data-period-id="@period.Id"
                                                        style="min-height: 100px; vertical-align: middle; text-align: center; cursor: pointer; padding: 20px;">
                                                        <div class="text-muted">
                                                            <i class="bi bi-square"></i>
                                                        </div>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Slots to Avoid for Selected Lessons -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingAvoidSelected">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvoidSelected" aria-expanded="false" aria-controls="collapseAvoidSelected" id="avoidSelectedButton">
                    <i class="bi bi-3-circle-fill me-2"></i>
                    <strong>Slots to Avoid for Selected Lessons</strong>
                    <span class="ms-2 text-muted">(Optional - Select multiple slots to avoid)</span>
                </button>
            </h2>
            <div id="collapseAvoidSelected" class="accordion-collapse collapse" aria-labelledby="headingAvoidSelected">
                <div class="accordion-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Select timeslots that should be <strong>avoided</strong> when moving the selected lessons. You can select multiple slots.
                    </div>

                    <!-- Timetable for Avoidance Selection -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Avoidance Timetable for Selected Lessons</strong>
                                <small class="text-muted ms-2">Click on slots to mark them as avoided</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAvoidSelectedBtn">
                                <i class="bi bi-x-circle"></i> Clear All
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0" id="avoidSelectedTimetable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 150px;">Time / Day</th>
                                            @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                            {
                                                <th class="text-center">@day.ToString()</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var period in Model.Periods)
                                        {
                                            <tr>
                                                <td class="fw-bold bg-light">
                                                    <div>@period.Name</div>
                                                    <small class="text-muted">
                                                        @period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")
                                                    </small>
                                                </td>
                                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                                {
                                                    <td class="avoid-selected-slot"
                                                        data-day="@day"
                                                        data-period-id="@period.Id"
                                                        style="min-height: 100px; vertical-align: middle; text-align: center; cursor: pointer; padding: 20px;">
                                                        <div class="text-muted">
                                                            <i class="bi bi-square"></i>
                                                        </div>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Slots to Avoid for Unlocked Lessons -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingAvoidUnlocked">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvoidUnlocked" aria-expanded="false" aria-controls="collapseAvoidUnlocked">
                    <i class="bi bi-4-circle-fill me-2"></i>
                    <strong>Slots to Avoid for Unlocked Lessons</strong>
                    <span class="ms-2 text-muted">(Optional - For multi-step edits)</span>
                </button>
            </h2>
            <div id="collapseAvoidUnlocked" class="accordion-collapse collapse" aria-labelledby="headingAvoidUnlocked">
                <div class="accordion-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Select timeslots that should be <strong>avoided</strong> when moving any unlocked lessons during multi-step edits. You can select multiple slots.
                    </div>

                    <!-- Timetable for Unlocked Lessons Avoidance Selection -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Avoidance Timetable for Unlocked Lessons</strong>
                                <small class="text-muted ms-2">Click on slots to mark them as avoided</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAvoidUnlockedBtn">
                                <i class="bi bi-x-circle"></i> Clear All
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0" id="avoidUnlockedTimetable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 150px;">Time / Day</th>
                                            @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                            {
                                                <th class="text-center">@day.ToString()</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var period in Model.Periods)
                                        {
                                            <tr>
                                                <td class="fw-bold bg-light">
                                                    <div>@period.Name</div>
                                                    <small class="text-muted">
                                                        @period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")
                                                    </small>
                                                </td>
                                                @foreach (var day in new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday })
                                                {
                                                    <td class="avoid-unlocked-slot"
                                                        data-day="@day"
                                                        data-period-id="@period.Id"
                                                        style="min-height: 100px; vertical-align: middle; text-align: center; cursor: pointer; padding: 20px;">
                                                        <div class="text-muted">
                                                            <i class="bi bi-square"></i>
                                                        </div>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Generate Options Button -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body text-center">
            <button type="button" class="btn btn-lg btn-primary" id="generateOptionsBtn">
                <i class="bi bi-magic"></i> Generate Options
            </button>
            <div class="mt-2 text-muted">
                <small>This button will generate movement options based on your selections above.</small>
            </div>
        </div>
    </div>
</div>

<!-- Lesson Info Modal -->
<div class="modal fade" id="lessonInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle-fill"></i> Lesson Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong><i class="bi bi-calendar-event"></i> Schedule Information</strong>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td class="text-muted" style="width: 50%;">Scheduled Lesson ID:</td>
                                        <td><code id="info-scheduled-id"></code></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Lesson ID:</td>
                                        <td><code id="info-lesson-id"></code></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Day:</td>
                                        <td><strong id="info-day"></strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Period:</td>
                                        <td><strong id="info-period"></strong> <small class="text-muted">(ID: <code id="info-period-id"></code>)</small></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Lesson Number:</td>
                                        <td><strong id="info-lesson-number"></strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">Status:</td>
                                        <td id="info-locked"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong><i class="bi bi-tags"></i> Lesson Type</strong>
                            </div>
                            <div class="card-body">
                                <div id="info-badges"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="bi bi-book-half"></i> Subject(s)</strong>
                    </div>
                    <div class="card-body">
                        <div id="info-subjects" class="fs-5 mb-2"></div>
                        <div class="text-muted small">
                            <strong>With IDs:</strong>
                            <div id="info-subject-ids" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="bi bi-people-fill"></i> Teacher(s)</strong>
                    </div>
                    <div class="card-body">
                        <div id="info-teachers" class="fs-5 mb-2"></div>
                        <small class="text-muted d-block mb-2">★ = Lead Teacher</small>
                        <div class="text-muted small">
                            <strong>With IDs:</strong>
                            <div id="info-teacher-ids" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong><i class="bi bi-people"></i> Class(es)</strong>
                    </div>
                    <div class="card-body">
                        <div id="info-classes" class="fs-5 mb-2"></div>
                        <div class="text-muted small">
                            <strong>With IDs:</strong>
                            <div id="info-class-ids" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-light">
                        <strong><i class="bi bi-door-closed"></i> Room(s)</strong>
                    </div>
                    <div class="card-body">
                        <div id="info-rooms" class="fs-5 mb-2"></div>
                        <div class="text-muted small">
                            <strong>With IDs:</strong>
                            <div id="info-room-ids" class="mt-1"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Options Confirmation Modal -->
<div class="modal fade" id="confirmGenerateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill"></i> Confirm Generate Options
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i> Please review your selections before generating movement options.
                </div>

                <!-- Section 1: Selected Lessons -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-1-circle-fill me-2"></i> Selected Lessons for Movement</h6>
                    </div>
                    <div class="card-body">
                        <div id="confirm-selected-lessons">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Section 2: Destination Slot -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-2-circle-fill me-2"></i> Destination Slot</h6>
                    </div>
                    <div class="card-body">
                        <div id="confirm-destination">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Section 3: Avoid Slots for Selected Lessons -->
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-3-circle-fill me-2"></i> Slots to Avoid for Selected Lessons</h6>
                    </div>
                    <div class="card-body">
                        <div id="confirm-avoid-selected">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Section 4: Avoid Slots for Unlocked Lessons -->
                <div class="card mb-3">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-4-circle-fill me-2"></i> Slots to Avoid for Unlocked Lessons</h6>
                    </div>
                    <div class="card-body">
                        <div id="confirm-avoid-unlocked">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Configuration Options -->
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="bi bi-gear-fill me-2"></i> Generation Options</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="algorithmSelection" class="form-label">
                                    <strong>Algorithm Selection</strong>
                                    <small class="text-muted d-block">Choose which algorithm to use for generating options</small>
                                </label>
                                <select class="form-select" id="algorithmSelection">
                                    <option value="kempe-chain">Kempe Chain + Tabu Search (2-slot swaps)</option>
                                    <option value="multi-step-kempe-chain">Multi-Step Kempe Chain (3+ slot chains)</option>
                                    <option value="musical-chairs">Musical Chairs (recursive displacement, 2-16 steps)</option>
                                    <option value="recursive-conflict-resolution" selected>Recursive Conflict Resolution (multi-conflict handling)</option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle"></i>
                                    <span id="algorithmDescription">The Kempe Chain algorithm uses graph-based optimization to find lesson movements with minimal disruption</span>
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="maxUnfixedLessons" class="form-label">
                                    <strong>Max Number of Un-Fixed Lessons to Move</strong>
                                    <small class="text-muted d-block">For each selected lesson</small>
                                </label>
                                <input type="number" class="form-control" id="maxUnfixedLessons" value="3" min="0" max="100" step="1">
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle"></i> Maximum number of unlocked lessons the algorithm can move to accommodate each selected lesson
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="maxTimeMinutes" class="form-label">
                                    <strong>Max Allowed Time to Find Options</strong>
                                    <small class="text-muted d-block">In minutes</small>
                                </label>
                                <input type="number" class="form-control" id="maxTimeMinutes" value="1" min="1" max="60" step="1">
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle"></i> Time limit for the algorithm to search for valid movement options
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Substitution Planning Mode -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-arrow-left-right me-2"></i> Substitution Planning Mode
                            <small class="d-block mt-1 fw-normal">
                                <i class="bi bi-info-circle"></i> Restrict movement to substitution reserve slots only
                            </small>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="true" id="substitutionModeCheckbox">
                            <label class="form-check-label" for="substitutionModeCheckbox">
                                <strong>Substitution Mode</strong>
                                <small class="text-muted d-block">
                                    Only allow movement to slots that contain lessons with the <strong>"substitution"</strong> subject
                                    and the <strong>"v-res"</strong> (reserve) class. Substitution lessons can swap with the selected
                                    lesson to provide coverage. This is useful for substitution planning.
                                </small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Hard Constraints to Ignore -->
                <div class="card mt-3">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> Hard Constraints to Ignore
                            <small class="d-block mt-1 fw-normal">
                                <i class="bi bi-info-circle"></i> Check constraints to allow violations during generation (use with caution!)
                            </small>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-shield-exclamation"></i> <strong>Warning:</strong> Ignoring hard constraints may produce invalid timetables. Only ignore constraints when absolutely necessary.
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-1" id="ignore-HC-1">
                                    <label class="form-check-label" for="ignore-HC-1">
                                        <strong>HC-1:</strong> Teacher Double-Booking
                                        <small class="text-muted d-block">Allow teacher to teach multiple lessons simultaneously</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-2" id="ignore-HC-2">
                                    <label class="form-check-label" for="ignore-HC-2">
                                        <strong>HC-2:</strong> Class Double-Booking
                                        <small class="text-muted d-block">Allow class to attend multiple lessons simultaneously</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-3" id="ignore-HC-3">
                                    <label class="form-check-label" for="ignore-HC-3">
                                        <strong>HC-3:</strong> Room Double-Booking
                                        <small class="text-muted d-block">Allow room to host multiple lessons simultaneously</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-4" id="ignore-HC-4">
                                    <label class="form-check-label" for="ignore-HC-4">
                                        <strong>HC-4:</strong> Teacher Absolute Unavailability
                                        <small class="text-muted d-block">Allow scheduling during teacher unavailable times</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-5" id="ignore-HC-5" checked>
                                    <label class="form-check-label" for="ignore-HC-5">
                                        <strong>HC-5:</strong> Class Absolute Unavailability
                                        <small class="text-muted d-block">Allow scheduling during class unavailable times</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-6" id="ignore-HC-6" checked>
                                    <label class="form-check-label" for="ignore-HC-6">
                                        <strong>HC-6:</strong> Room Absolute Unavailability
                                        <small class="text-muted d-block">Allow using room during unavailable times</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-7" id="ignore-HC-7" checked>
                                    <label class="form-check-label" for="ignore-HC-7">
                                        <strong>HC-7:</strong> Subject Absolute Unavailability
                                        <small class="text-muted d-block">Allow teaching subject during discouraged times</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-8" id="ignore-HC-8" checked>
                                    <label class="form-check-label" for="ignore-HC-8">
                                        <strong>HC-8:</strong> Teacher Max Consecutive Periods
                                        <small class="text-muted d-block">Allow exceeding max consecutive teaching periods</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-9" id="ignore-HC-9" checked>
                                    <label class="form-check-label" for="ignore-HC-9">
                                        <strong>HC-9:</strong> Class Max Consecutive Same Subject
                                        <small class="text-muted d-block">Allow exceeding max consecutive periods of same subject</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-10" id="ignore-HC-10" checked>
                                    <label class="form-check-label" for="ignore-HC-10">
                                        <strong>HC-10:</strong> Locked Lesson
                                        <small class="text-muted d-block">Allow moving locked lessons</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-11" id="ignore-HC-11" checked>
                                    <label class="form-check-label" for="ignore-HC-11">
                                        <strong>HC-11:</strong> Teacher Max Periods Per Day
                                        <small class="text-muted d-block">Allow exceeding max periods per day for teacher</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input constraint-ignore-checkbox" type="checkbox" value="HC-12" id="ignore-HC-12" checked>
                                    <label class="form-check-label" for="ignore-HC-12">
                                        <strong>HC-12:</strong> Class Max Periods Per Day
                                        <small class="text-muted d-block">Allow exceeding max periods per day for class</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="debugGenerateBtn">
                    <i class="bi bi-arrow-right-circle"></i> Proceed
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hourglass-split"></i> Generating Options...
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Progress <span id="progressPercentage" class="text-muted">(0%)</span></h6>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="generationProgress" style="width: 0%">
                            <span id="progressBarText"></span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Options Found:</strong></p>
                        <h4 id="optionsFoundCount">0</h4>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Combinations Explored:</strong></p>
                        <h4 id="combinationsCount">0</h4>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Elapsed Time:</strong></p>
                        <h5 id="elapsedTime">0s</h5>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Estimated Remaining:</strong></p>
                        <h5 id="remainingTime" class="text-info">Calculating...</h5>
                    </div>
                </div>
                <div class="mt-3">
                    <p class="text-muted" id="statusMessage">Initializing...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="stopGenerationBtn">
                    <i class="bi bi-stop-circle"></i> Stop Generation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill"></i> Generated Options
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultsContainer">
                    <!-- Results will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete All Options Modal -->
<div class="modal fade" id="deleteAllOptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-trash"></i> Delete Generated Options
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="deleteOptionsLoading" class="text-center my-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading options...</p>
                </div>
                <div id="deleteOptionsContent" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Warning:</strong> This action cannot be undone. Select the options you want to delete.
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllOptions" onchange="toggleAllOptionsSelection()">
                            <label class="form-check-label fw-bold" for="selectAllOptions">
                                Select/Deselect All
                            </label>
                        </div>
                    </div>
                    <div id="optionsList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                        <!-- Options will be loaded here -->
                    </div>
                    <div id="noOptionsMessage" style="display: none;" class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No option timetables found for this base timetable.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteOptionsBtn" onclick="deleteSelectedOptions()">
                    <i class="bi bi-trash"></i> Delete Selected Options
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .lesson-card {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transition: all 0.2s;
            cursor: pointer;
        }

        .lesson-card:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.18);
            transform: translateY(-1px);
        }

        .lesson-card.locked-lesson {
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3), 0 1px 3px rgba(0,0,0,0.12);
        }

        .lesson-card.locked-lesson:hover {
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5), 0 2px 6px rgba(0,0,0,0.18);
        }

        /* Sticky table header */
        .table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table td {
            min-width: 150px;
        }

        /* Remove row hover effect */
        .table tbody tr:hover {
            background-color: transparent !important;
        }

        /* Highlighting styles */
        .lesson-card.highlighted {
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.5), 0 2px 8px rgba(0,0,0,0.2) !important;
            transform: scale(1.02);
            z-index: 5;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .lesson-card.dimmed {
            opacity: 0.3;
            filter: grayscale(0.5);
        }

        @@keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.5), 0 2px 8px rgba(0,0,0,0.2);
            }
            50% {
                box-shadow: 0 0 0 5px rgba(13, 110, 253, 0.7), 0 4px 12px rgba(0,0,0,0.3);
            }
        }

        /* Locked + highlighted */
        .lesson-card.locked-lesson.highlighted {
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5), 0 0 0 5px rgba(13, 110, 253, 0.7) !important;
        }

        /* Compact view styles */
        .lesson-card.compact-mode {
            padding: 4px 8px !important;
            cursor: pointer;
        }

        .lesson-card.compact-mode .lesson-compact-view {
            display: block !important;
        }

        .lesson-card.compact-mode .lesson-detailed-view {
            display: none !important;
        }

        /* Individual expanded state (when clicked in compact mode) */
        .lesson-card.compact-mode.expanded {
            padding: 8px !important;
        }

        .lesson-card.compact-mode.expanded .lesson-compact-view {
            display: none !important;
        }

        .lesson-card.compact-mode.expanded .lesson-detailed-view {
            display: block !important;
        }

        /* Hover effect for compact lessons */
        .lesson-card.compact-mode:hover {
            transform: scale(1.05);
        }

        /* Compact view text styling */
        .lesson-compact-view {
            /* Allow text to wrap on multiple lines */
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Conflict highlighting styles */
        .lesson-card.has-conflict {
            background-color: #dc3545 !important;
            color: white !important;
            border-left-color: #a02834 !important;
        }

        .lesson-card.has-conflict:hover {
            opacity: 1 !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .lesson-card.conflict-related {
            opacity: 0.95;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.3);
            outline: 2px solid #dc3545;
        }

        .lesson-card.conflict-dimmed {
            opacity: 0.3;
        }

        /* Icons in conflict cards need white background for visibility */
        .lesson-card.has-conflict .badge i,
        .lesson-card.has-conflict .bi {
            background-color: rgba(255, 255, 255, 0.9);
            color: #dc3545 !important;
            border-radius: 50%;
            padding: 2px;
        }

        .lesson-card.has-conflict .badge {
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #dc3545 !important;
        }

        /* Availability conflict highlighting (entity scheduled during unavailable time) */
        .lesson-card.has-availability-conflict {
            border: 4px solid #00ff00 !important;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.5);
        }

        .availability-conflict-indicator {
            margin-top: 6px;
            padding: 3px 6px;
            background-color: #00ff00;
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 3px;
            text-align: center;
        }

        .availability-conflict-indicator i {
            margin-right: 4px;
        }

        /* Selection highlighting styles */
        .lesson-card.selected {
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.6), 0 4px 12px rgba(13, 110, 253, 0.4) !important;
            border: 2px solid #0d6efd !important;
            position: relative;
            z-index: 10;
        }

        .lesson-card.selected .select-lesson-btn i::before {
            content: "\f26b"; /* bi-check-circle-fill */
        }

        .select-lesson-btn {
            transition: all 0.2s;
        }

        .select-lesson-btn:hover {
            transform: scale(1.1);
        }

        /* Co-teaching and special lesson visual indicators */
        .co-teaching-lesson {
            position: relative;
        }

        .multi-subject-lesson {
            background-image: linear-gradient(45deg, transparent 48%, rgba(255, 193, 7, 0.2) 48%, rgba(255, 193, 7, 0.2) 52%, transparent 52%) !important;
            background-size: 10px 10px !important;
        }

        /* Badge styles for indicators */
        .badge-coteaching {
            background-color: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 2px;
        }

        .badge-multisubject {
            background-color: #ffc107;
            color: #333;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 2px;
        }

        .badge-multiroom {
            background-color: #17a2b8;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 2px;
        }

        .badge-multiclass {
            background-color: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 2px;
        }

        .badge-assignments {
            background-color: #6f42c1;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 2px;
        }

        /* Destination and Avoidance Slot Styles */
        .destination-slot,
        .avoid-selected-slot,
        .avoid-unlocked-slot {
            transition: all 0.2s;
            background-color: #f8f9fa;
        }

        .destination-slot:hover,
        .avoid-selected-slot:hover,
        .avoid-unlocked-slot:hover {
            background-color: #e9ecef;
            transform: scale(1.02);
        }

        .destination-slot.selected {
            background-color: #0d6efd !important;
            color: white !important;
            border: 3px solid #0a58ca !important;
        }

        .destination-slot.selected .text-muted {
            color: white !important;
        }

        .destination-slot.selected i::before {
            content: "\f26b"; /* bi-check-circle-fill */
            font-size: 2rem;
            color: white;
        }

        .avoid-selected-slot.selected,
        .avoid-unlocked-slot.selected {
            background-color: #dc3545 !important;
            color: white !important;
            border: 2px solid #bb2d3b !important;
        }

        .avoid-selected-slot.selected .text-muted,
        .avoid-unlocked-slot.selected .text-muted {
            color: white !important;
        }

        .avoid-selected-slot.selected i::before,
        .avoid-unlocked-slot.selected i::before {
            content: "\f62a"; /* bi-x-lg */
            font-size: 2rem;
            color: white;
            font-weight: bold;
        }

        /* Disabled accordion button style */
        .accordion-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Hide accordion content when button is disabled */
        .accordion-button:disabled + .accordion-collapse {
            display: none !important;
        }

        /* Accordion item styling */
        .accordion-item {
            margin-bottom: 1rem;
        }

        /* Results timetable: Highlighting for moved and requested lessons */
        .result-lesson-card.moved-lesson {
            background-color: #b3d9ff !important; /* Light blue */
            box-shadow: 0 0 0 2px #0066cc, 0 2px 6px rgba(0,0,0,0.15);
        }

        .result-lesson-card.requested-lesson {
            background-color: #c3f0ca !important; /* Light green */
            box-shadow: 0 0 0 2px #28a745, 0 2px 6px rgba(0,0,0,0.15);
        }

        .result-lesson-card.moved-lesson:hover,
        .result-lesson-card.requested-lesson:hover {
            box-shadow: 0 0 0 3px currentColor, 0 4px 12px rgba(0,0,0,0.25);
            transform: translateY(-2px) scale(1.02);
            z-index: 100;
        }

        /* Old slot tooltip */
        .old-slot-tooltip {
            animation: fadeIn 0.2s ease-in;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Result timetable specific styling */
        .option-timetable .result-lesson-card {
            transition: all 0.3s ease;
        }
    </style>
}

@section Scripts {
    <!-- Filter State Management -->
    <script src="~/js/filter-state.js"></script>
    <!-- SignalR Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>

    <script>
        const timetableId = @(Model.Timetable?.Id ?? 0);
        const timetableName = "@(Model.Timetable?.Name ?? "")";
        let generationConnection = null;
        let currentSessionId = null;

        // Periods and days data for results display
        const periods = @Html.Raw(Json.Serialize(Model.Periods.Select(p => new {
            id = p.Id,
            name = p.Name,
            periodNumber = p.PeriodNumber,
            startTime = p.StartTime.ToString(@"hh\:mm"),
            endTime = p.EndTime.ToString(@"hh\:mm")
        })));
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];

        // Unavailability data for conflict detection (Importance = -3 means absolute unavailability)
        // Key format: "EntityId:DayNum:PeriodId" -> true
        const teacherUnavailability = @Html.Raw(Json.Serialize(Model.TeacherUnavailability));
        const classUnavailability = @Html.Raw(Json.Serialize(Model.ClassUnavailability));
        const subjectUnavailability = @Html.Raw(Json.Serialize(Model.SubjectUnavailability));
        const roomUnavailability = @Html.Raw(Json.Serialize(Model.RoomUnavailability));

        // Store all options globally for save/compare functionality
        let generatedOptions = [];

        // Lesson sorting functionality
        document.getElementById('sortLessons').addEventListener('change', function() {
            const sortBy = this.value;

            // Get all table cells that contain lessons
            const cells = document.querySelectorAll('.table td');

            cells.forEach(cell => {
                const lessons = Array.from(cell.querySelectorAll('.lesson-card'));

                if (lessons.length <= 1) return; // No need to sort if 0 or 1 lesson

                // Sort lessons based on selected criteria
                lessons.sort((a, b) => {
                    let valueA, valueB;

                    switch(sortBy) {
                        case 'subject':
                            valueA = a.dataset.subject || '';
                            valueB = b.dataset.subject || '';
                            break;
                        case 'class':
                            valueA = a.dataset.class || '';
                            valueB = b.dataset.class || '';
                            break;
                        case 'teacher':
                            valueA = a.dataset.teacher || '';
                            valueB = b.dataset.teacher || '';
                            break;
                        default:
                            return 0; // Don't sort for 'none'
                    }

                    return valueA.localeCompare(valueB);
                });

                // Re-append in sorted order
                lessons.forEach(lesson => {
                    cell.appendChild(lesson);
                });
            });
        });

        // Handle info button clicks
        document.querySelectorAll('.info-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Get data from button attributes
                const subjects = this.dataset.subjects;
                const teachers = this.dataset.teachers;
                const classes = this.dataset.classes;
                const rooms = this.dataset.rooms;
                const day = this.dataset.day;
                const period = this.dataset.period;
                const lessonNumber = this.dataset.lessonNumber;
                const isCoTeaching = this.dataset.isCoteaching === 'True';
                const isMultiSubject = this.dataset.isMultisubject === 'True';
                const isMultiRoom = this.dataset.isMultiroom === 'True';
                const isMultiClass = this.dataset.isMulticlass === 'True';
                const isLocked = this.dataset.isLocked === 'True';

                // Get IDs
                const scheduledId = this.dataset.scheduledId;
                const lessonId = this.dataset.lessonId;
                const periodId = this.dataset.periodId;
                const subjectIds = this.dataset.subjectIds;
                const teacherIds = this.dataset.teacherIds;
                const classIds = this.dataset.classIds;
                const roomIds = this.dataset.roomIds;

                // Populate IDs in schedule information
                document.getElementById('info-scheduled-id').textContent = scheduledId;
                document.getElementById('info-lesson-id').textContent = lessonId;
                document.getElementById('info-period-id').textContent = periodId;

                // Populate schedule information
                document.getElementById('info-day').textContent = day;
                document.getElementById('info-period').textContent = `Period ${period}`;
                document.getElementById('info-lesson-number').textContent = lessonNumber;
                document.getElementById('info-locked').innerHTML = isLocked
                    ? '<span class="badge bg-warning text-dark"><i class="bi bi-lock-fill"></i> Locked</span>'
                    : '<span class="badge bg-success"><i class="bi bi-unlock"></i> Unlocked</span>';

                // Populate badges
                let badgesHtml = '';
                if (isCoTeaching) {
                    badgesHtml += '<span class="badge badge-coteaching me-2 mb-2"><i class="bi bi-people-fill"></i> Co-Teaching</span>';
                }
                if (isMultiSubject) {
                    badgesHtml += '<span class="badge badge-multisubject me-2 mb-2"><i class="bi bi-book-half"></i> Multi-Subject</span>';
                }
                if (isMultiRoom) {
                    badgesHtml += '<span class="badge badge-multiroom me-2 mb-2"><i class="bi bi-door-open-fill"></i> Multi-Room</span>';
                }
                if (isMultiClass) {
                    badgesHtml += '<span class="badge badge-multiclass me-2 mb-2"><i class="bi bi-people"></i> Combined Classes</span>';
                }
                if (!badgesHtml) {
                    badgesHtml = '<span class="text-muted">Regular Lesson</span>';
                }
                document.getElementById('info-badges').innerHTML = badgesHtml;

                // Populate subjects and IDs
                document.getElementById('info-subjects').innerHTML = `<strong>${subjects}</strong>`;
                document.getElementById('info-subject-ids').innerHTML = subjectIds ? `<div>${subjectIds}</div>` : '<em>No subjects</em>';

                // Populate teachers and IDs
                document.getElementById('info-teachers').innerHTML = `<strong>${teachers}</strong>`;
                document.getElementById('info-teacher-ids').innerHTML = teacherIds ? `<div>${teacherIds}</div>` : '<em>No teachers</em>';

                // Populate classes and IDs
                document.getElementById('info-classes').innerHTML = `<strong>${classes}</strong>`;
                document.getElementById('info-class-ids').innerHTML = classIds ? `<div>${classIds}</div>` : '<em>No classes</em>';

                // Populate rooms and IDs
                document.getElementById('info-rooms').innerHTML = `<strong>${rooms}</strong>`;
                document.getElementById('info-room-ids').innerHTML = roomIds ? `<div>${roomIds}</div>` : '<em>No rooms</em>';

                // Show modal
                new bootstrap.Modal(document.getElementById('lessonInfoModal')).show();
            });
        });

        // ============================================
        // Advanced Highlighting Functionality with Dynamic Cascading Filters
        // ============================================

        // Extract all lesson data from cards on page load
        const allLessonsData = [];
        document.querySelectorAll('.lesson-card').forEach(card => {
            // Parse multi-value data (pipe-separated lists) into arrays
            const teachersList = (card.dataset.teacher || '').split('|').filter(t => t.trim());
            const subjectsList = (card.dataset.subject || '').split('|').filter(s => s.trim());
            const classesList = (card.dataset.class || '').split('|').filter(c => c.trim());
            const roomsList = (card.dataset.rooms || '').split('|').filter(r => r.trim());

            allLessonsData.push({
                teachers: teachersList,  // Array of teacher names
                subjects: subjectsList,  // Array of subject names
                classes: classesList,    // Array of class names
                rooms: roomsList,        // Array of room numbers
                element: card
            });
        });

        // Function to get available filter values based on current selections
        function getAvailableFilterValues(filterType, currentFilters) {
            const values = new Set();

            allLessonsData.forEach(lesson => {
                // Check if this lesson matches all OTHER selected filters
                let matches = true;

                // Check teacher filter - lesson must include the selected teacher
                if (filterType !== 'teacher' && currentFilters.teacher) {
                    const hasMatchingTeacher = lesson.teachers && lesson.teachers.length > 0
                        ? lesson.teachers.includes(currentFilters.teacher)
                        : false;
                    if (!hasMatchingTeacher) {
                        matches = false;
                    }
                }

                // Check subject filter - lesson must include the selected subject
                if (filterType !== 'subject' && currentFilters.subject) {
                    const hasMatchingSubject = lesson.subjects && lesson.subjects.length > 0
                        ? lesson.subjects.includes(currentFilters.subject)
                        : false;
                    if (!hasMatchingSubject) {
                        matches = false;
                    }
                }

                // Check class filter - lesson must include the selected class
                if (filterType !== 'class' && currentFilters.class) {
                    const hasMatchingClass = lesson.classes && lesson.classes.length > 0
                        ? lesson.classes.includes(currentFilters.class)
                        : false;
                    if (!hasMatchingClass) {
                        matches = false;
                    }
                }

                // Check room filter - lesson must include the selected room
                if (filterType !== 'room' && currentFilters.room) {
                    const hasMatchingRoom = lesson.rooms && lesson.rooms.length > 0
                        ? lesson.rooms.includes(currentFilters.room)
                        : false;
                    if (!hasMatchingRoom) {
                        matches = false;
                    }
                }

                // If it matches, add ALL values for this filter type from this lesson
                if (matches) {
                    if (filterType === 'teacher') {
                        lesson.teachers.forEach(t => { if (t) values.add(t); });
                    } else if (filterType === 'subject') {
                        lesson.subjects.forEach(s => { if (s) values.add(s); });
                    } else if (filterType === 'class') {
                        lesson.classes.forEach(c => { if (c) values.add(c); });
                    } else if (filterType === 'room') {
                        lesson.rooms.forEach(r => { if (r) values.add(r); });
                    }
                }
            });

            return Array.from(values).sort();
        }

        // Function to update filter dropdown options dynamically
        function updateFilterOptions(filterType, availableValues, currentValue) {
            const select = document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1));
            const emptyText = `-- All ${filterType.charAt(0).toUpperCase() + filterType.slice(1)}s --`;

            const selectedValue = currentValue || select.value;
            select.innerHTML = `<option value="">${emptyText}</option>`;

            availableValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                if (value === selectedValue) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            if (selectedValue && !availableValues.includes(selectedValue)) {
                select.value = '';
            }
        }

        // Function to update all filter options based on current selections
        function updateAllFilterOptions(changedFilter = null) {
            const currentFilters = {
                teacher: document.getElementById('filterTeacher').value,
                subject: document.getElementById('filterSubject').value,
                class: document.getElementById('filterClass').value,
                room: document.getElementById('filterRoom').value
            };

            if (changedFilter !== 'teacher') {
                const availableTeachers = getAvailableFilterValues('teacher', currentFilters);
                updateFilterOptions('teacher', availableTeachers, currentFilters.teacher);
            }

            if (changedFilter !== 'subject') {
                const availableSubjects = getAvailableFilterValues('subject', currentFilters);
                updateFilterOptions('subject', availableSubjects, currentFilters.subject);
            }

            if (changedFilter !== 'class') {
                const availableClasses = getAvailableFilterValues('class', currentFilters);
                updateFilterOptions('class', availableClasses, currentFilters.class);
            }

            if (changedFilter !== 'room') {
                const availableRooms = getAvailableFilterValues('room', currentFilters);
                updateFilterOptions('room', availableRooms, currentFilters.room);
            }
        }

        function applyHighlighting() {
            const filterTeacher = document.getElementById('filterTeacher').value;
            const filterSubject = document.getElementById('filterSubject').value;
            const filterClass = document.getElementById('filterClass').value;
            const filterRoom = document.getElementById('filterRoom').value;

            const hasActiveFilters = filterTeacher || filterSubject || filterClass || filterRoom;
            const allCards = document.querySelectorAll('.lesson-card');
            let matchCount = 0;

            allCards.forEach(card => {
                const cardTeachers = (card.dataset.teacher || '').split('|').filter(t => t.trim());
                const cardSubjects = (card.dataset.subject || '').split('|').filter(s => s.trim());
                const cardClasses = (card.dataset.class || '').split('|').filter(c => c.trim());
                const cardRooms = (card.dataset.rooms || '').split('|').filter(r => r.trim());

                let matches = true;

                if (filterTeacher) {
                    const hasMatchingTeacher = cardTeachers.length > 0
                        ? cardTeachers.includes(filterTeacher)
                        : false;
                    if (!hasMatchingTeacher) {
                        matches = false;
                    }
                }
                if (filterSubject) {
                    const hasMatchingSubject = cardSubjects.length > 0
                        ? cardSubjects.includes(filterSubject)
                        : false;
                    if (!hasMatchingSubject) {
                        matches = false;
                    }
                }
                if (filterClass) {
                    const hasMatchingClass = cardClasses.length > 0
                        ? cardClasses.includes(filterClass)
                        : false;
                    if (!hasMatchingClass) {
                        matches = false;
                    }
                }
                if (filterRoom) {
                    const hasMatchingRoom = cardRooms.length > 0
                        ? cardRooms.includes(filterRoom)
                        : false;
                    if (!hasMatchingRoom) {
                        matches = false;
                    }
                }

                // Apply dimming only (no hiding)
                if (hasActiveFilters) {
                    if (matches) {
                        card.classList.add('highlighted');
                        card.classList.remove('dimmed');
                        card.style.display = '';
                        matchCount++;
                    } else {
                        card.classList.remove('highlighted');
                        card.classList.add('dimmed');
                        card.style.display = '';
                    }
                } else {
                    card.classList.remove('highlighted');
                    card.classList.remove('dimmed');
                    card.style.display = '';
                }
            });

            // Update match count display
            const matchCountEl = document.getElementById('matchCount');
            if (hasActiveFilters) {
                matchCountEl.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> <strong>${matchCount}</strong> lesson(s) match the selected criteria`;
                if (matchCount === 0) {
                    matchCountEl.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-warning"></i> No lessons match the selected criteria`;
                }
            } else {
                matchCountEl.innerHTML = '';
            }
        }

        // Handle filter changes with cascading updates
        function handleFilterChange(filterType, skipSave = false) {
            updateAllFilterOptions(filterType);
            applyHighlighting();

            // Save filter state (unless restoring)
            if (!skipSave) {
                saveFilterState();
            }
        }

        // Save current filter values to FilterState
        function saveFilterState() {
            FilterState.save({
                teacher: document.getElementById('filterTeacher').value,
                subject: document.getElementById('filterSubject').value,
                class: document.getElementById('filterClass').value,
                room: document.getElementById('filterRoom').value
            });
        }

        // Add event listeners to filter dropdowns
        document.getElementById('filterTeacher').addEventListener('change', () => handleFilterChange('teacher'));
        document.getElementById('filterSubject').addEventListener('change', () => handleFilterChange('subject'));
        document.getElementById('filterClass').addEventListener('change', () => handleFilterChange('class'));
        document.getElementById('filterRoom').addEventListener('change', () => handleFilterChange('room'));

        // Clear filters button
        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('filterTeacher').value = '';
            document.getElementById('filterSubject').value = '';
            document.getElementById('filterClass').value = '';
            document.getElementById('filterRoom').value = '';

            updateAllFilterOptions();
            applyHighlighting();

            // Clear saved filter state
            FilterState.clear();
        });

        // Restore filters on page load
        (function restoreFilters() {
            const savedFilters = FilterState.restore();
            if (savedFilters.teacher || savedFilters.subject || savedFilters.class || savedFilters.room) {
                if (savedFilters.teacher) {
                    document.getElementById('filterTeacher').value = savedFilters.teacher;
                }
                if (savedFilters.subject) {
                    document.getElementById('filterSubject').value = savedFilters.subject;
                }
                if (savedFilters.class) {
                    document.getElementById('filterClass').value = savedFilters.class;
                }
                if (savedFilters.room) {
                    document.getElementById('filterRoom').value = savedFilters.room;
                }
                // Apply highlighting without saving again
                handleFilterChange(null, true);
            }
        })();

        // ============================================
        // Display Mode Toggle (Detailed / Compact)
        // ============================================

        let currentDisplayMode = 'compact'; // Start in compact view by default
        let tooltipInstances = [];

        // Initialize Bootstrap tooltips
        function initializeTooltips() {
            tooltipInstances.forEach(tooltip => tooltip.dispose());
            tooltipInstances = [];

            // Enable tooltips for all cards in compact mode (class-based, not global mode)
            const tooltipTriggerList = document.querySelectorAll('.lesson-card.compact-mode[data-bs-toggle="tooltip"]');
            tooltipInstances = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        }

        // Toggle display mode for all lessons
        function setDisplayMode(mode) {
            currentDisplayMode = mode;
            const allLessonCards = document.querySelectorAll('.lesson-card');

            allLessonCards.forEach(card => {
                if (mode === 'compact') {
                    card.classList.add('compact-mode');
                    card.classList.remove('expanded');
                } else {
                    card.classList.remove('compact-mode');
                    card.classList.remove('expanded');
                }
            });

            initializeTooltips();
        }

        // Handle radio button changes
        document.querySelectorAll('input[name="displayMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                setDisplayMode(this.value);
            });
        });

        // Note: Initial display mode is set later in the script after all elements are loaded

        // Handle click on compact lesson cards to expand individually
        document.addEventListener('click', function(e) {
            const lessonCard = e.target.closest('.lesson-card.compact-mode');

            if (lessonCard) {
                const isActionButton = e.target.closest('.btn-sm, form button');

                if (!isActionButton) {
                    // If in overall detailed mode and card was individually collapsed,
                    // remove compact-mode to return to detailed
                    if (currentDisplayMode === 'detailed' && !lessonCard.classList.contains('expanded')) {
                        lessonCard.classList.remove('compact-mode');
                        initializeTooltips();
                    } else {
                        // Otherwise just toggle expanded state
                        lessonCard.classList.toggle('expanded');

                        if (lessonCard.classList.contains('expanded')) {
                            const tooltip = bootstrap.Tooltip.getInstance(lessonCard);
                            if (tooltip) {
                                tooltip.hide();
                            }
                        }
                    }
                }
            }
        });

        // Handle collapse button clicks - works in both detailed and compact views
        document.querySelectorAll('.collapse-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const lessonCard = this.closest('.lesson-card');

                if (lessonCard.classList.contains('compact-mode')) {
                    // If card is in compact mode and expanded, just collapse it
                    if (lessonCard.classList.contains('expanded')) {
                        lessonCard.classList.remove('expanded');
                    }
                } else {
                    // If card is in detailed view, switch it to compact mode
                    lessonCard.classList.add('compact-mode');
                    lessonCard.classList.remove('expanded');
                    // Re-initialize tooltips to enable tooltip for this card
                    initializeTooltips();
                }
            });
        });

        // ============================================
        // Automatic Conflict Detection and Highlighting
        // ============================================

        // Function to detect conflicts based on scheduling rules
        function detectConflicts() {
            const allLessonCards = document.querySelectorAll('.lesson-card');
            const conflictMap = new Map(); // Map to store conflicts for each lesson

            // Build a schedule map for easy lookup
            const scheduleMap = {};

            allLessonCards.forEach(card => {
                // Parse multiple teachers, classes, subjects from data attributes
                const teachersStr = card.dataset.teacher || '';
                const classesStr = card.dataset.class || '';
                const roomsStr = card.dataset.rooms || '';

                // Split by delimiters to get arrays (pipe-separated)
                const teachers = teachersStr.split('|').map(t => t.trim()).filter(t => t);
                const classes = classesStr.split('|').map(c => c.trim()).filter(c => c);
                const rooms = roomsStr.split('|').map(r => r.trim()).filter(r => r);

                // Get day and period from parent cell
                const cell = card.closest('td');
                const row = cell.closest('tr');
                const dayIndex = Array.from(row.children).indexOf(cell) - 1; // -1 for period column
                const periodIndex = Array.from(row.parentElement.children).indexOf(row);
                const scheduleKey = `${dayIndex}-${periodIndex}`;

                if (!scheduleMap[scheduleKey]) {
                    scheduleMap[scheduleKey] = [];
                }
                scheduleMap[scheduleKey].push({
                    card: card,
                    teachers: teachers,
                    classes: classes,
                    rooms: rooms
                });
            });

            // Check for conflicts in each time slot
            Object.keys(scheduleMap).forEach(scheduleKey => {
                const lessons = scheduleMap[scheduleKey];

                if (lessons.length > 1) {
                    // Check for teacher conflicts
                    const teacherMap = {};
                    const classMap = {};
                    const roomMap = {};

                    lessons.forEach(lesson => {
                        // Track conflicts by teacher (check ALL teachers in the lesson)
                        lesson.teachers.forEach(teacher => {
                            // Skip "xy" - placeholder for interns
                            if (teacher && teacher.toLowerCase().trim() !== 'xy') {
                                if (!teacherMap[teacher]) {
                                    teacherMap[teacher] = [];
                                }
                                teacherMap[teacher].push(lesson.card);
                            }
                        });

                        // Track conflicts by class (check ALL classes in the lesson)
                        lesson.classes.forEach(className => {
                            // Skip "v-res" - reserve for substitution
                            if (className && className.toLowerCase().trim() !== 'v-res') {
                                if (!classMap[className]) {
                                    classMap[className] = [];
                                }
                                classMap[className].push(lesson.card);
                            }
                        });

                        // Track conflicts by room (check ALL rooms in the lesson)
                        lesson.rooms.forEach(room => {
                            if (room) {
                                if (!roomMap[room]) {
                                    roomMap[room] = [];
                                }
                                roomMap[room].push(lesson.card);
                            }
                        });
                    });

                    // Mark conflicts
                    [teacherMap, classMap, roomMap].forEach(map => {
                        Object.values(map).forEach(cards => {
                            if (cards.length > 1) {
                                // Multiple lessons with same teacher/class/room in same slot = conflict
                                cards.forEach(card => {
                                    card.classList.add('has-conflict');

                                    // Store related conflicting cards
                                    if (!conflictMap.has(card)) {
                                        conflictMap.set(card, new Set());
                                    }
                                    cards.forEach(otherCard => {
                                        if (otherCard !== card) {
                                            conflictMap.get(card).add(otherCard);
                                        }
                                    });
                                });
                            }
                        });
                    });
                }
            });

            // Check for availability conflicts (entity scheduled when unavailable - Importance = -3)
            allLessonCards.forEach(card => {
                const dayNum = card.dataset.dayNum;
                const periodId = card.dataset.periodId;

                if (!dayNum || !periodId) return;

                // Get entity IDs from data attributes (comma-separated)
                const teacherIds = (card.dataset.teacherIds || '').split(',').filter(id => id);
                const classIds = (card.dataset.classIds || '').split(',').filter(id => id);
                const subjectIds = (card.dataset.subjectIds || '').split(',').filter(id => id);
                const roomIds = (card.dataset.roomIds || '').split(',').filter(id => id);

                const availabilityConflicts = [];

                // Check teacher unavailability
                teacherIds.forEach(teacherId => {
                    const key = `${teacherId}:${dayNum}:${periodId}`;
                    if (teacherUnavailability[key]) {
                        availabilityConflicts.push('Teacher');
                    }
                });

                // Check class unavailability
                classIds.forEach(classId => {
                    const key = `${classId}:${dayNum}:${periodId}`;
                    if (classUnavailability[key]) {
                        availabilityConflicts.push('Class');
                    }
                });

                // Check subject unavailability
                subjectIds.forEach(subjectId => {
                    const key = `${subjectId}:${dayNum}:${periodId}`;
                    if (subjectUnavailability[key]) {
                        availabilityConflicts.push('Subject');
                    }
                });

                // Check room unavailability
                roomIds.forEach(roomId => {
                    const key = `${roomId}:${dayNum}:${periodId}`;
                    if (roomUnavailability[key]) {
                        availabilityConflicts.push('Room');
                    }
                });

                // Mark with green border and show conflict details if any entity is unavailable
                if (availabilityConflicts.length > 0) {
                    card.classList.add('has-availability-conflict');

                    // Add conflict indicator at the bottom of the card
                    const uniqueConflicts = [...new Set(availabilityConflicts)];
                    const conflictDiv = document.createElement('div');
                    conflictDiv.className = 'availability-conflict-indicator';
                    conflictDiv.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> ${uniqueConflicts.join(', ')} unavailable`;
                    card.appendChild(conflictDiv);
                }
            });

            return conflictMap;
        }

        // Hover behavior for conflicts
        let conflictMap = null;

        function setupConflictHover() {
            conflictMap = detectConflicts();

            document.querySelectorAll('.lesson-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    if (this.classList.contains('has-conflict') && conflictMap.has(this)) {
                        const relatedCards = conflictMap.get(this);

                        // Dim all cards except conflicting ones
                        document.querySelectorAll('.lesson-card').forEach(c => {
                            if (!relatedCards.has(c) && c !== this) {
                                c.classList.add('conflict-dimmed');
                            }
                        });

                        // Highlight related conflicting cards
                        relatedCards.forEach(relatedCard => {
                            relatedCard.classList.add('conflict-related');
                        });
                    }
                });

                card.addEventListener('mouseleave', function() {
                    // Remove all hover effects
                    document.querySelectorAll('.lesson-card').forEach(c => {
                        c.classList.remove('conflict-dimmed');
                        c.classList.remove('conflict-related');
                    });
                });
            });
        }

        // ============================================
        // Lesson Selection Functionality
        // ============================================
        // (Moved to Multi-Section Workflow section below to include count updates)

        // Initialize tooltips and set default compact mode on page load
        setDisplayMode('compact');
        initializeTooltips();

        // Setup conflict detection and hover behavior
        setupConflictHover();

        // ============================================
        // Multi-Section Workflow: Selection Management
        // ============================================

        let selectedLessonsCount = 0;
        const moveToButton = document.getElementById('moveToButton');
        const selectedLessonsCountEl = document.getElementById('selectedLessonsCount');

        // Update selection count and enable/disable Section 2
        function updateSelectionCount() {
            const selectedLessons = document.querySelectorAll('.lesson-card.selected');
            selectedLessonsCount = selectedLessons.length;

            // Update count display
            selectedLessonsCountEl.textContent = `(${selectedLessonsCount} lesson${selectedLessonsCount !== 1 ? 's' : ''} selected)`;

            // Enable Section 2 (Move To) only if exactly 1 lesson is selected
            if (selectedLessonsCount === 1) {
                moveToButton.disabled = false;
                moveToButton.classList.remove('text-muted');
            } else {
                moveToButton.disabled = true;
                moveToButton.classList.add('text-muted');
            }
        }

        // Override the existing select button click handler to update count
        document.querySelectorAll('.select-lesson-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();

                const scheduledId = this.dataset.scheduledId;
                const lessonCard = this.closest('.lesson-card');

                // Hide tooltip if it's showing
                const tooltip = bootstrap.Tooltip.getInstance(lessonCard);
                if (tooltip) {
                    tooltip.hide();
                }

                // Check if this lesson is currently selected
                const isCurrentlySelected = lessonCard.classList.contains('selected');

                // SINGLE SELECTION: Deselect all other lessons first
                document.querySelectorAll('.lesson-card.selected').forEach(selectedCard => {
                    if (selectedCard !== lessonCard) {
                        selectedCard.classList.remove('selected');
                        // Update icons for the deselected lesson
                        selectedCard.querySelectorAll('.select-lesson-btn').forEach(selectBtn => {
                            const icon = selectBtn.querySelector('i');
                            icon.classList.remove('bi-check-circle-fill');
                            icon.classList.add('bi-circle');
                        });
                    }
                });

                // Toggle selection for the clicked lesson
                lessonCard.classList.toggle('selected');

                // Update all select buttons for this lesson (both detailed and compact views)
                const allSelectBtns = lessonCard.querySelectorAll('.select-lesson-btn');
                allSelectBtns.forEach(selectBtn => {
                    const icon = selectBtn.querySelector('i');
                    if (lessonCard.classList.contains('selected')) {
                        icon.classList.remove('bi-circle');
                        icon.classList.add('bi-check-circle-fill');
                    } else {
                        icon.classList.remove('bi-check-circle-fill');
                        icon.classList.add('bi-circle');
                    }
                });

                // Update selection count
                updateSelectionCount();
            });
        });

        // Initialize count on page load
        updateSelectionCount();

        // ============================================
        // Section 2: Destination Slot Selection (Single Selection)
        // ============================================

        const avoidSelectedButton = document.getElementById('avoidSelectedButton');
        const collapseAvoidSelected = document.getElementById('collapseAvoidSelected');

        // Function to update Section 3 state based on Section 2 selection
        function updateAvoidSelectedSectionState() {
            const destinationSlot = document.querySelector('.destination-slot.selected');

            if (destinationSlot) {
                // Destination is selected - disable Section 3
                avoidSelectedButton.disabled = true;
                avoidSelectedButton.classList.add('text-muted');

                // Close Section 3 if it's open
                if (collapseAvoidSelected.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(collapseAvoidSelected, { toggle: false });
                    bsCollapse.hide();
                }

                // Clear all selections in Section 3
                document.querySelectorAll('.avoid-selected-slot.selected').forEach(slot => {
                    slot.classList.remove('selected');
                });
            } else {
                // No destination selected - enable Section 3
                avoidSelectedButton.disabled = false;
                avoidSelectedButton.classList.remove('text-muted');
            }
        }

        document.querySelectorAll('.destination-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                // If this slot is already selected, deselect it
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                } else {
                    // Deselect all other destination slots (only one can be selected)
                    document.querySelectorAll('.destination-slot').forEach(s => {
                        s.classList.remove('selected');
                    });

                    // Select this slot
                    this.classList.add('selected');
                }

                // Update Section 3 state
                updateAvoidSelectedSectionState();
            });
        });

        // Initialize Section 3 state on page load
        updateAvoidSelectedSectionState();

        // ============================================
        // Section 3: Avoid Selected Lessons Slots (Multiple Selection)
        // ============================================

        document.querySelectorAll('.avoid-selected-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                // Toggle selection (multiple slots can be selected)
                this.classList.toggle('selected');
            });
        });

        // Clear all avoidance slots for selected lessons
        document.getElementById('clearAvoidSelectedBtn').addEventListener('click', function() {
            document.querySelectorAll('.avoid-selected-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
        });

        // ============================================
        // Section 4: Avoid Unlocked Lessons Slots (Multiple Selection)
        // ============================================

        document.querySelectorAll('.avoid-unlocked-slot').forEach(slot => {
            slot.addEventListener('click', function() {
                // Toggle selection (multiple slots can be selected)
                this.classList.toggle('selected');
            });
        });

        // Clear all avoidance slots for unlocked lessons
        document.getElementById('clearAvoidUnlockedBtn').addEventListener('click', function() {
            document.querySelectorAll('.avoid-unlocked-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
        });

        // ============================================
        // Generate Options Button - Show Confirmation Modal
        // ============================================

        // Helper function to get period name from period ID
        function getPeriodName(periodId) {
            const periodCell = document.querySelector(`[data-period-id="${periodId}"]`)?.closest('tr')?.querySelector('td.fw-bold');
            if (periodCell) {
                const name = periodCell.querySelector('div')?.textContent?.trim();
                const time = periodCell.querySelector('small')?.textContent?.trim();
                return `${name} (${time})`;
            }
            return `Period ${periodId}`;
        }

        // Helper function to format slot list
        function formatSlotList(slots) {
            if (slots.length === 0) {
                return '<p class="text-muted mb-0"><i class="bi bi-dash-circle"></i> None</p>';
            }
            return '<ul class="mb-0">' +
                slots.map(slot => `<li><strong>${slot.day}</strong> - ${getPeriodName(slot.periodId)}</li>`).join('') +
                '</ul>';
        }

        document.getElementById('generateOptionsBtn').addEventListener('click', function() {
            // Get selected lesson cards with full details
            const selectedLessonCards = Array.from(document.querySelectorAll('.lesson-card.selected'));

            if (selectedLessonCards.length === 0) {
                alert('Please select at least one lesson to move.');
                return;
            }

            // Build detailed lesson information
            let lessonsHtml = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0">';
            lessonsHtml += '<thead class="table-light"><tr><th>#</th><th>Day</th><th>Period</th><th>Subject(s)</th><th>Teacher(s)</th><th>Class(es)</th><th>Room(s)</th><th>Status</th></tr></thead><tbody>';

            selectedLessonCards.forEach((card, index) => {
                const scheduledId = card.querySelector('[data-scheduled-id]')?.dataset.scheduledId || 'N/A';
                const subjects = card.dataset.subject || 'N/A';
                const teachers = card.dataset.teacher || 'N/A';
                const classes = card.dataset.class || 'N/A';
                const rooms = card.dataset.rooms || 'N/A';
                const isLocked = card.classList.contains('locked-lesson');

                // Get day and period from parent cell
                const cell = card.closest('td');
                const row = cell?.closest('tr');
                const dayIndex = row ? Array.from(row.children).indexOf(cell) - 1 : -1;
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday'];
                const day = dayIndex >= 0 && dayIndex < days.length ? days[dayIndex] : 'Unknown';

                const periodCell = row?.querySelector('td.fw-bold');
                const periodName = periodCell?.querySelector('div')?.textContent?.trim() || 'Unknown';
                const periodTime = periodCell?.querySelector('small')?.textContent?.trim() || '';

                lessonsHtml += `<tr>
                    <td>${index + 1}</td>
                    <td><strong>${day}</strong></td>
                    <td>${periodName}<br><small class="text-muted">${periodTime}</small></td>
                    <td>${subjects.replace(/\|/g, ', ')}</td>
                    <td>${teachers.replace(/\|/g, ', ')}</td>
                    <td>${classes.replace(/\|/g, ', ')}</td>
                    <td>${rooms.replace(/\|/g, ', ')}</td>
                    <td>${isLocked ? '<span class="badge bg-warning text-dark"><i class="bi bi-lock-fill"></i> Locked</span>' : '<span class="badge bg-success"><i class="bi bi-unlock-fill"></i> Unlocked</span>'}</td>
                </tr>`;
            });

            lessonsHtml += '</tbody></table></div>';
            document.getElementById('confirm-selected-lessons').innerHTML = lessonsHtml;

            // Get destination slot (if any)
            const destinationSlot = document.querySelector('.destination-slot.selected');
            let destinationHtml;
            if (destinationSlot) {
                const day = destinationSlot.dataset.day;
                const periodId = destinationSlot.dataset.periodId;
                destinationHtml = `<p class="mb-0"><i class="bi bi-geo-alt-fill text-primary"></i> <strong>${day}</strong> - ${getPeriodName(periodId)}</p>`;
            } else {
                destinationHtml = '<p class="text-muted mb-0"><i class="bi bi-dash-circle"></i> No specific destination selected (algorithm will find best slots)</p>';
            }
            document.getElementById('confirm-destination').innerHTML = destinationHtml;

            // Get avoid slots for selected lessons
            const avoidSelectedSlots = Array.from(document.querySelectorAll('.avoid-selected-slot.selected'))
                .map(slot => ({
                    day: slot.dataset.day,
                    periodId: slot.dataset.periodId
                }));
            document.getElementById('confirm-avoid-selected').innerHTML = formatSlotList(avoidSelectedSlots);

            // Get avoid slots for unlocked lessons
            const avoidUnlockedSlots = Array.from(document.querySelectorAll('.avoid-unlocked-slot.selected'))
                .map(slot => ({
                    day: slot.dataset.day,
                    periodId: slot.dataset.periodId
                }));
            document.getElementById('confirm-avoid-unlocked').innerHTML = formatSlotList(avoidUnlockedSlots);

            // Show the modal
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmGenerateModal'));
            confirmModal.show();
        });

        // Handle debug button - opens debug page in new tab
        document.getElementById('debugGenerateBtn').addEventListener('click', function() {
            // Get configuration values
            const selectedAlgorithm = document.getElementById('algorithmSelection').value || 'kempe-chain';
            const maxUnfixedLessons = parseInt(document.getElementById('maxUnfixedLessons').value) || 4;
            const maxTimeMinutes = parseInt(document.getElementById('maxTimeMinutes').value) || 3;

            // Get substitution mode
            const substitutionMode = document.getElementById('substitutionModeCheckbox').checked;

            // Get ignored constraints
            const ignoredConstraints = Array.from(document.querySelectorAll('.constraint-ignore-checkbox:checked'))
                .map(checkbox => checkbox.value);

            // Get all selections
            const selectedLessonIds = Array.from(document.querySelectorAll('.lesson-card.selected'))
                .map(card => parseInt(card.querySelector('[data-scheduled-id]')?.dataset.scheduledId))
                .filter(id => !isNaN(id));

            if (selectedLessonIds.length === 0) {
                alert('Please select at least one lesson to debug.');
                return;
            }

            const destinationSlot = document.querySelector('.destination-slot.selected');
            const destination = destinationSlot ? {
                day: destinationSlot.dataset.day,
                periodId: parseInt(destinationSlot.dataset.periodId)
            } : null;

            const avoidSelectedSlots = Array.from(document.querySelectorAll('.avoid-selected-slot.selected'))
                .map(slot => `${slot.dataset.day},${slot.dataset.periodId}`)
                .join(';');

            const avoidUnlockedSlots = Array.from(document.querySelectorAll('.avoid-unlocked-slot.selected'))
                .map(slot => `${slot.dataset.day},${slot.dataset.periodId}`)
                .join(';');

            // Build query string for debug page
            const params = new URLSearchParams({
                timetableId: timetableId,
                selectedLessonIds: selectedLessonIds.join(','),
                algorithm: selectedAlgorithm,
                maxDepth: maxUnfixedLessons,
                maxTimeMinutes: maxTimeMinutes,
                ignoredConstraints: ignoredConstraints.join(','),
                destinationDay: destination?.day || '',
                destinationPeriodId: destination?.periodId || '',
                avoidSlotsSelected: avoidSelectedSlots,
                avoidSlotsUnlocked: avoidUnlockedSlots,
                substitutionMode: substitutionMode
            });

            // Open result page in new tab (keep modal open)
            window.open(`/Admin/Timetables/LessonMoveResult?${params.toString()}`, '_blank');
        });

        // Handle stop button
        document.getElementById('stopGenerationBtn').addEventListener('click', async function() {
            if (!currentSessionId) return;

            try {
                const response = await fetch('?handler=StopGeneration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ sessionId: currentSessionId })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('statusMessage').textContent = 'Stopping generation...';
                }
            } catch (error) {
                console.error('Stop error:', error);
            }
        });

        // Format time in seconds to human-readable format
        function formatTime(seconds) {
            if (seconds < 1) return '< 1s';
            if (seconds < 60) return Math.round(seconds) + 's';

            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);

            if (minutes < 60) {
                return remainingSeconds > 0
                    ? `${minutes}m ${remainingSeconds}s`
                    : `${minutes}m`;
            }

            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return remainingMinutes > 0
                ? `${hours}h ${remainingMinutes}m`
                : `${hours}h`;
        }

        // Generate unique session ID
        function generateSessionId() {
            return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Setup SignalR connection for progress updates
        async function setupProgressConnection(sessionId) {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/timetableGeneration")
                .withAutomaticReconnect()
                .build();

            // Track progress for remaining time calculation
            let progressStartTime = Date.now();
            let lastUpdateTime = Date.now();
            let lastOptionsCount = 0;

            connection.on("ProgressUpdate", (optionsGenerated, combinationsExplored, elapsedSeconds, statusMessage) => {
                const now = Date.now();

                // Update basic stats
                document.getElementById('optionsFoundCount').textContent = optionsGenerated;
                document.getElementById('combinationsCount').textContent = combinationsExplored;
                document.getElementById('elapsedTime').textContent = formatTime(elapsedSeconds);
                document.getElementById('statusMessage').textContent = statusMessage;

                // Calculate progress percentage based on time
                const maxTime = parseInt(document.getElementById('maxTimeMinutes').value) || 5;
                const maxTimeSeconds = maxTime * 60;
                const timeProgress = Math.min(100, (elapsedSeconds / maxTimeSeconds) * 100);

                // Update progress bar
                document.getElementById('generationProgress').style.width = timeProgress + '%';
                document.getElementById('progressPercentage').textContent = `(${Math.round(timeProgress)}%)`;

                // Show percentage in progress bar if > 5%
                if (timeProgress > 5) {
                    document.getElementById('progressBarText').textContent = `${Math.round(timeProgress)}%`;
                }

                // Calculate remaining time
                const remainingSeconds = maxTimeSeconds - elapsedSeconds;
                const remainingTimeEl = document.getElementById('remainingTime');

                if (remainingSeconds > 0) {
                    remainingTimeEl.textContent = formatTime(remainingSeconds);
                    remainingTimeEl.className = 'text-info';
                } else {
                    remainingTimeEl.textContent = 'Finishing...';
                    remainingTimeEl.className = 'text-warning';
                }

                // Show generation rate if options are being found
                if (optionsGenerated > 0 && elapsedSeconds > 0) {
                    const rate = optionsGenerated / elapsedSeconds;
                    if (rate > 0.01) {
                        const rateText = rate >= 1
                            ? `${rate.toFixed(1)} options/sec`
                            : `${(60 * rate).toFixed(1)} options/min`;
                        document.getElementById('statusMessage').innerHTML =
                            statusMessage + ` <span class="badge bg-info">${rateText}</span>`;
                    }
                }

                lastUpdateTime = now;
                lastOptionsCount = optionsGenerated;
            });

            await connection.start();
            generationConnection = connection;

            // Join the session group
            await connection.invoke("JoinSession", sessionId);
        }

        // Display results as list of saved timetables
        function displayResults(options, count) {
            if (count === 0) {
                alert('No valid options found. Try adjusting your constraints.');
                return;
            }

            generatedOptions = options; // Store globally for reference
            const container = document.getElementById('resultsContainer');

            // Create simple list with batch operation buttons
            let html = `
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllOptions">
                            <i class="bi bi-check-square"></i> Select All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="selectNoneOptions">
                            <i class="bi bi-square"></i> Select None
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteSelectedOptions">
                            <i class="bi bi-trash"></i> Delete Selected
                        </button>
                    </div>
                    <span class="text-muted" id="selectedCountDisplay">0 selected</span>
                </div>
                <div class="list-group">
            `;

            options.forEach((option, index) => {
                html += `
                    <div class="list-group-item" data-option-index="${index}">
                        <div class="d-flex align-items-start mb-2">
                            <input type="checkbox" class="form-check-input me-3 mt-1 option-checkbox"
                                   data-option-index="${index}"
                                   data-timetable-id="${option.timetableId}"
                                   style="cursor: pointer;">
                            <div class="flex-grow-1">
                                <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">
                                        <i class="bi bi-calendar3"></i> Option ${option.optionNumber}
                                    </h5>
                                    <div>
                                        <span class="badge bg-primary">Quality: ${option.qualityScore.toFixed(2)}</span>
                                        <span class="badge bg-info">${option.totalMovedLessons} lessons moved</span>
                                        <span class="badge bg-warning">${option.unfixedLessonsMoved} unfixed</span>
                                    </div>
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="/Admin/Timetables/Edit?id=${option.timetableId}" target="_blank" class="btn btn-sm btn-primary">
                                        <i class="bi bi-eye"></i> View Timetable
                                    </a>
                                    <button class="btn btn-sm btn-info compare-option-btn" data-timetable-id="${option.timetableId}">
                                        <i class="bi bi-columns-gap"></i> Compare to Original
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-option-btn" data-timetable-id="${option.timetableId}" data-option-number="${option.optionNumber}">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>

                                <!-- Movements Table -->
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#movementsTable${index}" aria-expanded="false">
                                        <i class="bi bi-table"></i> Show Movements (${option.movements.length})
                                    </button>
                                    <div class="collapse mt-2" id="movementsTable${index}">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Scheduled Lesson ID</th>
                                                        <th>Lesson ID</th>
                                                        <th>Lesson</th>
                                                        <th>From</th>
                                                        <th>To</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${option.movements.map(m => `
                                                        <tr class="${m.isSelectedLesson ? 'table-primary' : ''}">
                                                            <td>${m.scheduledLessonId}</td>
                                                            <td>${m.lessonId}</td>
                                                            <td>${m.lessonDescription}</td>
                                                            <td>${m.from.day} - ${m.from.periodName}</td>
                                                            <td>${m.to.day} - ${m.to.periodName}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;

            // Show results modal
            const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resultsModal.show();

            // Initialize event listeners
            initializeOptionButtons();
            initializeBatchOperations();
        }

        /* COMMENTED OUT - Accordion code (not currently in use)
        // Create accordion item for each option with full timetable
        function createOptionAccordion(option, index) {
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            accordionItem.dataset.optionIndex = index;

            const headerId = `headingOption${index}`;
            const collapseId = `collapseOption${index}`;
            const isFirst = index === 0;

            accordionItem.innerHTML = `
                <h2 class="accordion-header" id="${headerId}">
                    <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                            aria-expanded="${isFirst}" aria-controls="${collapseId}">
                        <strong>Option ${option.optionNumber}</strong>
                        <span class="badge bg-light text-dark ms-2">Quality: ${option.qualityScore.toFixed(2)}</span>
                        <span class="badge bg-warning text-dark ms-2">${option.unfixedLessonsMoved} unfixed moved</span>
                        <span class="badge bg-danger ms-2">${option.softViolationCount} soft violations</span>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                     aria-labelledby="${headerId}" data-bs-parent="#resultsAccordion">
                    <div class="accordion-body">
                        ${createOptionContent(option, index)}
                    </div>
                </div>
            `;

            return accordionItem;
        }

        // Create content for each option (timetable + controls)
        function createOptionContent(option, index) {
            const movements = createMovementsMap(option.movements);
            const requestedLessonIds = new Set(
                option.movements.filter(m => m.isSelectedLesson).map(m => m.scheduledLessonId)
            );
            const movedLessonIds = new Set(
                option.movements.filter(m => !m.isSelectedLesson).map(m => m.scheduledLessonId)
            );

            // Build timetable HTML
            const timetableHtml = buildTimetableGrid(option.timetableState, movements, requestedLessonIds, movedLessonIds, index);

            return `
                <!-- Controls -->
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm save-option-btn" data-option-index="${index}">
                                    <i class="bi bi-floppy"></i> Save as Timetable
                                </button>
                                <button class="btn btn-info btn-sm compare-option-btn" data-option-index="${index}">
                                    <i class="bi bi-arrows-expand"></i> Save Temporarily and Compare to Initial
                                </button>
                            </div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Display mode">
                                <input type="radio" class="btn-check" name="displayMode${index}"
                                       id="displayModeDetailed${index}" value="detailed" checked autocomplete="off">
                                <label class="btn btn-outline-primary" for="displayModeDetailed${index}">
                                    <i class="bi bi-card-text"></i> Detailed
                                </label>
                                <input type="radio" class="btn-check" name="displayMode${index}"
                                       id="displayModeCompact${index}" value="compact" autocomplete="off">
                                <label class="btn btn-outline-primary" for="displayModeCompact${index}">
                                    <i class="bi bi-dash-square"></i> Compact
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtering -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-funnel"></i> <strong>Filter Lessons</strong>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="filters${index}">
                            <div class="col-md-3">
                                <select class="form-select form-select-sm filter-select" data-filter-type="teacher" data-option-index="${index}">
                                    <option value="">-- All Teachers --</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm filter-select" data-filter-type="subject" data-option-index="${index}">
                                    <option value="">-- All Subjects --</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm filter-select" data-filter-type="class" data-option-index="${index}">
                                    <option value="">-- All Classes --</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm filter-select" data-filter-type="room" data-option-index="${index}">
                                    <option value="">-- All Rooms --</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-secondary clear-filters-btn" data-option-index="${index}">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </button>
                            <span class="match-count ms-2 text-muted" id="matchCount${index}"></span>
                        </div>
                    </div>
                </div>

                <!-- Timetable -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <strong>Timetable Grid - Option ${option.optionNumber}</strong>
                    </div>
                    <div class="card-body p-0">
                        ${timetableHtml}
                    </div>
                </div>

                ${option.softViolations.length > 0 ? `
                    <div class="alert alert-warning mt-3">
                        <strong>Soft Constraint Violations:</strong>
                        <ul class="mb-0">
                            ${option.softViolations.map(v => `<li>${v}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        // Create movements map for quick lookup
        function createMovementsMap(movements) {
            const map = new Map();
            movements.forEach(m => {
                const fromKey = `${m.from.day}_${m.from.periodId}`;
                const toKey = `${m.to.day}_${m.to.periodId}`;

                map.set(m.scheduledLessonId, {
                    fromDay: m.from.day,
                    fromPeriodId: m.from.periodId,
                    fromPeriodName: m.from.periodName,
                    toDay: m.to.day,
                    toPeriodId: m.to.periodId,
                    toPeriodName: m.to.periodName,
                    isSelected: m.isSelectedLesson
                });
            });
            return map;
        }

        // Build full timetable grid
        function buildTimetableGrid(timetableState, movements, requestedLessonIds, movedLessonIds, optionIndex) {
            let html = '<div class="table-responsive"><table class="table table-bordered mb-0 option-timetable" data-option-index="' + optionIndex + '">';

            // Header
            html += '<thead class="table-light"><tr><th style="width: 150px;">Time / Day</th>';
            days.forEach(day => {
                html += `<th class="text-center">${day}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Body
            periods.forEach(period => {
                html += `<tr><td class="fw-bold bg-light">
                    <div>${period.name}</div>
                    <small class="text-muted">${period.startTime} - ${period.endTime}</small>
                </td>`;

                days.forEach(day => {
                    const slotKey = `${day}_${period.id}`;
                    const slotContent = timetableState[slotKey];

                    html += '<td style="min-height: 100px; vertical-align: top; padding: 8px;">';

                    if (slotContent && slotContent.lessons && slotContent.lessons.length > 0) {
                        slotContent.lessons.forEach(lesson => {
                            html += buildLessonCard(lesson, movements, requestedLessonIds, movedLessonIds, optionIndex);
                        });
                    } else {
                        html += '<div class="text-muted text-center py-3"><small>Empty</small></div>';
                    }

                    html += '</td>';
                });

                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }

        // Build lesson card with highlighting
        function buildLessonCard(lesson, movements, requestedLessonIds, movedLessonIds, optionIndex) {
            const isRequested = requestedLessonIds.has(lesson.scheduledLessonId);
            const isMoved = movedLessonIds.has(lesson.scheduledLessonId);
            const movement = movements.get(lesson.scheduledLessonId);

            let highlightClass = '';
            let highlightStyle = '';
            let hoverData = '';

            if (isRequested) {
                highlightClass = 'requested-lesson';
                highlightStyle = 'background-color: #c3f0ca !important;'; // Light green
                if (movement) {
                    hoverData = `data-old-day="${movement.fromDay}" data-old-period="${movement.fromPeriodName}"`;
                }
            } else if (isMoved) {
                highlightClass = 'moved-lesson';
                highlightStyle = 'background-color: #b3d9ff !important;'; // Light blue
                if (movement) {
                    hoverData = `data-old-day="${movement.fromDay}" data-old-period="${movement.fromPeriodName}"`;
                }
            }

            const subjectDisplay = lesson.subjects.join(' / ');
            const teacherDisplay = lesson.teachers.join(' + ');
            const classDisplay = lesson.classes.join(' + ');
            const roomDisplay = lesson.rooms.length > 0 ? lesson.rooms.join(', ') : 'No room';

            const isCoTeaching = lesson.teachers.length > 1;
            const isMultiSubject = lesson.subjects.length > 1;
            const isMultiRoom = lesson.rooms.length > 1;
            const isMultiClass = lesson.classes.length > 1;

            const borderWidth = isCoTeaching ? '6px' : '4px';

            return `
                <div class="lesson-card result-lesson-card ${highlightClass} mb-2 position-relative"
                     ${hoverData}
                     data-subject="${lesson.subjects.join('|')}"
                     data-class="${lesson.classes.join('|')}"
                     data-teacher="${lesson.teachers.join('|')}"
                     data-room="${lesson.rooms.join('|')}"
                     data-option-index="${optionIndex}"
                     style="${highlightStyle} border-left: ${borderWidth} solid #333; border-radius: 4px; padding: 8px;">

                    ${lesson.isLocked ? `
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark"
                              style="font-size: 0.6rem; padding: 2px 4px;">
                            <i class="bi bi-lock-fill"></i>
                        </span>
                    ` : ''}

                    <!-- Detailed View -->
                    <div class="lesson-detailed-view">
                        ${(isCoTeaching || isMultiSubject || isMultiRoom || isMultiClass) ? `
                            <div class="mb-1">
                                ${isCoTeaching ? '<span class="badge badge-coteaching"><i class="bi bi-people-fill"></i></span> ' : ''}
                                ${isMultiSubject ? '<span class="badge badge-multisubject"><i class="bi bi-book-half"></i></span> ' : ''}
                                ${isMultiRoom ? '<span class="badge badge-multiroom"><i class="bi bi-door-open-fill"></i></span> ' : ''}
                                ${isMultiClass ? '<span class="badge badge-multiclass"><i class="bi bi-people"></i></span> ' : ''}
                            </div>
                        ` : ''}
                        <div class="fw-bold">${subjectDisplay}</div>
                        <small class="d-block">${classDisplay}</small>
                        <small class="d-block">${teacherDisplay}</small>
                        <small class="d-block"><i class="bi bi-door-closed"></i> ${roomDisplay}</small>
                    </div>

                    <!-- Compact View (hidden by default) -->
                    <div class="lesson-compact-view" style="display: none;">
                        <span class="fw-bold" style="font-size: 0.85rem;">
                            ${subjectDisplay} · ${classDisplay}
                        </span>
                    </div>
                </div>
            `;
        }

        // Initialize result timetables (event listeners, filters, etc.)
        function initializeResultTimetables() {
            // Display mode toggles
            document.querySelectorAll('input[name^="displayMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const optionIndex = this.name.replace('displayMode', '');
                    const mode = this.value;
                    const timetable = document.querySelector(`.option-timetable[data-option-index="${optionIndex}"]`);

                    if (timetable) {
                        const cards = timetable.querySelectorAll('.result-lesson-card');
                        cards.forEach(card => {
                            const detailedView = card.querySelector('.lesson-detailed-view');
                            const compactView = card.querySelector('.lesson-compact-view');

                            if (mode === 'compact') {
                                detailedView.style.display = 'none';
                                compactView.style.display = 'block';
                            } else {
                                detailedView.style.display = 'block';
                                compactView.style.display = 'none';
                            }
                        });
                    }
                });
            });

            // Populate filter dropdowns
            generatedOptions.forEach((option, index) => {
                populateFiltersForOption(option, index);
            });

            // Filter change listeners
            document.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', function() {
                    const optionIndex = this.dataset.optionIndex;
                    applyFiltersForOption(optionIndex);
                });
            });

            // Clear filters buttons
            document.querySelectorAll('.clear-filters-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const optionIndex = this.dataset.optionIndex;
                    clearFiltersForOption(optionIndex);
                });
            });

            // No longer needed - buttons are replaced with new approach
        }
        END OF COMMENTED OUT ACCORDION CODE */

        // Initialize event listeners for option buttons
        function initializeOptionButtons() {
            // Compare buttons
            document.querySelectorAll('.compare-option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const optionTimetableId = this.dataset.timetableId;
                    compareToOriginal(optionTimetableId);
                });
            });

            // Delete buttons
            document.querySelectorAll('.delete-option-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const optionTimetableId = this.dataset.timetableId;
                    const optionNumber = this.dataset.optionNumber;
                    await deleteOption(optionTimetableId, optionNumber);
                });
            });
        }

        // Initialize batch operation buttons
        function initializeBatchOperations() {
            // Update selected count display
            function updateSelectedCount() {
                const checkboxes = document.querySelectorAll('.option-checkbox');
                const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                document.getElementById('selectedCountDisplay').textContent = `${checkedCount} selected`;
            }

            // Checkbox change handler
            document.querySelectorAll('.option-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });

            // Select All button
            document.getElementById('selectAllOptions').addEventListener('click', function() {
                document.querySelectorAll('.option-checkbox').forEach(cb => cb.checked = true);
                updateSelectedCount();
            });

            // Select None button
            document.getElementById('selectNoneOptions').addEventListener('click', function() {
                document.querySelectorAll('.option-checkbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            });

            // Delete Selected button
            document.getElementById('deleteSelectedOptions').addEventListener('click', async function() {
                const selectedCheckboxes = Array.from(document.querySelectorAll('.option-checkbox:checked'));

                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one option to delete.');
                    return;
                }

                // Single confirmation for all selected options
                if (!confirm(`Are you sure you want to delete ${selectedCheckboxes.length} selected option(s)? This action cannot be undone.`)) {
                    return;
                }

                // Collect timetable IDs
                const timetableIds = selectedCheckboxes.map(cb => parseInt(cb.dataset.timetableId));

                try {
                    // Delete all selected options in one API call (no individual confirmations)
                    const response = await fetch('/Admin/Timetables/MoveLessons?handler=DeleteMultipleOptions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify({
                            timetableIds: timetableIds
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert(`Successfully deleted ${result.deletedCount} option(s)`);

                        // Remove deleted options from UI and global array
                        selectedCheckboxes.forEach(checkbox => {
                            const accordionItem = checkbox.closest('.accordion-item');
                            if (accordionItem) {
                                accordionItem.remove();
                            }
                        });

                        // Update global array - remove deleted options
                        generatedOptions = generatedOptions.filter(opt => !timetableIds.includes(opt.timetableId));

                        updateSelectedCount();

                        // Close modal if no options left
                        if (generatedOptions.length === 0) {
                            const resultsModal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
                            resultsModal.hide();
                            alert('All options have been deleted.');
                        }
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error deleting options: ${error.message}`);
                }
            });
        }

        // Compare option to original timetable
        function compareToOriginal(optionTimetableId) {
            const compareUrl = `/Admin/Timetables/Compare?ids=${timetableId}&ids=${optionTimetableId}`;
            window.open(compareUrl, '_blank');
        }

        // Delete an option timetable
        async function deleteOption(optionTimetableId, optionNumber) {
            if (!confirm(`Are you sure you want to delete Option ${optionNumber}?`)) {
                return;
            }

            try {
                const response = await fetch(`/Admin/Timetables/MoveLessons?handler=DeleteOption`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ timetableId: optionTimetableId })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Option ${optionNumber} deleted successfully`);
                    // Remove from UI
                    const button = document.querySelector(`button[data-timetable-id="${optionTimetableId}"]`);
                    if (button) {
                        button.closest('.list-group-item').remove();
                    }

                    // Remove from global array
                    generatedOptions = generatedOptions.filter(o => o.timetableId !== optionTimetableId);

                    // Close modal if no options left
                    if (generatedOptions.length === 0) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
                        modal.hide();
                        alert('All options have been deleted.');
                    }
                } else {
                    alert(`Error deleting option: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Populate filters for an option
        function populateFiltersForOption(option, index) {
            const teachers = new Set();
            const subjects = new Set();
            const classes = new Set();
            const rooms = new Set();

            Object.values(option.timetableState).forEach(slot => {
                if (slot.lessons) {
                    slot.lessons.forEach(lesson => {
                        lesson.teachers.forEach(t => teachers.add(t));
                        lesson.subjects.forEach(s => subjects.add(s));
                        lesson.classes.forEach(c => classes.add(c));
                        lesson.rooms.forEach(r => rooms.add(r));
                    });
                }
            });

            const filterContainer = document.querySelector(`#filters${index}`);
            const teacherSelect = filterContainer.querySelector('[data-filter-type="teacher"]');
            const subjectSelect = filterContainer.querySelector('[data-filter-type="subject"]');
            const classSelect = filterContainer.querySelector('[data-filter-type="class"]');
            const roomSelect = filterContainer.querySelector('[data-filter-type="room"]');

            [...teachers].sort().forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                teacherSelect.appendChild(option);
            });

            [...subjects].sort().forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                subjectSelect.appendChild(option);
            });

            [...classes].sort().forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                classSelect.appendChild(option);
            });

            [...rooms].sort().forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                roomSelect.appendChild(option);
            });
        }

        // Apply filters for an option
        function applyFiltersForOption(optionIndex) {
            const filterContainer = document.querySelector(`#filters${optionIndex}`);
            const teacher = filterContainer.querySelector('[data-filter-type="teacher"]').value;
            const subject = filterContainer.querySelector('[data-filter-type="subject"]').value;
            const clazz = filterContainer.querySelector('[data-filter-type="class"]').value;
            const room = filterContainer.querySelector('[data-filter-type="room"]').value;

            const hasFilters = teacher || subject || clazz || room;
            const timetable = document.querySelector(`.option-timetable[data-option-index="${optionIndex}"]`);
            const cards = timetable.querySelectorAll('.result-lesson-card');
            let matchCount = 0;

            cards.forEach(card => {
                const cardTeachers = (card.dataset.teacher || '').split('|');
                const cardSubjects = (card.dataset.subject || '').split('|');
                const cardClasses = (card.dataset.class || '').split('|');
                const cardRooms = (card.dataset.room || '').split('|');

                let matches = true;
                if (teacher && !cardTeachers.includes(teacher)) matches = false;
                if (subject && !cardSubjects.includes(subject)) matches = false;
                if (clazz && !cardClasses.includes(clazz)) matches = false;
                if (room && !cardRooms.includes(room)) matches = false;

                if (hasFilters) {
                    if (matches) {
                        card.classList.add('highlighted');
                        card.classList.remove('dimmed');
                        matchCount++;
                    } else {
                        card.classList.remove('highlighted');
                        card.classList.add('dimmed');
                    }
                } else {
                    card.classList.remove('highlighted', 'dimmed');
                }
            });

            const matchCountEl = document.querySelector(`#matchCount${optionIndex}`);
            if (hasFilters) {
                matchCountEl.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> <strong>${matchCount}</strong> lesson(s) match`;
            } else {
                matchCountEl.innerHTML = '';
            }
        }

        // Clear filters for an option
        function clearFiltersForOption(optionIndex) {
            const filterContainer = document.querySelector(`#filters${optionIndex}`);
            filterContainer.querySelectorAll('.filter-select').forEach(select => select.value = '');
            applyFiltersForOption(optionIndex);
        }

        // Show save dialog - now auto-generates name
        function showSaveDialog(optionIndex) {
            if (!confirm('Save this option as a new timetable?')) {
                return;
            }
            saveOptionAsTimetable(optionIndex);
        }

        // Save option as timetable with auto-generated name
        async function saveOptionAsTimetable(optionIndex) {
            const option = generatedOptions[optionIndex];

            // Auto-generate name: original name + timestamp
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const newName = `${timetableName}_${timestamp}`;

            try {
                const response = await fetch('/Admin/Timetables/MoveLessons?handler=SaveOption', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        baseTimetableId: timetableId,
                        name: newName,
                        movements: option.movements
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Timetable "${newName}" saved successfully with ID: ${result.timetableId}`);
                } else {
                    alert(`Error saving timetable: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Compare option to initial timetable
        async function compareOption(optionIndex) {
            const option = generatedOptions[optionIndex];

            try {
                // Save option temporarily for comparison
                const response = await fetch('/Admin/Timetables/MoveLessons?handler=SaveOptionTemp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        baseTimetableId: timetableId,
                        movements: option.movements,
                        optionNumber: option.optionNumber
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Open compare page in new tab with isTemp parameter
                    const compareUrl = `/Admin/Timetables/Compare?ids=${timetableId}&ids=${result.tempTimetableId}&tempId=${result.tempTimetableId}`;
                    window.open(compareUrl, '_blank');
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Delete All Options functionality
        let currentBaseTimetableId = null;
        let availableOptions = [];

        async function showDeleteAllOptionsModal(baseTimetableId) {
            currentBaseTimetableId = baseTimetableId;
            const modal = new bootstrap.Modal(document.getElementById('deleteAllOptionsModal'));
            modal.show();

            // Show loading, hide content
            document.getElementById('deleteOptionsLoading').style.display = 'block';
            document.getElementById('deleteOptionsContent').style.display = 'none';

            // Load options
            try {
                const response = await fetch(`/Admin/Timetables/MoveLessons?handler=OptionTimetables&baseTimetableId=${baseTimetableId}`);
                const result = await response.json();

                if (result.success) {
                    availableOptions = result.options;
                    displayOptionsForDeletion(result.options);
                } else {
                    alert(`Error loading options: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                document.getElementById('deleteOptionsLoading').style.display = 'none';
                document.getElementById('deleteOptionsContent').style.display = 'block';
            }
        }

        function displayOptionsForDeletion(options) {
            const listContainer = document.getElementById('optionsList');
            const noOptionsMessage = document.getElementById('noOptionsMessage');

            if (!options || options.length === 0) {
                listContainer.style.display = 'none';
                noOptionsMessage.style.display = 'block';
                document.getElementById('confirmDeleteOptionsBtn').disabled = true;
                return;
            }

            noOptionsMessage.style.display = 'none';
            listContainer.style.display = 'block';
            document.getElementById('confirmDeleteOptionsBtn').disabled = false;

            let html = '';
            options.forEach((option, index) => {
                const createdDate = new Date(option.createdDate).toLocaleString();
                html += `
                    <div class="form-check mb-2 p-2 border-bottom">
                        <input class="form-check-input option-checkbox" type="checkbox" value="${option.id}" id="option_${option.id}" checked>
                        <label class="form-check-label w-100" for="option_${option.id}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${option.name}</strong>
                                    <br>
                                    <small class="text-muted">Created: ${createdDate}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${option.notes || ''}</small>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            document.getElementById('selectAllOptions').checked = true;
        }

        function toggleAllOptionsSelection() {
            const selectAll = document.getElementById('selectAllOptions');
            const checkboxes = document.querySelectorAll('.option-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        async function deleteSelectedOptions() {
            const checkboxes = document.querySelectorAll('.option-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('Please select at least one option to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedIds.length} option timetable(s)? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/Admin/Timetables/MoveLessons?handler=DeleteMultipleOptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        timetableIds: selectedIds
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteAllOptionsModal')).hide();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Algorithm selection change handler
        document.getElementById('algorithmSelection')?.addEventListener('change', function() {
            const descriptionSpan = document.getElementById('algorithmDescription');
            if (!descriptionSpan) return;

            if (this.value === 'multi-step-kempe-chain') {
                descriptionSpan.textContent = 'Multi-Step Kempe Chain explores cascading movements across 3+ timeslots for more creative solutions';
            } else if (this.value === 'musical-chairs') {
                descriptionSpan.textContent = 'Musical Chairs finds recursive displacement chains (2-16 steps) where each lesson moves to make room for another';
            } else if (this.value === 'recursive-conflict-resolution') {
                descriptionSpan.textContent = 'Recursive Conflict Resolution handles multiple simultaneous conflicts by recursively finding positions for all conflicting lessons';
            } else {
                descriptionSpan.textContent = 'The Kempe Chain algorithm uses graph-based optimization to find lesson movements with minimal disruption';
            }
        });
    </script>
}
