@page
@model SchedulingSystem.Pages.Admin.Subjects.DetailsModel
@functions {
    /// <summary>
    /// Converts a decimal COLORREF value to hex RGB color code.
    /// Colors stored as Windows COLORREF in BGR format: 0x00BBGGRR
    /// </summary>
    public static string ConvertDecimalColorToHex(string? decimalColor, string defaultColor = "#6c757d")
    {
        if (string.IsNullOrWhiteSpace(decimalColor))
            return defaultColor;

        // If already a hex color, return as-is
        if (decimalColor.StartsWith("#"))
            return decimalColor;

        if (!long.TryParse(decimalColor, out long colorValue))
            return defaultColor;

        // Extract RGB from COLORREF (BGR format: 0x00BBGGRR)
        int r = (int)(colorValue & 0xFF);
        int g = (int)((colorValue >> 8) & 0xFF);
        int b = (int)((colorValue >> 16) & 0xFF);

        return $"#{r:X2}{g:X2}{b:X2}";
    }

    /// <summary>
    /// Determines appropriate foreground color (black or white) based on background luminance.
    /// </summary>
    public static string GetContrastingTextColor(string hexBgColor)
    {
        if (string.IsNullOrWhiteSpace(hexBgColor) || !hexBgColor.StartsWith("#") || hexBgColor.Length < 7)
            return "#FFFFFF";

        try
        {
            int r = Convert.ToInt32(hexBgColor.Substring(1, 2), 16);
            int g = Convert.ToInt32(hexBgColor.Substring(3, 2), 16);
            int b = Convert.ToInt32(hexBgColor.Substring(5, 2), 16);

            // Calculate relative luminance using sRGB formula
            double luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

            return luminance > 0.5 ? "#000000" : "#FFFFFF";
        }
        catch
        {
            return "#FFFFFF";
        }
    }
}
@{
    ViewData["Title"] = "Subject Details";
    var bgColor = ConvertDecimalColorToHex(Model.Subject.BackgroundColor);
    var fgColor = GetContrastingTextColor(bgColor);
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="bi bi-info-circle"></i> Subject Details</h4>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Code</dt>
                        <dd class="col-sm-9">
                            <span class="badge" style="background-color: @bgColor; color: @fgColor; font-size: 1.1em;">@Model.Subject.Code</span>
                        </dd>

                        <dt class="col-sm-3">Name</dt>
                        <dd class="col-sm-9"><strong>@Model.Subject.Name</strong></dd>

                        <dt class="col-sm-3">Category</dt>
                        <dd class="col-sm-9">
                            @if (!string.IsNullOrEmpty(Model.Subject.Category))
                            {
                                <span class="badge bg-secondary">@Model.Subject.Category</span>
                            }
                            else
                            {
                                <span class="text-muted">Not specified</span>
                            }
                        </dd>

                        <dt class="col-sm-3">Default Duration</dt>
                        <dd class="col-sm-9">@Model.Subject.DefaultDuration period(s)</dd>

                        <dt class="col-sm-3">Required Room Type</dt>
                        <dd class="col-sm-9">
                            @if (!string.IsNullOrEmpty(Model.Subject.RequiredRoomType))
                            {
                                @Model.Subject.RequiredRoomType
                            }
                            else
                            {
                                <span class="text-muted">No specific requirement</span>
                            }
                        </dd>

                        @if (!string.IsNullOrEmpty(Model.Subject.Description))
                        {
                            <dt class="col-sm-3">Description</dt>
                            <dd class="col-sm-9">@Model.Subject.Description</dd>
                        }

                        @if (!string.IsNullOrEmpty(Model.Subject.BackgroundColor))
                        {
                            <dt class="col-sm-3">Color</dt>
                            <dd class="col-sm-9">
                                <span class="badge" style="background-color: @bgColor; color: @fgColor;">@bgColor</span>
                                <small class="text-muted ms-2">(stored: @Model.Subject.BackgroundColor)</small>
                            </dd>
                        }
                    </dl>

                    <hr />

                    <h5><i class="bi bi-calendar2-week"></i> Lessons</h5>
                    @if (Model.Subject.LessonSubjects.Count == 0)
                    {
                        <p class="text-muted">No lessons defined for this subject.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Teacher</th>
                                        <th>Frequency/Week</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var lesson in Model.Subject.LessonSubjects.Select(ls => ls.Lesson))
                                    {
                                        <tr>
                                            <td>@lesson?.LessonClasses.FirstOrDefault()?.Class?.Name</td>
                                            <td>@lesson?.LessonTeachers.FirstOrDefault()?.Teacher?.FullName</td>
                                            <td>@lesson?.FrequencyPerWeek times</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <hr />

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Time Constraints</h5>
                        <a asp-page="ManageAvailability" asp-route-id="@Model.Subject.Id" class="btn btn-sm btn-primary">
                            <i class="bi bi-gear"></i> Manage Constraints
                        </a>
                    </div>
                    <p class="text-muted small">Scheduling preferences: Negative = Avoid scheduling, Positive = Try to schedule</p>
                    @if (!Model.Availabilities.Any())
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No availability constraints. Subject can be scheduled at any time by default.
                            <a asp-page="ManageAvailability" asp-route-id="@Model.Subject.Id" class="alert-link">Add constraints if needed</a>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Period</th>
                                        <th>Importance</th>
                                        <th>Reason</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var availability in Model.Availabilities)
                                    {
                                        var (badgeClass, label) = availability.Importance switch
                                        {
                                            3 => ("bg-success", "Try +3 (strongest)"),
                                            2 => ("bg-info", "Try +2 (medium)"),
                                            1 => ("bg-light text-dark", "Try +1 (weakest)"),
                                            0 => ("bg-secondary", "Neutral (0)"),
                                            -1 => ("bg-light text-dark border", "Avoid -1 (weakest)"),
                                            -2 => ("bg-warning text-dark", "Avoid -2 (medium)"),
                                            -3 => ("bg-danger", "Avoid -3 (strongest)"),
                                            _ => ("bg-secondary", "Unknown")
                                        };
                                        <tr>
                                            <td><strong>@availability.DayOfWeek</strong></td>
                                            <td>@availability.Period?.Name</td>
                                            <td>
                                                <span class="badge @badgeClass">@label</span>
                                            </td>
                                            <td>@(availability.Reason ?? "-")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }

                    <div class="mt-4 d-flex justify-content-between">
                        <a asp-page="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                        <div>
                            <a asp-page="Edit" asp-route-id="@Model.Subject.Id" class="btn btn-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a asp-page="Delete" asp-route-id="@Model.Subject.Id" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
