@page
@model SchedulingSystem.Pages.Admin.Lessons.DashboardModel
@using SchedulingSystem.Models
@{
    ViewData["Title"] = "Lesson Dashboard";
}

<div class="container-fluid mt-4">
    @Html.AntiForgeryToken()

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-speedometer2"></i> Lesson Management Dashboard</h2>
            <p class="text-muted">Manage lessons and their assignments</p>
        </div>
        <div class="col-auto">
            <a href="/Admin/Lessons/Edit?returnUrl=@Uri.EscapeDataString("/Admin/Lessons/Dashboard")" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> Add New Lesson
            </a>
        </div>
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> <strong>Tip:</strong> You can also import lessons using <a asp-page="/Admin/Import/Untis" class="alert-link">Import Data</a>. After creating a lesson, use the <i class="bi bi-sliders"></i> Edit button to assign Teachers, Subjects, and Classes.
    </div>

    <!-- Statistics cards hidden by request -->

    <!-- SECTION 3: Interactive Matrix Grid -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="bi bi-grid-3x3"></i> Lesson Matrix - Subjects × Classes
                                <button id="toggleMatrixBtn" class="btn btn-sm btn-outline-primary ms-2" type="button" onclick="toggleMatrix()">
                                    <i class="bi bi-eye" id="toggleMatrixIcon"></i> <span id="toggleMatrixText">Show Matrix</span>
                                </button>
                            </h4>
                            <small class="text-muted">Click on any cell to view/edit lesson details</small>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-end gap-2 position-relative">
                                <span class="mb-0 me-2"><i class="bi bi-funnel"></i> Filter Subjects:</span>
                                <button id="filterButton" class="btn btn-sm btn-outline-secondary" type="button">
                                    <span id="filterButtonText">All Subjects</span> <i class="bi bi-funnel-fill"></i>
                                </button>
                                <!-- Dual listbox filter dropdown -->
                                <div id="filterDropdown" class="filter-dropdown shadow-lg" style="display: none;">
                                    <div class="dual-listbox-container p-3">
                                        <!-- Hidden subjects (left) -->
                                        <div class="listbox-section">
                                            <label class="form-label fw-bold small">Hidden Subjects</label>
                                            <select id="hiddenSubjects" class="form-select" multiple size="8">
                                                <!-- Dynamically populated by JavaScript -->
                                            </select>
                                        </div>

                                        <!-- Control buttons (center) -->
                                        <div class="listbox-controls d-flex flex-column gap-2">
                                            <button id="showSelected" class="btn btn-sm btn-outline-primary" type="button" title="Show selected subjects">
                                                <i class="bi bi-chevron-right"></i>
                                            </button>
                                            <button id="showAll" class="btn btn-sm btn-outline-primary" type="button" title="Show all subjects">
                                                <i class="bi bi-chevron-double-right"></i>
                                            </button>
                                            <button id="hideSelected" class="btn btn-sm btn-outline-secondary" type="button" title="Hide selected subjects">
                                                <i class="bi bi-chevron-left"></i>
                                            </button>
                                            <button id="hideAll" class="btn btn-sm btn-outline-secondary" type="button" title="Hide all subjects">
                                                <i class="bi bi-chevron-double-left"></i>
                                            </button>
                                        </div>

                                        <!-- Visible subjects (right) -->
                                        <div class="listbox-section">
                                            <label class="form-label fw-bold small">Visible Subjects</label>
                                            <select id="visibleSubjects" class="form-select" multiple size="8">
                                                @foreach (var subject in Model.Subjects.OrderBy(s => s.Name))
                                                {
                                                    <option value="@subject.Id"
                                                            data-code="@subject.Code"
                                                            data-color="@subject.Color"
                                                            data-name="@subject.Name">
                                                        @subject.Code - @subject.Name
                                                    </option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                    <div class="filter-footer p-2 border-top bg-light d-flex gap-2">
                                        <button id="applyFilter" class="btn btn-sm btn-primary flex-fill" type="button">
                                            <i class="bi bi-check-lg"></i> Apply
                                        </button>
                                        <button id="cancelFilter" class="btn btn-sm btn-outline-secondary" type="button">
                                            <i class="bi bi-x-lg"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted float-end mt-1">
                                <span id="subjectCount">@Model.Subjects.Count</span> of @Model.Subjects.Count subjects shown
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0" id="matrixCardBody" style="display: none;">
                    <div class="table-responsive matrix-table-wrapper">
                        <table class="table table-bordered table-sm mb-0 lesson-matrix" style="table-layout: fixed; width: 100%;">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="text-start align-middle subject-col">Subject</th>
                                    @foreach (var classEntity in Model.MainClasses)
                                    {
                                        <th class="text-center align-middle fw-bold class-col">
                                            @classEntity.Name
                                        </th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var subject in Model.Subjects.OrderBy(s => s.Name))
                                {
                                    <tr class="subject-row" data-subject-id="@subject.Id">
                                        <td class="align-middle">
                                            <span class="badge me-2" style="background-color: @subject.Color; color: #000;">
                                                @subject.Code
                                            </span>
                                            <strong class="text-dark">@subject.Name</strong>
                                        </td>
                                        @foreach (var classEntity in Model.MainClasses)
                                        {
                                            var cell = Model.LessonMatrix[classEntity.Id][subject.Id];
                                            <td class="text-center align-middle p-1 matrix-cell @(cell.HasLesson ? "table-success" : "")"
                                                data-class-id="@classEntity.Id"
                                                data-subject-id="@subject.Id"
                                                data-class-name="@classEntity.Name"
                                                data-subject-name="@subject.Name"
                                                data-has-lesson="@cell.HasLesson.ToString().ToLower()">
                                                @if (cell.HasLesson)
                                                {
                                                    <div class="d-flex flex-column align-items-center justify-content-center gap-1">
                                                        <span class="frequency-number badge bg-primary"
                                                              style="cursor: pointer;"
                                                              onclick="filterLessonsByCell(@classEntity.Id, @subject.Id, '@classEntity.Name', '@subject.Name')"
                                                              title="Click to filter lessons for @classEntity.Name - @subject.Name">
                                                            @cell.TotalFrequencyPerWeek
                                                        </span>
                                                        <a href="/Admin/Lessons/Edit?classId=@classEntity.Id&subjectId=@subject.Id&returnUrl=@Uri.EscapeDataString("/Admin/Lessons/Dashboard")"
                                                           class="btn btn-sm btn-outline-success p-0 px-1"
                                                           title="Add new lesson for @classEntity.Name - @subject.Name">
                                                            <i class="bi bi-plus"></i>
                                                        </a>
                                                        @if (cell.HasTeamTeaching)
                                                        {
                                                            <span class="badge bg-info" style="font-size: 0.6rem;" title="Team Teaching">TT</span>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <a href="/Admin/Lessons/Edit?classId=@classEntity.Id&subjectId=@subject.Id&returnUrl=@Uri.EscapeDataString("/Admin/Lessons/Dashboard")"
                                                       class="btn btn-sm btn-outline-secondary p-0 px-1"
                                                       title="Add lesson for @classEntity.Name - @subject.Name">
                                                        <i class="bi bi-plus"></i>
                                                    </a>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white" id="matrixCardFooter" style="display: none;">
                    <div class="row">
                        <div class="col-md-3">
                            <span class="badge bg-primary">N</span> <strong>Frequency/Week (click to filter)</strong>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-sm btn-outline-success p-0 px-1"><i class="bi bi-plus"></i></button> <strong>Add Lesson</strong>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-info">TT</span> <strong>Team Teaching</strong>
                        </div>
                        <div class="col-md-3">
                            <span class="bg-success-subtle border border-success">&nbsp;&nbsp;&nbsp;&nbsp;</span> <strong>Has Lessons</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SECTION 4: Detailed Filterable List -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- Filter Panel -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white py-2">
                    <i class="bi bi-funnel"></i> <strong>Filter Lessons</strong>
                    <small class="ms-2">Select criteria to filter the lessons list</small>
                </div>
                <div class="card-body py-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label for="filterByClass" class="form-label small mb-1">Class</label>
                            <select id="filterByClass" class="form-select form-select-sm" onchange="applyLessonFilters()">
                                <option value="">-- All Classes --</option>
                                @foreach (var cls in Model.AllClasses.OrderBy(c => c.YearLevel).ThenBy(c => c.Name))
                                {
                                    <option value="@cls.Id">@cls.Name (Grade @cls.YearLevel)</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterBySubject" class="form-label small mb-1">Subject</label>
                            <select id="filterBySubject" class="form-select form-select-sm" onchange="applyLessonFilters()">
                                <option value="">-- All Subjects --</option>
                                @foreach (var subject in Model.AllSubjects.OrderBy(s => s.Name))
                                {
                                    <option value="@subject.Id">@subject.Code - @subject.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterByTeacher" class="form-label small mb-1">Teacher</label>
                            <select id="filterByTeacher" class="form-select form-select-sm" onchange="applyLessonFilters()">
                                <option value="">-- All Teachers --</option>
                                @foreach (var teacher in Model.AllTeachers.OrderBy(t => t.FullName))
                                {
                                    <option value="@teacher.Id">@teacher.FullName</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3 d-flex gap-2">
                            <button id="clearAllFilters" class="btn btn-sm btn-outline-secondary" onclick="clearAllLessonFilters()">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </button>
                            <span id="filterMatchCount" class="text-muted small align-self-center"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0 d-inline"><i class="bi bi-list-ul"></i> Lessons</h4>
                            <span id="activeFilterBadge" class="badge bg-info ms-2" style="display: none;">
                                Matrix Filter: <span id="activeFilterText"></span>
                                <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" onclick="clearFilter()" title="Clear filter"></button>
                            </span>
                        </div>
                        <div class="input-group" style="max-width: 300px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search lessons...">
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="lessonsTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center sortable" data-sort="id" style="width: 60px; cursor: pointer;">
                                        ID <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="sortable" data-sort="class" style="cursor: pointer;">
                                        Class <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="sortable" data-sort="subject" style="cursor: pointer;">
                                        Subject <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="sortable" data-sort="teacher" style="cursor: pointer;">
                                        Teacher(s) <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="frequency" style="cursor: pointer;">
                                        Freq/Week <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="duration" style="cursor: pointer;">
                                        Duration <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="text-center">Type</th>
                                    <th class="sortable" data-sort="timetables" style="cursor: pointer;">
                                        Timetables <i class="bi bi-arrow-down-up sort-icon text-muted"></i>
                                    </th>
                                    <th class="text-center" style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lesson in Model.AllLessons.OrderBy(l => l.LessonClasses.FirstOrDefault()?.Class?.Name ?? "").ThenBy(l => l.LessonSubjects.FirstOrDefault()?.Subject?.Name ?? ""))
                                {
                                    var lessonClass = lesson.LessonClasses.FirstOrDefault()?.Class;
                                    var lessonSubject = lesson.LessonSubjects.FirstOrDefault()?.Subject;
                                    var lessonTeacher = lesson.LessonTeachers.FirstOrDefault()?.Teacher;
                                    var teacherIds = string.Join(",", lesson.LessonTeachers.Select(lt => lt.TeacherId));
                                    var classIds = string.Join(",", lesson.LessonClasses.Select(lc => lc.ClassId));
                                    var subjectIds = string.Join(",", lesson.LessonSubjects.Select(ls => ls.SubjectId));
                                    var parentClassIds = string.Join(",", lesson.LessonClasses.Where(lc => lc.Class?.ParentClassId != null).Select(lc => lc.Class!.ParentClassId));
                                    <tr data-lesson-id="@lesson.Id"
                                        data-class-id="@(lessonClass?.Id ?? 0)"
                                        data-class-ids="@classIds"
                                        data-subject-id="@(lessonSubject?.Id ?? 0)"
                                        data-subject-ids="@subjectIds"
                                        data-teacher-ids="@teacherIds"
                                        data-parent-class-id="@(lessonClass?.ParentClassId ?? 0)"
                                        data-parent-class-ids="@parentClassIds">
                                        <td class="text-center">
                                            <span class="badge bg-secondary text-white">@lesson.Id</span>
                                        </td>
                                        <td>
                                            @if (lessonClass != null)
                                            {
                                                <strong>@lessonClass.Name</strong>
                                                @if (lessonClass.ParentClassId != null)
                                                {
                                                    <span class="badge bg-secondary">Subgroup</span>
                                                }
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var sortedSubjects = lesson.LessonSubjects
                                                    .Where(ls => ls.Subject != null)
                                                    .OrderBy(ls => ls.Subject!.Name)
                                                    .Select(ls => ls.Subject!)
                                                    .ToList();
                                            }
                                            @if (sortedSubjects.Any())
                                            {
                                                @foreach (var subject in sortedSubjects)
                                                {
                                                    <div class="mb-1">
                                                        <span class="badge" style="background-color: @subject.Color">
                                                            @subject.Code
                                                        </span>
                                                        @subject.Name
                                                    </div>
                                                }
                                            }
                                        </td>
                                        <td>
                                            @if (lessonTeacher != null)
                                            {
                                                <div>@lessonTeacher.FullName</div>
                                            }
                                            @if (lesson.LessonTeachers.Count() > 1)
                                            {
                                                @foreach (var additionalTeacher in lesson.LessonTeachers.Skip(1))
                                                {
                                                    <small class="text-muted">+ @additionalTeacher.Teacher?.FullName</small><br/>
                                                }
                                            }
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@lesson.FrequencyPerWeek×</span>
                                        </td>
                                        <td class="text-center">@lesson.Duration min</td>
                                        <td class="text-center">
                                            @if (lesson.LessonTeachers.Count() > 1)
                                            {
                                                <span class="badge bg-info" title="Team Teaching">TT</span>
                                            }
                                            @if (!string.IsNullOrEmpty(lesson.SpecialRequirements) && lesson.SpecialRequirements.Contains("Parallel"))
                                            {
                                                <span class="badge bg-warning" title="Parallel Lesson">
                                                    <i class="bi bi-shuffle"></i>
                                                </span>
                                            }
                                            @if (lesson.LessonTeachers.Count <= 1 && (string.IsNullOrEmpty(lesson.SpecialRequirements) || !lesson.SpecialRequirements.Contains("Parallel")))
                                            {
                                                <span class="text-muted">Regular</span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var timetables = Model.LessonTimetables.GetValueOrDefault(lesson.Id, new List<DashboardModel.TimetableInfo>());
                                            }
                                            @if (timetables.Any())
                                            {
                                                <div class="d-flex flex-wrap gap-1">
                                                    @foreach (var tt in timetables)
                                                    {
                                                        var statusClass = tt.Status == TimetableStatus.Published ? "bg-success" :
                                                                         tt.Status == TimetableStatus.Archived ? "bg-secondary" : "bg-warning text-dark";
                                                        <a href="/Admin/Timetables/Edit?id=@tt.Id"
                                                           class="badge @statusClass text-decoration-none"
                                                           title="@tt.Status">
                                                            @tt.Name
                                                        </a>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">Not scheduled</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <a href="/Admin/Lessons/Edit?id=@lesson.Id&returnUrl=@Uri.EscapeDataString("/Admin/Lessons/Dashboard")"
                                               class="btn btn-sm btn-outline-primary" title="Edit Lesson">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="confirmDeleteLesson(@lesson.Id)" title="Delete Lesson">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lesson Modal -->
    <div class="modal fade" id="addLessonModal" tabindex="-1" aria-labelledby="addLessonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addLessonModalLabel">
                        <i class="bi bi-plus-circle"></i> Add New Lesson
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Classes Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <strong><i class="bi bi-people"></i> Classes</strong>
                        </div>
                        <div class="card-body py-2">
                            <div id="newLessonClassesList" class="mb-2">
                                <span class="text-muted fst-italic">No classes selected</span>
                            </div>
                            <div class="row">
                                <div class="col-9">
                                    <select id="newClassSelect" class="form-select form-select-sm">
                                        <option value="">-- Select a class to add --</option>
                                        @foreach (var cls in Model.AllClasses)
                                        {
                                            <option value="@cls.Id" data-name="@cls.Name (Grade @cls.YearLevel)">@cls.Name (Grade @cls.YearLevel)</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="addNewLessonClass()">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subjects Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <strong><i class="bi bi-book"></i> Subjects</strong>
                        </div>
                        <div class="card-body py-2">
                            <div id="newLessonSubjectsList" class="mb-2">
                                <span class="text-muted fst-italic">No subjects selected</span>
                            </div>
                            <div class="row">
                                <div class="col-9">
                                    <select id="newSubjectSelect" class="form-select form-select-sm">
                                        <option value="">-- Select a subject to add --</option>
                                        @foreach (var subject in Model.AllSubjects)
                                        {
                                            <option value="@subject.Id" data-name="@subject.Code - @subject.Name">@subject.Code - @subject.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="addNewLessonSubject()">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Teachers Section -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <strong><i class="bi bi-person-badge"></i> Teachers</strong>
                        </div>
                        <div class="card-body py-2">
                            <div id="newLessonTeachersList" class="mb-2">
                                <span class="text-muted fst-italic">No teachers selected</span>
                            </div>
                            <div class="row">
                                <div class="col-9">
                                    <select id="newTeacherSelect" class="form-select form-select-sm">
                                        <option value="">-- Select a teacher to add --</option>
                                        @foreach (var teacher in Model.AllTeachers)
                                        {
                                            <option value="@teacher.Id" data-name="@teacher.FullName">@teacher.FullName</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-3">
                                    <button type="button" class="btn btn-sm btn-outline-primary w-100" onclick="addNewLessonTeacher()">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lesson Properties -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <strong><i class="bi bi-gear"></i> Properties</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label for="newLessonDuration" class="form-label small mb-1">
                                        <i class="bi bi-clock"></i> Duration (Periods)
                                    </label>
                                    <input type="number" class="form-control form-control-sm" id="newLessonDuration" min="1" max="10" value="1">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label for="newLessonFrequency" class="form-label small mb-1">
                                        <i class="bi bi-calendar-week"></i> Times Per Week
                                    </label>
                                    <input type="number" class="form-control form-control-sm" id="newLessonFrequency" min="1" max="20" value="1">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="newLessonDescription" class="form-label small mb-1">
                                    <i class="bi bi-card-text"></i> Description (Optional)
                                </label>
                                <input type="text" class="form-control form-control-sm" id="newLessonDescription" maxlength="500" placeholder="e.g., Math for advanced students">
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newLessonIsActive" checked>
                                <label class="form-check-label small" for="newLessonIsActive">
                                    <i class="bi bi-toggle-on"></i> Active (will be scheduled)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="createLessonBtn" onclick="createLesson()">
                        <i class="bi bi-plus-circle"></i> Create Lesson
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Lesson Modal -->
    <div class="modal fade" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editLessonModalLabel">
                        <i class="bi bi-pencil-square"></i> Edit Lesson
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editLessonId">

                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs mb-3" id="editTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers-pane"
                                    type="button" role="tab" aria-controls="teachers-pane" aria-selected="true">
                                <i class="bi bi-person-badge"></i> Teachers
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="subjects-tab" data-bs-toggle="tab" data-bs-target="#subjects-pane"
                                    type="button" role="tab" aria-controls="subjects-pane" aria-selected="false">
                                <i class="bi bi-book"></i> Subjects
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes-pane"
                                    type="button" role="tab" aria-controls="classes-pane" aria-selected="false">
                                <i class="bi bi-people"></i> Classes
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties-pane"
                                    type="button" role="tab" aria-controls="properties-pane" aria-selected="false">
                                <i class="bi bi-gear"></i> Properties
                            </button>
                        </li>
                    </ul>

                    <!-- Tab content -->
                    <div class="tab-content" id="editTabsContent">
                        <!-- Teachers Tab -->
                        <div class="tab-pane fade show active" id="teachers-pane" role="tabpanel" aria-labelledby="teachers-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Current Teachers</label>
                                <div id="currentTeachersList" class="mb-2">
                                    <!-- Dynamic list of current teachers -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <select id="teacherSelect" class="form-select">
                                        <option value="">-- Select a teacher to add --</option>
                                        @foreach (var teacher in Model.AllTeachers)
                                        {
                                            <option value="@teacher.Id">@teacher.FullName</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="addTeacher()">
                                        <i class="bi bi-plus-circle"></i> Add Teacher
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="button" class="btn btn-primary" onclick="saveTeachers()">
                                    <i class="bi bi-save"></i> Save Teachers
                                </button>
                            </div>
                        </div>

                        <!-- Subjects Tab -->
                        <div class="tab-pane fade" id="subjects-pane" role="tabpanel" aria-labelledby="subjects-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Current Subjects</label>
                                <div id="currentSubjectsList" class="mb-2">
                                    <!-- Dynamic list of current subjects -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <select id="subjectSelect" class="form-select">
                                        <option value="">-- Select a subject to add --</option>
                                        @foreach (var subject in Model.AllSubjects)
                                        {
                                            <option value="@subject.Id">@subject.Code - @subject.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="addSubject()">
                                        <i class="bi bi-plus-circle"></i> Add Subject
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="button" class="btn btn-primary" onclick="saveSubjects()">
                                    <i class="bi bi-save"></i> Save Subjects
                                </button>
                            </div>
                        </div>

                        <!-- Classes Tab -->
                        <div class="tab-pane fade" id="classes-pane" role="tabpanel" aria-labelledby="classes-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Current Classes</label>
                                <div id="currentClassesList" class="mb-2">
                                    <!-- Dynamic list of current classes -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <select id="classSelect" class="form-select">
                                        <option value="">-- Select a class to add --</option>
                                        @foreach (var cls in Model.AllClasses)
                                        {
                                            <option value="@cls.Id">@cls.Name (Grade @cls.YearLevel)</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="addClass()">
                                        <i class="bi bi-plus-circle"></i> Add Class
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button type="button" class="btn btn-primary" onclick="saveClasses()">
                                    <i class="bi bi-save"></i> Save Classes
                                </button>
                            </div>
                        </div>

                        <!-- Properties Tab -->
                        <div class="tab-pane fade" id="properties-pane" role="tabpanel" aria-labelledby="properties-tab">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editDuration" class="form-label">Duration (Periods)</label>
                                        <input type="number" class="form-control" id="editDuration" min="1" max="10">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="editFrequency" class="form-label">Frequency Per Week</label>
                                        <input type="number" class="form-control" id="editFrequency" min="1" max="20">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editDescription" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="editSpecialRequirements" class="form-label">Special Requirements</label>
                                <textarea class="form-control" id="editSpecialRequirements" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editIsActive">
                                    <label class="form-check-label" for="editIsActive">
                                        Is Active
                                    </label>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="button" class="btn btn-primary" onclick="saveProperties()">
                                    <i class="bi bi-save"></i> Save Properties
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/filter-state.js"></script>
    <style>
        .lesson-matrix .matrix-cell {
            transition: all 0.2s ease;
            padding: 4px !important;
            vertical-align: middle;
        }

        .lesson-matrix .matrix-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .card {
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        /* Matrix table full width styles */
        .matrix-table-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .lesson-matrix {
            font-size: 0.85rem;
        }

        .lesson-matrix .subject-col {
            width: 180px;
            min-width: 180px;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lesson-matrix .class-col {
            width: auto;
            min-width: 50px;
            text-align: center;
            font-size: 0.75rem;
            padding: 4px 2px !important;
        }

        .lesson-matrix td {
            vertical-align: middle;
            text-align: center;
        }

        /* Compact cell content */
        .lesson-matrix .frequency-number {
            font-size: 0.8rem;
            padding: 2px 6px;
        }

        .lesson-matrix .btn-sm {
            font-size: 0.7rem;
            padding: 1px 4px;
        }

        /* Dual listbox filter dropdown */
        .filter-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 550px;
            z-index: 1000;
        }

        .dual-listbox-container {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .listbox-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .listbox-section select {
            font-size: 0.9rem;
            height: auto;
        }

        .listbox-section select option {
            padding: 4px 8px;
            cursor: pointer;
        }

        .listbox-controls {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0 5px;
        }

        .listbox-controls button {
            width: 40px;
            height: 32px;
            padding: 4px;
        }

        #filterButton {
            min-width: 150px;
        }
    </style>

    <script>
        // Toggle matrix visibility
        let matrixVisible = false;
        function toggleMatrix() {
            matrixVisible = !matrixVisible;
            const cardBody = document.getElementById('matrixCardBody');
            const cardFooter = document.getElementById('matrixCardFooter');
            const toggleIcon = document.getElementById('toggleMatrixIcon');
            const toggleText = document.getElementById('toggleMatrixText');

            if (matrixVisible) {
                cardBody.style.display = 'block';
                cardFooter.style.display = 'block';
                toggleIcon.className = 'bi bi-eye-slash';
                toggleText.textContent = 'Hide Matrix';
            } else {
                cardBody.style.display = 'none';
                cardFooter.style.display = 'none';
                toggleIcon.className = 'bi bi-eye';
                toggleText.textContent = 'Show Matrix';
            }
        }

        // Get anti-forgery token
        function getAntiForgeryToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]').value;
        }

        // ===== Table Sorting =====
        let currentSortColumn = 'class';
        let currentSortDirection = 'asc';

        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to sortable headers
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => sortTable(header.dataset.sort));
            });

            // Restore saved filters from URL or session storage
            const savedFilters = FilterState.restore();
            if (savedFilters.class || savedFilters.subject || savedFilters.teacher) {
                if (savedFilters.class) {
                    document.getElementById('filterByClass').value = savedFilters.class;
                }
                if (savedFilters.subject) {
                    document.getElementById('filterBySubject').value = savedFilters.subject;
                }
                if (savedFilters.teacher) {
                    document.getElementById('filterByTeacher').value = savedFilters.teacher;
                }
                // Apply filters without saving again (already restored)
                applyLessonFilters(true);
            }
        });

        function sortTable(column) {
            const table = document.getElementById('lessonsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle direction if same column, otherwise default to asc
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update header icons
            document.querySelectorAll('.sortable .sort-icon').forEach(icon => {
                icon.className = 'bi bi-arrow-down-up sort-icon text-muted';
            });
            const activeHeader = document.querySelector(`.sortable[data-sort="${column}"] .sort-icon`);
            if (activeHeader) {
                activeHeader.className = currentSortDirection === 'asc'
                    ? 'bi bi-sort-down-alt sort-icon text-primary'
                    : 'bi bi-sort-up sort-icon text-primary';
            }

            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;

                switch(column) {
                    case 'id':
                        aVal = parseInt(a.dataset.lessonId) || 0;
                        bVal = parseInt(b.dataset.lessonId) || 0;
                        break;
                    case 'class':
                        aVal = a.cells[1].textContent.trim().toLowerCase();
                        bVal = b.cells[1].textContent.trim().toLowerCase();
                        break;
                    case 'subject':
                        aVal = a.cells[2].textContent.trim().toLowerCase();
                        bVal = b.cells[2].textContent.trim().toLowerCase();
                        break;
                    case 'teacher':
                        aVal = a.cells[3].textContent.trim().toLowerCase();
                        bVal = b.cells[3].textContent.trim().toLowerCase();
                        break;
                    case 'frequency':
                        aVal = parseInt(a.cells[4].textContent.replace(/[^0-9]/g, '')) || 0;
                        bVal = parseInt(b.cells[4].textContent.replace(/[^0-9]/g, '')) || 0;
                        break;
                    case 'duration':
                        aVal = parseInt(a.cells[5].textContent.replace(/[^0-9]/g, '')) || 0;
                        bVal = parseInt(b.cells[5].textContent.replace(/[^0-9]/g, '')) || 0;
                        break;
                    default:
                        aVal = a.cells[1].textContent.trim().toLowerCase();
                        bVal = b.cells[1].textContent.trim().toLowerCase();
                }

                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
                    return 0;
                }
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // ===== New Lesson Modal State =====
        let newLessonClasses = [];
        let newLessonSubjects = [];
        let newLessonTeachers = [];

        // Add class to new lesson
        function addNewLessonClass() {
            const select = document.getElementById('newClassSelect');
            const classId = parseInt(select.value);
            if (!classId) return;

            if (newLessonClasses.some(c => c.id === classId)) {
                showToast('Class already added', 'warning');
                return;
            }

            const name = select.options[select.selectedIndex].getAttribute('data-name');
            newLessonClasses.push({ id: classId, name: name });
            renderNewLessonClasses();
            select.value = '';
        }

        // Remove class from new lesson
        function removeNewLessonClass(classId) {
            newLessonClasses = newLessonClasses.filter(c => c.id !== classId);
            renderNewLessonClasses();
        }

        // Render new lesson classes list
        function renderNewLessonClasses() {
            const container = document.getElementById('newLessonClassesList');
            if (newLessonClasses.length === 0) {
                container.innerHTML = '<span class="text-muted fst-italic">No classes selected</span>';
                return;
            }
            container.innerHTML = newLessonClasses.map((c, i) => `
                <span class="badge bg-info me-1 mb-1">
                    ${c.name}
                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.5rem;" onclick="removeNewLessonClass(${c.id})"></button>
                </span>
            `).join('');
        }

        // Add subject to new lesson
        function addNewLessonSubject() {
            const select = document.getElementById('newSubjectSelect');
            const subjectId = parseInt(select.value);
            if (!subjectId) return;

            if (newLessonSubjects.some(s => s.id === subjectId)) {
                showToast('Subject already added', 'warning');
                return;
            }

            const name = select.options[select.selectedIndex].getAttribute('data-name');
            newLessonSubjects.push({ id: subjectId, name: name });
            renderNewLessonSubjects();
            select.value = '';
        }

        // Remove subject from new lesson
        function removeNewLessonSubject(subjectId) {
            newLessonSubjects = newLessonSubjects.filter(s => s.id !== subjectId);
            renderNewLessonSubjects();
        }

        // Render new lesson subjects list
        function renderNewLessonSubjects() {
            const container = document.getElementById('newLessonSubjectsList');
            if (newLessonSubjects.length === 0) {
                container.innerHTML = '<span class="text-muted fst-italic">No subjects selected</span>';
                return;
            }
            container.innerHTML = newLessonSubjects.map((s, i) => `
                <span class="badge bg-secondary me-1 mb-1">
                    ${s.name}
                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.5rem;" onclick="removeNewLessonSubject(${s.id})"></button>
                </span>
            `).join('');
        }

        // Add teacher to new lesson
        function addNewLessonTeacher() {
            const select = document.getElementById('newTeacherSelect');
            const teacherId = parseInt(select.value);
            if (!teacherId) return;

            if (newLessonTeachers.some(t => t.id === teacherId)) {
                showToast('Teacher already added', 'warning');
                return;
            }

            const name = select.options[select.selectedIndex].getAttribute('data-name');
            newLessonTeachers.push({ id: teacherId, name: name });
            renderNewLessonTeachers();
            select.value = '';
        }

        // Remove teacher from new lesson
        function removeNewLessonTeacher(teacherId) {
            newLessonTeachers = newLessonTeachers.filter(t => t.id !== teacherId);
            renderNewLessonTeachers();
        }

        // Render new lesson teachers list
        function renderNewLessonTeachers() {
            const container = document.getElementById('newLessonTeachersList');
            if (newLessonTeachers.length === 0) {
                container.innerHTML = '<span class="text-muted fst-italic">No teachers selected</span>';
                return;
            }
            container.innerHTML = newLessonTeachers.map((t, i) => `
                <span class="badge bg-primary me-1 mb-1">
                    ${t.name} ${i === 0 ? '(Lead)' : ''}
                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.5rem;" onclick="removeNewLessonTeacher(${t.id})"></button>
                </span>
            `).join('');
        }

        // Open add lesson modal with pre-selected class and subject
        function openAddLessonWithSelection(classId, subjectId, className, subjectName) {
            // Reset selections
            newLessonClasses = [];
            newLessonSubjects = [];
            newLessonTeachers = [];

            // Add pre-selected class and subject
            if (classId) {
                newLessonClasses.push({ id: classId, name: className });
            }
            if (subjectId) {
                newLessonSubjects.push({ id: subjectId, name: subjectName });
            }

            // Render lists
            renderNewLessonClasses();
            renderNewLessonSubjects();
            renderNewLessonTeachers();

            // Reset other fields
            document.getElementById('newLessonDuration').value = '1';
            document.getElementById('newLessonFrequency').value = '1';
            document.getElementById('newLessonDescription').value = '';
            document.getElementById('newLessonIsActive').checked = true;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('addLessonModal'));
            modal.show();
        }

        // Reset add modal when hidden
        document.getElementById('addLessonModal').addEventListener('hidden.bs.modal', function() {
            newLessonClasses = [];
            newLessonSubjects = [];
            newLessonTeachers = [];
            renderNewLessonClasses();
            renderNewLessonSubjects();
            renderNewLessonTeachers();
            document.getElementById('newLessonDuration').value = '1';
            document.getElementById('newLessonFrequency').value = '1';
            document.getElementById('newLessonDescription').value = '';
            document.getElementById('newLessonIsActive').checked = true;
        });

        // Create new lesson
        async function createLesson() {
            const description = document.getElementById('newLessonDescription').value;
            const duration = document.getElementById('newLessonDuration').value;
            const frequencyPerWeek = document.getElementById('newLessonFrequency').value;
            const isActive = document.getElementById('newLessonIsActive').checked;

            const createBtn = document.getElementById('createLessonBtn');
            const originalBtnText = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=CreateLesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({
                        description: description || null,
                        duration: parseInt(duration) || 1,
                        frequencyPerWeek: parseInt(frequencyPerWeek) || 1,
                        isActive: isActive,
                        teacherIds: newLessonTeachers.map(t => t.id),
                        subjectIds: newLessonSubjects.map(s => s.id),
                        classIds: newLessonClasses.map(c => c.id)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addLessonModal')).hide();
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast(result.message, 'danger');
                }
            } catch (error) {
                console.error('Error creating lesson:', error);
                showToast('An error occurred while creating the lesson', 'danger');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = originalBtnText;
            }
        }

        // ===== Delete Lesson =====
        async function confirmDeleteLesson(lessonId) {
            if (!confirm('Are you sure you want to delete this lesson? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=DeleteLesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    body: JSON.stringify({ lessonId: lessonId })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast(result.message, 'danger');
                }
            } catch (error) {
                console.error('Error deleting lesson:', error);
                showToast('An error occurred while deleting the lesson', 'danger');
            }
        }

        // ===== Filter Lessons by Matrix Cell =====
        let currentFilterClassId = null;
        let currentFilterSubjectId = null;

        function filterLessonsByCell(classId, subjectId, className, subjectName) {
            currentFilterClassId = classId;
            currentFilterSubjectId = subjectId;

            const table = document.getElementById('lessonsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let matchCount = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const classIds = (row.getAttribute('data-class-ids') || '').split(',').filter(id => id);
                const parentClassIds = (row.getAttribute('data-parent-class-ids') || '').split(',').filter(id => id);
                const subjectIds = (row.getAttribute('data-subject-ids') || '').split(',').filter(id => id);

                // Match if any class matches directly OR if any parent class matches (for subgroups)
                const classMatches = classIds.includes(classId.toString()) || parentClassIds.includes(classId.toString());
                // Match if any subject matches
                const subjectMatches = subjectIds.includes(subjectId.toString());

                if (classMatches && subjectMatches) {
                    row.style.display = '';
                    matchCount++;
                } else {
                    row.style.display = 'none';
                }
            }

            // Show filter badge
            document.getElementById('activeFilterBadge').style.display = 'inline-block';
            document.getElementById('activeFilterText').textContent = `${className} - ${subjectName} (${matchCount} lessons)`;

            // Clear search input
            document.getElementById('searchInput').value = '';

            // Scroll to the lessons table
            document.getElementById('lessonsTable').scrollIntoView({ behavior: 'smooth' });
        }

        function clearFilter() {
            currentFilterClassId = null;
            currentFilterSubjectId = null;

            // Also clear the filter panel dropdowns
            document.getElementById('filterByClass').value = '';
            document.getElementById('filterBySubject').value = '';
            document.getElementById('filterByTeacher').value = '';

            const table = document.getElementById('lessonsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = '';
            }

            document.getElementById('activeFilterBadge').style.display = 'none';
            document.getElementById('filterMatchCount').textContent = '';
            document.getElementById('searchInput').value = '';
        }

        // ===== Filter Panel Functions =====
        function applyLessonFilters(skipSave = false) {
            // Clear any matrix filter that might be active
            currentFilterClassId = null;
            currentFilterSubjectId = null;
            document.getElementById('activeFilterBadge').style.display = 'none';

            const classFilter = document.getElementById('filterByClass').value;
            const subjectFilter = document.getElementById('filterBySubject').value;
            const teacherFilter = document.getElementById('filterByTeacher').value;

            // Save filter state (unless restoring)
            if (!skipSave) {
                FilterState.save({
                    class: classFilter,
                    subject: subjectFilter,
                    teacher: teacherFilter
                });
            }

            const table = document.getElementById('lessonsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let matchCount = 0;
            const totalRows = rows.length;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const classIds = (row.getAttribute('data-class-ids') || '').split(',').filter(id => id);
                const parentClassIds = (row.getAttribute('data-parent-class-ids') || '').split(',').filter(id => id);
                const subjectIds = (row.getAttribute('data-subject-ids') || '').split(',').filter(id => id);
                const teacherIds = (row.getAttribute('data-teacher-ids') || '').split(',').filter(id => id);

                // Check class filter (include subgroups via parent class)
                let classMatch = true;
                if (classFilter) {
                    classMatch = classIds.includes(classFilter) || parentClassIds.includes(classFilter);
                }

                // Check subject filter (match any of the lesson's subjects)
                let subjectMatch = true;
                if (subjectFilter) {
                    subjectMatch = subjectIds.includes(subjectFilter);
                }

                // Check teacher filter (match any of the lesson's teachers)
                let teacherMatch = true;
                if (teacherFilter) {
                    teacherMatch = teacherIds.includes(teacherFilter);
                }

                if (classMatch && subjectMatch && teacherMatch) {
                    row.style.display = '';
                    matchCount++;
                } else {
                    row.style.display = 'none';
                }
            }

            // Update match count
            const filterMatchCountEl = document.getElementById('filterMatchCount');
            if (classFilter || subjectFilter || teacherFilter) {
                filterMatchCountEl.textContent = `Showing ${matchCount} of ${totalRows} lessons`;
            } else {
                filterMatchCountEl.textContent = '';
            }
        }

        function clearAllLessonFilters() {
            document.getElementById('filterByClass').value = '';
            document.getElementById('filterBySubject').value = '';
            document.getElementById('filterByTeacher').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('filterMatchCount').textContent = '';
            document.getElementById('activeFilterBadge').style.display = 'none';
            currentFilterClassId = null;
            currentFilterSubjectId = null;

            // Clear saved filter state
            FilterState.clear();

            const table = document.getElementById('lessonsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = '';
            }
        }

        // Search functionality for the detailed list
        document.getElementById('searchInput').addEventListener('keyup', function() {
            var searchValue = this.value.toLowerCase();
            var table = document.getElementById('lessonsTable');
            var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                var text = row.textContent.toLowerCase();

                if (text.indexOf(searchValue) > -1) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Dual listbox subject filter functionality
        const filterButton = document.getElementById('filterButton');
        const filterButtonText = document.getElementById('filterButtonText');
        const filterDropdown = document.getElementById('filterDropdown');
        const hiddenSubjects = document.getElementById('hiddenSubjects');
        const visibleSubjects = document.getElementById('visibleSubjects');
        const showSelectedBtn = document.getElementById('showSelected');
        const showAllBtn = document.getElementById('showAll');
        const hideSelectedBtn = document.getElementById('hideSelected');
        const hideAllBtn = document.getElementById('hideAll');
        const applyFilterBtn = document.getElementById('applyFilter');
        const cancelFilterBtn = document.getElementById('cancelFilter');
        const subjectRows = document.querySelectorAll('.subject-row');
        const subjectCountSpan = document.getElementById('subjectCount');

        // Store the current applied filter state (subject IDs that are visible)
        let appliedVisibleSubjects = Array.from(visibleSubjects.options).map(opt => opt.value);

        // Toggle dropdown visibility
        filterButton.addEventListener('click', function(e) {
            e.stopPropagation();
            const isVisible = filterDropdown.style.display === 'block';
            filterDropdown.style.display = isVisible ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!filterDropdown.contains(e.target) && e.target !== filterButton) {
                filterDropdown.style.display = 'none';
            }
        });

        // Prevent dropdown from closing when clicking inside it
        filterDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Show selected subjects (move from hidden to visible)
        showSelectedBtn.addEventListener('click', function() {
            const selectedOptions = Array.from(hiddenSubjects.selectedOptions);
            selectedOptions.forEach(option => {
                visibleSubjects.appendChild(option);
            });
            sortSelectOptions(visibleSubjects);
        });

        // Show all subjects
        showAllBtn.addEventListener('click', function() {
            while (hiddenSubjects.options.length > 0) {
                visibleSubjects.appendChild(hiddenSubjects.options[0]);
            }
            sortSelectOptions(visibleSubjects);
        });

        // Hide selected subjects (move from visible to hidden)
        hideSelectedBtn.addEventListener('click', function() {
            const selectedOptions = Array.from(visibleSubjects.selectedOptions);
            selectedOptions.forEach(option => {
                hiddenSubjects.appendChild(option);
            });
            sortSelectOptions(hiddenSubjects);
        });

        // Hide all subjects
        hideAllBtn.addEventListener('click', function() {
            while (visibleSubjects.options.length > 0) {
                hiddenSubjects.appendChild(visibleSubjects.options[0]);
            }
            sortSelectOptions(hiddenSubjects);
        });

        // Sort select options alphabetically
        function sortSelectOptions(selectElement) {
            const options = Array.from(selectElement.options);
            options.sort((a, b) => a.text.localeCompare(b.text));
            selectElement.innerHTML = '';
            options.forEach(option => selectElement.appendChild(option));
        }

        // Apply filter
        applyFilterBtn.addEventListener('click', function() {
            // Save current visible subjects
            appliedVisibleSubjects = Array.from(visibleSubjects.options).map(opt => opt.value);
            applyFilter();
            filterDropdown.style.display = 'none';
        });

        // Cancel filter - revert to last applied state
        cancelFilterBtn.addEventListener('click', function() {
            // Move all options back to their applied state
            const allOptions = Array.from(hiddenSubjects.options).concat(Array.from(visibleSubjects.options));

            // Clear both lists
            hiddenSubjects.innerHTML = '';
            visibleSubjects.innerHTML = '';

            // Redistribute based on applied state
            allOptions.forEach(option => {
                if (appliedVisibleSubjects.includes(option.value)) {
                    visibleSubjects.appendChild(option);
                } else {
                    hiddenSubjects.appendChild(option);
                }
            });

            sortSelectOptions(hiddenSubjects);
            sortSelectOptions(visibleSubjects);
            filterDropdown.style.display = 'none';
        });

        // Apply filter to matrix rows
        function applyFilter() {
            const visibleSubjectIds = Array.from(visibleSubjects.options).map(opt => opt.value);
            let visibleCount = 0;

            subjectRows.forEach(row => {
                const subjectId = row.getAttribute('data-subject-id');
                if (visibleSubjectIds.includes(subjectId)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update counter
            subjectCountSpan.textContent = visibleCount;

            // Update button text
            const totalSubjects = subjectRows.length;
            if (visibleCount === totalSubjects) {
                filterButtonText.textContent = 'All Subjects';
            } else if (visibleCount === 1) {
                const option = visibleSubjects.options[0];
                filterButtonText.textContent = option.text;
            } else {
                filterButtonText.textContent = `${visibleCount} Subjects`;
            }
        }

        // ===== Edit Modal Functionality =====

        // Current lesson data for editing
        let currentLessonData = null;
        let currentTeachers = [];
        let currentSubjects = [];
        let currentClasses = [];

        // Open edit modal and load lesson data
        async function openEditModal(lessonId) {
            try {
                const response = await fetch(`/Admin/Lessons/Dashboard?handler=Lesson&id=${lessonId}`);
                const data = await response.json();

                if (!data.success) {
                    alert('Error loading lesson: ' + data.message);
                    return;
                }

                currentLessonData = data.lesson;
                document.getElementById('editLessonId').value = lessonId;

                // Update modal title with lesson number
                document.getElementById('editLessonModalLabel').innerHTML =
                    `<i class="bi bi-pencil-square"></i> Edit Lesson #${lessonId}`;

                // Load teachers
                currentTeachers = data.lesson.teachers.map(t => ({
                    id: t.teacherId,
                    name: t.teacherName
                }));
                renderTeachersList();

                // Load subjects
                currentSubjects = data.lesson.subjects.map(s => ({
                    id: s.subjectId,
                    name: s.subjectName,
                    code: s.subjectCode
                }));
                renderSubjectsList();

                // Load classes
                currentClasses = data.lesson.classes.map(c => ({
                    id: c.classId,
                    name: c.className
                }));
                renderClassesList();

                // Load properties
                document.getElementById('editDuration').value = data.lesson.duration;
                document.getElementById('editFrequency').value = data.lesson.frequencyPerWeek;
                document.getElementById('editDescription').value = data.lesson.description || '';
                document.getElementById('editSpecialRequirements').value = data.lesson.specialRequirements || '';
                document.getElementById('editIsActive').checked = data.lesson.isActive;

                // Reset to first tab
                const firstTab = document.getElementById('teachers-tab');
                const tab = new bootstrap.Tab(firstTab);
                tab.show();

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editLessonModal'));
                modal.show();

            } catch (error) {
                console.error('Error:', error);
                alert('Error loading lesson data');
            }
        }

        // Render teachers list
        function renderTeachersList() {
            const container = document.getElementById('currentTeachersList');
            if (currentTeachers.length === 0) {
                container.innerHTML = '<div class="text-muted fst-italic">No teachers assigned</div>';
                return;
            }

            container.innerHTML = currentTeachers.map((t, index) => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                    <div>
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        <span>${t.name}</span>
                        ${index === 0 ? '<span class="badge bg-success ms-2">Lead</span>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTeacher(${t.id})">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            `).join('');
        }

        // Add teacher
        function addTeacher() {
            const select = document.getElementById('teacherSelect');
            const teacherId = parseInt(select.value);
            if (!teacherId) return;

            // Check if already added
            if (currentTeachers.some(t => t.id === teacherId)) {
                alert('This teacher is already assigned to this lesson');
                return;
            }

            const teacherName = select.options[select.selectedIndex].text;
            currentTeachers.push({ id: teacherId, name: teacherName });
            renderTeachersList();
            select.value = '';
        }

        // Remove teacher
        function removeTeacher(teacherId) {
            currentTeachers = currentTeachers.filter(t => t.id !== teacherId);
            renderTeachersList();
        }

        // Save teachers
        async function saveTeachers() {
            const lessonId = parseInt(document.getElementById('editLessonId').value);
            const teacherIds = currentTeachers.map(t => t.id);

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=UpdateTeachers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ lessonId, teacherIds })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Teachers updated successfully', 'success');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving teachers');
            }
        }

        // Render subjects list
        function renderSubjectsList() {
            const container = document.getElementById('currentSubjectsList');
            if (currentSubjects.length === 0) {
                container.innerHTML = '<div class="text-muted fst-italic">No subjects assigned</div>';
                return;
            }

            container.innerHTML = currentSubjects.map((s, index) => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                    <div>
                        <span class="badge bg-secondary me-2">${s.code}</span>
                        <span>${s.name}</span>
                        ${index === 0 ? '<span class="badge bg-success ms-2">Primary</span>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubject(${s.id})">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            `).join('');
        }

        // Add subject
        function addSubject() {
            const select = document.getElementById('subjectSelect');
            const subjectId = parseInt(select.value);
            if (!subjectId) return;

            // Check if already added
            if (currentSubjects.some(s => s.id === subjectId)) {
                alert('This subject is already assigned to this lesson');
                return;
            }

            const text = select.options[select.selectedIndex].text;
            const parts = text.split(' - ');
            currentSubjects.push({ id: subjectId, code: parts[0], name: parts[1] || parts[0] });
            renderSubjectsList();
            select.value = '';
        }

        // Remove subject
        function removeSubject(subjectId) {
            currentSubjects = currentSubjects.filter(s => s.id !== subjectId);
            renderSubjectsList();
        }

        // Save subjects
        async function saveSubjects() {
            const lessonId = parseInt(document.getElementById('editLessonId').value);
            const subjectIds = currentSubjects.map(s => s.id);

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=UpdateSubjects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ lessonId, subjectIds })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Subjects updated successfully', 'success');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving subjects');
            }
        }

        // Render classes list
        function renderClassesList() {
            const container = document.getElementById('currentClassesList');
            if (currentClasses.length === 0) {
                container.innerHTML = '<div class="text-muted fst-italic">No classes assigned</div>';
                return;
            }

            container.innerHTML = currentClasses.map((c, index) => `
                <div class="d-flex align-items-center justify-content-between mb-2 p-2 bg-light rounded">
                    <div>
                        <span class="badge bg-info me-2">${index + 1}</span>
                        <span>${c.name}</span>
                        ${index === 0 ? '<span class="badge bg-success ms-2">Primary</span>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeClass(${c.id})">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            `).join('');
        }

        // Add class
        function addClass() {
            const select = document.getElementById('classSelect');
            const classId = parseInt(select.value);
            if (!classId) return;

            // Check if already added
            if (currentClasses.some(c => c.id === classId)) {
                alert('This class is already assigned to this lesson');
                return;
            }

            const className = select.options[select.selectedIndex].text;
            currentClasses.push({ id: classId, name: className });
            renderClassesList();
            select.value = '';
        }

        // Remove class
        function removeClass(classId) {
            currentClasses = currentClasses.filter(c => c.id !== classId);
            renderClassesList();
        }

        // Save classes
        async function saveClasses() {
            const lessonId = parseInt(document.getElementById('editLessonId').value);
            const classIds = currentClasses.map(c => c.id);

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=UpdateClasses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ lessonId, classIds })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Classes updated successfully', 'success');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving classes');
            }
        }

        // Save properties
        async function saveProperties() {
            const lessonId = parseInt(document.getElementById('editLessonId').value);
            const model = {
                id: lessonId,
                duration: parseInt(document.getElementById('editDuration').value) || 1,
                frequencyPerWeek: parseInt(document.getElementById('editFrequency').value) || 1,
                description: document.getElementById('editDescription').value,
                specialRequirements: document.getElementById('editSpecialRequirements').value,
                isActive: document.getElementById('editIsActive').checked
            };

            try {
                const response = await fetch('/Admin/Lessons/Dashboard?handler=UpdateLesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(model)
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Properties updated successfully', 'success');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving properties');
            }
        }

        // Toast notification helper
        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            const toastEl = document.createElement('div');
            toastEl.innerHTML = toastHtml;
            const toast = toastEl.firstElementChild;
            toastContainer.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    </script>
}
