@page
@model SchedulingSystem.Pages.Admin.Lessons.DetailsModel
@{
    ViewData["Title"] = "Lesson Details";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4><i class="bi bi-info-circle"></i> Lesson Details</h4>
                </div>
                <div class="card-body">
                    @{
                        var lessonSubject = Model.Lesson.LessonSubjects.FirstOrDefault()?.Subject;
                        var lessonClass = Model.Lesson.LessonClasses.FirstOrDefault()?.Class;
                        var teachers = Model.Lesson.LessonTeachers.OrderByDescending(lt => lt.IsLead).ToList();
                    }
                    <dl class="row">
                        <dt class="col-sm-4">Subject(s)</dt>
                        <dd class="col-sm-8">
                            @if (Model.Lesson.LessonSubjects.Any())
                            {
                                @foreach (var ls in Model.Lesson.LessonSubjects.OrderByDescending(ls => ls.IsPrimary).ThenBy(ls => ls.Order))
                                {
                                    @if (ls.Subject != null)
                                    {
                                        <span class="badge" style="background-color: @ls.Subject.Color">
                                            @ls.Subject.Code
                                        </span>
                                        @ls.Subject.Name
                                        @if (ls.IsPrimary) { <span class="badge bg-primary">Primary</span> }
                                        <br />
                                        <small class="text-muted">Category: @ls.Subject.Category</small><br/>
                                    }
                                }
                            }
                        </dd>

                        <dt class="col-sm-4">Class(es)</dt>
                        <dd class="col-sm-8">
                            @if (Model.Lesson.LessonClasses.Any())
                            {
                                @foreach (var lc in Model.Lesson.LessonClasses.OrderByDescending(lc => lc.IsPrimary).ThenBy(lc => lc.Order))
                                {
                                    @if (lc.Class != null)
                                    {
                                        @lc.Class.Name
                                        @if (lc.IsPrimary) { <span class="badge bg-primary">Primary</span> }
                                        <br />
                                        <small class="text-muted">Year Level: @lc.Class.YearLevel | Students: @lc.Class.StudentCount</small><br/>
                                    }
                                }
                            }
                        </dd>

                        <dt class="col-sm-4">Teacher(s)</dt>
                        <dd class="col-sm-8">
                            @if (teachers.Any())
                            {
                                @foreach (var lt in teachers)
                                {
                                    @if (lt.Teacher != null)
                                    {
                                        @lt.Teacher.FullName
                                        @if (lt.IsLead) { <span class="badge bg-success">Lead</span> }
                                        @if (teachers.Count > 1) { <span class="badge bg-info">Co-Teaching</span> }
                                        <br />
                                        <small class="text-muted">@lt.Teacher.Email</small><br/>
                                    }
                                }
                            }
                        </dd>

                        @if (Model.Lesson.LessonAssignments.Any())
                        {
                            <dt class="col-sm-4">
                                <i class="bi bi-diagram-3"></i> Assignments
                            </dt>
                            <dd class="col-sm-8">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block mb-2">
                                            Teacher-Subject-Class combinations defined for this lesson:
                                        </small>
                                        @foreach (var la in Model.Lesson.LessonAssignments.OrderBy(a => a.Order))
                                        {
                                            <div class="border rounded p-2 mb-1 bg-light">
                                                @if (la.Teacher != null)
                                                {
                                                    <span class="badge bg-primary">@la.Teacher.ShortName</span>
                                                }
                                                @if (la.Subject != null)
                                                {
                                                    <span class="badge bg-secondary">@la.Subject.Code</span>
                                                }
                                                @if (la.Class != null)
                                                {
                                                    <span class="badge bg-info">@la.Class.Name</span>
                                                }
                                                @if (!string.IsNullOrEmpty(la.Notes))
                                                {
                                                    <small class="text-muted ms-2">(@la.Notes)</small>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </dd>
                        }

                        <dt class="col-sm-4">Frequency Per Week</dt>
                        <dd class="col-sm-8">
                            <span class="badge bg-info">@Model.Lesson.FrequencyPerWeek Ã— per week</span>
                        </dd>

                        <dt class="col-sm-4">Duration</dt>
                        <dd class="col-sm-8">@Model.Lesson.Duration minutes (@(Model.Lesson.Duration / 45) period@(Model.Lesson.Duration > 45 ? "s" : ""))</dd>

                        <dt class="col-sm-4">Total Weekly Time</dt>
                        <dd class="col-sm-8">
                            <strong>@(((Model.Lesson.FrequencyPerWeek * Model.Lesson.Duration) / 60.0).ToString("F1")) hours</strong>
                        </dd>

                        <dt class="col-sm-4">Required Room Type</dt>
                        <dd class="col-sm-8">
                            @if (!string.IsNullOrEmpty(Model.Lesson.RequiredRoomType))
                            {
                                <span class="badge bg-secondary">@Model.Lesson.RequiredRoomType</span>
                            }
                            else
                            {
                                <span class="text-muted">Any</span>
                            }
                        </dd>

                        @if (!string.IsNullOrEmpty(Model.Lesson.SpecialRequirements))
                        {
                            <dt class="col-sm-4">Special Requirements</dt>
                            <dd class="col-sm-8">@Model.Lesson.SpecialRequirements</dd>
                        }

                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            @if (Model.Lesson.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </dd>
                    </dl>

                    @if (Model.ScheduledLessonsCount > 0)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-calendar-check"></i>
                            This lesson has <strong>@Model.ScheduledLessonsCount</strong> scheduled instance@(Model.ScheduledLessonsCount > 1 ? "s" : "") in the timetable.
                        </div>
                    }

                    <div class="d-flex justify-content-between">
                        <a asp-page="Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                        <div>
                            <a asp-page="Edit" asp-route-id="@Model.Lesson.Id" class="btn btn-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a asp-page="Delete" asp-route-id="@Model.Lesson.Id" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
