@page
@model SchedulingSystem.Pages.Admin.BreakSupervision.IndexModel
@using SchedulingSystem.Models
@{
    ViewData["Title"] = "Break Supervision";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="bi bi-cup-hot"></i> Break Supervision Duties</h2>
            <p class="text-muted">Manage teacher assignments for break supervision</p>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-page="/Admin/Dashboard">Admin</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Break Supervision</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto">
            <a asp-page="/Admin/Import/Untis" class="btn btn-outline-secondary">
                <i class="bi bi-upload"></i> Import from GPU009
            </a>
        </div>
    </div>

    <!-- Timetable Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label fw-bold"><i class="bi bi-calendar3"></i> Select Timetable</label>
                    <select name="timetableId" asp-items="Model.TimetableList" class="form-select" onchange="this.form.submit()">
                        <option value="">-- Select Timetable --</option>
                    </select>
                </div>
                <div class="col-auto">
                    @if (Model.SelectedTimetable != null)
                    {
                        <span class="badge @(Model.SelectedTimetable.Status == TimetableStatus.Published ? "bg-success" : Model.SelectedTimetable.Status == TimetableStatus.Draft ? "bg-warning text-dark" : "bg-secondary") fs-6">
                            @Model.SelectedTimetable.Status
                        </span>
                    }
                </div>
            </form>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show">
            <i class="bi @(Model.IsSuccess ? "bi-check-circle" : "bi-exclamation-triangle")"></i>
            @Model.StatusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!Model.TimetableId.HasValue)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Please select a timetable to manage break supervision duties.
        </div>
    }
    else if (!Model.Locations.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No break supervision locations found for this timetable.
            <ul class="mb-0 mt-2">
                <li>Import supervision data from <a asp-page="/Admin/Import/Untis" asp-route-timetableId="@Model.TimetableId">GPU009.TXT</a></li>
                <li>Or add a location manually using the form below</li>
            </ul>
        </div>

        <!-- Add Location Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Supervision Location</h5>
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="AddLocation" class="row g-3">
                    <input type="hidden" name="timetableId" value="@Model.TimetableId" />
                    <div class="col-md-6">
                        <label class="form-label">Location Code (must exist in Rooms)</label>
                        <input type="text" name="locationCode" class="form-control" placeholder="e.g., Hof1, oben, unten" required>
                        <small class="text-muted">Enter the Room Number of an existing room</small>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Location
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <!-- Add Location Form (collapsible when data exists) -->
        <div class="mb-4">
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#addLocationForm">
                <i class="bi bi-plus-circle"></i> Add Location
            </button>
            <div class="collapse mt-2" id="addLocationForm">
                <div class="card card-body">
                    <form method="post" asp-page-handler="AddLocation" class="row g-3">
                        <input type="hidden" name="timetableId" value="@Model.TimetableId" />
                        <div class="col-md-4">
                            <label class="form-label">Location Code</label>
                            <input type="text" name="locationCode" class="form-control" placeholder="e.g., Hof1" required>
                        </div>
                        <div class="col-auto align-self-end">
                            <button type="submit" class="btn btn-primary">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Supervision Matrix -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Supervision Schedule Matrix</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0" id="supervisionMatrix">
                        <thead class="table-light">
                            <tr>
                                <th rowspan="2" class="align-middle text-center" style="min-width: 100px;">Location</th>
                                @foreach (var day in Model.Days)
                                {
                                    <th colspan="@Model.Periods.Count" class="text-center">@day.ToString()</th>
                                }
                            </tr>
                            <tr>
                                @foreach (var day in Model.Days)
                                {
                                    @foreach (var period in Model.Periods)
                                    {
                                        <th class="text-center" style="min-width: 120px;">
                                            @Model.GetBreakLabel(period)
                                        </th>
                                    }
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var location in Model.Locations)
                            {
                                <tr>
                                    <td class="fw-bold bg-light">
                                        <i class="bi bi-geo-alt"></i> @location.RoomNumber
                                        @if (!string.IsNullOrEmpty(location.Name) && location.Name != location.RoomNumber)
                                        {
                                            <br><small class="text-muted">@location.Name</small>
                                        }
                                    </td>
                                    @foreach (var day in Model.Days)
                                    {
                                        @foreach (var period in Model.Periods)
                                        {
                                            var duty = Model.GetDuty(location.Id, day, period);
                                            <td class="p-1 text-center duty-cell @(duty?.Teacher != null ? "has-teacher" : "no-teacher")"
                                                data-room-id="@location.Id"
                                                data-day="@((int)day)"
                                                data-period="@period">
                                                @if (duty?.Teacher != null)
                                                {
                                                    <div class="badge bg-success p-2 w-100" style="cursor: pointer;"
                                                         onclick="editDuty(@location.Id, @((int)day), @period, @(duty.TeacherId ?? 0))">
                                                        <i class="bi bi-person-fill"></i>
                                                        @duty.Teacher.FirstName
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="badge bg-secondary bg-opacity-25 text-dark p-2 w-100" style="cursor: pointer;"
                                                         onclick="editDuty(@location.Id, @((int)day), @period, 0)">
                                                        <i class="bi bi-person-plus"></i>
                                                        <span class="text-muted">Assign</span>
                                                    </div>
                                                }
                                            </td>
                                        }
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">@Model.Locations.Count</h3>
                        <p class="text-muted mb-0">Locations</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-success">@Model.Duties.Count(d => d.TeacherId.HasValue)</h3>
                        <p class="text-muted mb-0">Assigned Duties</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">@Model.Duties.Count(d => !d.TeacherId.HasValue)</h3>
                        <p class="text-muted mb-0">Unassigned Slots</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Edit Duty Modal -->
<div class="modal fade" id="editDutyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-gear"></i> Assign Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" asp-page-handler="UpdateDuty">
                <div class="modal-body">
                    <input type="hidden" name="roomId" id="editRoomId">
                    <input type="hidden" name="dayOfWeek" id="editDayOfWeek">
                    <input type="hidden" name="periodNumber" id="editPeriodNumber">
                    <input type="hidden" name="timetableId" value="@Model.TimetableId">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Location</label>
                        <p id="editLocationDisplay" class="form-control-plaintext"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Time Slot</label>
                        <p id="editTimeSlotDisplay" class="form-control-plaintext"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Assign Teacher</label>
                        <select name="teacherId" id="editTeacherId" class="form-select">
                            <option value="">(Unassigned)</option>
                            @foreach (var teacher in Model.TeacherList)
                            {
                                <option value="@teacher.Value">@teacher.Text</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .duty-cell.has-teacher {
        background-color: rgba(25, 135, 84, 0.1);
    }
    .duty-cell.no-teacher {
        background-color: rgba(108, 117, 125, 0.05);
    }
    .duty-cell:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    #supervisionMatrix th, #supervisionMatrix td {
        vertical-align: middle;
    }
</style>

@section Scripts {
    <script>
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Location lookup from server data
        const locations = {
            @foreach (var loc in Model.Locations)
            {
                @:@loc.Id: '@loc.RoomNumber',
            }
        };

        function editDuty(roomId, day, periodNumber, currentTeacherId) {
            document.getElementById('editRoomId').value = roomId;
            document.getElementById('editDayOfWeek').value = day;
            document.getElementById('editPeriodNumber').value = periodNumber;

            // Set display values
            document.getElementById('editLocationDisplay').textContent = locations[roomId] || 'Unknown';
            document.getElementById('editTimeSlotDisplay').textContent = `${dayNames[day]} - Period ${periodNumber}`;

            // Set current teacher
            const teacherSelect = document.getElementById('editTeacherId');
            teacherSelect.value = currentTeacherId > 0 ? currentTeacherId : '';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editDutyModal'));
            modal.show();
        }
    </script>
}
