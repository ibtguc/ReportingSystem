@page
@using SchedulingSystem.Models
@model SchedulingSystem.Pages.Admin.Teachers.ManageAvailabilityModel
@{
    ViewData["Title"] = "Manage Availability";
}

<div class="container mt-4">
    <div class="row mb-3">
        <div class="col">
            <h2><i class="bi bi-clock-history"></i> Manage Teacher Availability</h2>
            <p class="text-muted">Teacher: <strong>@Model.Teacher.FullName</strong> (@Model.Teacher.Email)</p>
        </div>
        <div class="col-auto">
            <a asp-page="Details" asp-route-id="@Model.Teacher.Id" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Teacher
            </a>
        </div>
    </div>

    <!-- Add New Availability Constraint -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Availability Constraint</h5>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="Add" asp-route-id="@Model.Teacher.Id">
                <div class="row">
                    <div class="col-md-3">
                        <label asp-for="NewAvailability.DayOfWeek" class="form-label">Day of Week</label>
                        <select asp-for="NewAvailability.DayOfWeek" class="form-select" asp-items="Model.DayList" required>
                            <option value="">-- Select Day --</option>
                        </select>
                        <span asp-validation-for="NewAvailability.DayOfWeek" class="text-danger"></span>
                    </div>

                    <div class="col-md-3">
                        <label asp-for="NewAvailability.PeriodId" class="form-label">Period</label>
                        <select asp-for="NewAvailability.PeriodId" class="form-select" asp-items="Model.PeriodList" required>
                            <option value="">-- Select Period --</option>
                        </select>
                        <span asp-validation-for="NewAvailability.PeriodId" class="text-danger"></span>
                    </div>

                    <div class="col-md-2">
                        <label asp-for="NewAvailability.Importance" class="form-label">Constraint Level</label>
                        <select asp-for="NewAvailability.Importance" class="form-select" required>
                            <option value="3">Try +3 (strongest)</option>
                            <option value="2">Try +2 (medium)</option>
                            <option value="1">Try +1 (weakest)</option>
                            <option value="0" selected>Neutral (0)</option>
                            <option value="-1">Avoid -1 (weakest)</option>
                            <option value="-2">Avoid -2 (medium)</option>
                            <option value="-3">Avoid -3 (strongest)</option>
                        </select>
                        <span asp-validation-for="NewAvailability.Importance" class="text-danger"></span>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="NewAvailability.Reason" class="form-label">Reason</label>
                        <input asp-for="NewAvailability.Reason" class="form-control" placeholder="e.g., Personal commitment">
                        <span asp-validation-for="NewAvailability.Reason" class="text-danger"></span>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Constraint
                        </button>
                    </div>
                </div>

                <div asp-validation-summary="ModelOnly" class="text-danger mt-2"></div>
            </form>
        </div>
    </div>

    <!-- Weekly Schedule Grid -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Weekly Availability Schedule</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Period</th>
                            <th>Sunday</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                            <th>Thursday</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var days = new[] { DayOfWeek.Sunday, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday };
                        }
                        @foreach (var period in Model.Periods)
                        {
                            <tr>
                                <td class="fw-bold">
                                    @period.Name
                                    <br />
                                    <small class="text-muted">@period.StartTime.ToString(@"hh\:mm") - @period.EndTime.ToString(@"hh\:mm")</small>
                                </td>
                                @foreach (var day in days)
                                {
                                    var constraint = Model.Availabilities.FirstOrDefault(a => a.DayOfWeek == day && a.PeriodId == period.Id);
                                    var bgClass = constraint?.Importance switch
                                    {
                                        3 => "table-success",
                                        2 or 1 => "table-info",
                                        -1 or -2 => "table-warning",
                                        -3 => "table-danger",
                                        _ => ""
                                    };
                                    <td class="text-center @bgClass">
                                        @if (constraint != null)
                                        {
                                            var (badgeClass, label) = constraint.Importance switch
                                            {
                                                3 => ("bg-success", "+3 Try (strongest)"),
                                                2 => ("bg-info", "+2 Try"),
                                                1 => ("bg-light text-dark", "+1 Try"),
                                                0 => ("bg-secondary", "0 Neutral"),
                                                -1 => ("bg-light text-dark border", "-1 Avoid"),
                                                -2 => ("bg-warning text-dark", "-2 Avoid"),
                                                -3 => ("bg-danger", "-3 Avoid (strongest)"),
                                                _ => ("bg-secondary", "Unknown")
                                            };
                                            <div>
                                                <span class="badge @badgeClass">
                                                    @label
                                                </span>
                                                @if (!string.IsNullOrEmpty(constraint.Reason))
                                                {
                                                    <br />
                                                    <small class="text-muted">@constraint.Reason</small>
                                                }
                                                <br />
                                                <div class="btn-group btn-group-sm mt-1" role="group">
                                                    <form method="post" asp-page-handler="ToggleCriticality" asp-route-id="@Model.Teacher.Id" asp-route-availabilityId="@constraint.Id" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary" title="Cycle Criticality">
                                                            <i class="bi bi-arrow-repeat"></i>
                                                        </button>
                                                    </form>
                                                    <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Teacher.Id" asp-route-availabilityId="@constraint.Id" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this constraint?')" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Available</small>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white">
            <div class="row">
                <div class="col-md-6">
                    <strong>Try to schedule:</strong>
                    <span class="badge bg-light text-dark">+1</span> weakest
                    <span class="badge bg-info">+2</span> medium
                    <span class="badge bg-success">+3</span> strongest
                </div>
                <div class="col-md-6">
                    <strong>Avoid scheduling:</strong>
                    <span class="badge bg-light text-dark border">-1</span> weakest
                    <span class="badge bg-warning text-dark">-2</span> medium
                    <span class="badge bg-danger">-3</span> strongest
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12 text-center">
                    <span class="badge bg-secondary">0</span> Neutral (no constraint - available)
                </div>
            </div>
        </div>
    </div>

    <!-- Current Constraints List -->
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> All Constraints (@Model.Availabilities.Count)</h5>
        </div>
        <div class="card-body">
            @if (!Model.Availabilities.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">No availability constraints defined. Teacher is available for all periods by default.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Day</th>
                                <th>Period</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var availability in Model.Availabilities)
                            {
                                var (badgeClass, label) = availability.Importance switch
                                {
                                    3 => ("bg-success", "Try to schedule +3 (strongest)"),
                                    2 => ("bg-info", "Try to schedule +2 (medium)"),
                                    1 => ("bg-light text-dark", "Try to schedule +1 (weakest)"),
                                    0 => ("bg-secondary", "Neutral (0)"),
                                    -1 => ("bg-light text-dark border", "Avoid -1 (weakest)"),
                                    -2 => ("bg-warning text-dark", "Avoid -2 (medium)"),
                                    -3 => ("bg-danger", "Avoid -3 (strongest)"),
                                    _ => ("bg-secondary", "Unknown")
                                };
                                <tr>
                                    <td><strong>@availability.DayOfWeek</strong></td>
                                    <td>
                                        @availability.Period?.Name
                                        <br />
                                        <small class="text-muted">@availability.Period?.StartTime.ToString(@"hh\:mm") - @availability.Period?.EndTime.ToString(@"hh\:mm")</small>
                                    </td>
                                    <td>
                                        <span class="badge @badgeClass">
                                            @label
                                        </span>
                                    </td>
                                    <td>@(availability.Reason ?? "-")</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <form method="post" asp-page-handler="ToggleCriticality" asp-route-id="@Model.Teacher.Id" asp-route-availabilityId="@availability.Id" class="d-inline">
                                                <button type="submit" class="btn btn-outline-primary" title="Cycle Criticality">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </button>
                                            </form>
                                            <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Teacher.Id" asp-route-availabilityId="@availability.Id" class="d-inline">
                                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to remove this constraint?')" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    <!-- Help Section -->
    <div class="alert alert-info mt-4">
        <h6><i class="bi bi-info-circle"></i> About Time Constraints</h6>
        <ul class="mb-0">
            <li><strong>Default Behavior:</strong> Teachers have neutral availability (0) for all periods unless a constraint is added</li>
            <li><strong>Negative Values (-3 to -1):</strong> AVOID scheduling at this time (-3 strongest, -1 weakest)</li>
            <li><strong>Zero (0):</strong> Neutral - no constraint, teacher is available</li>
            <li><strong>Positive Values (+1 to +3):</strong> TRY TO schedule at this time (+1 weakest, +3 strongest)</li>
            <li><strong>Constraint Scale:</strong> -3 (strongest avoidance) → 0 (neutral) → +3 (strongest preference)</li>
            <li><strong>Impact:</strong> Scheduling algorithms use these as penalties (negative) or bonuses (positive) when assigning lessons</li>
            <li><strong>Tip:</strong> Click the <i class="bi bi-arrow-repeat"></i> button to cycle through constraint levels</li>
        </ul>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
