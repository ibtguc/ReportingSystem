@page "{id:int}"
@using ReportingSystem.Models
@using System.Text.Json
@model ReportingSystem.Pages.Admin.Reports.ViewModel
@{
    ViewData["Title"] = $"Report #{Model.Report.Id}";
}

<div class="container mt-4">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Report Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>
                <i class="bi bi-file-earmark-text"></i> @Model.Report.ReportTemplate.Name
                <span class="badge @ReportStatus.BadgeClass(Model.Report.Status) fs-6">@Model.Report.StatusDisplayName</span>
                @if (Model.Report.IsLocked)
                {
                    <span class="badge bg-dark fs-6"><i class="bi bi-lock-fill"></i> Locked</span>
                }
            </h2>
            <p class="mb-1">
                <strong>Period:</strong> @Model.Report.ReportPeriod.Name
                (@Model.Report.ReportPeriod.StartDate.ToString("MMM dd") - @Model.Report.ReportPeriod.EndDate.ToString("MMM dd, yyyy"))
            </p>
        </div>
        <div class="btn-group">
            @if (Model.Report.IsEditable)
            {
                <a asp-page="Fill" asp-route-id="@Model.Report.Id" class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
            }
            <a asp-page="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Report Meta -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header"><h6 class="mb-0">Report Info</h6></div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Author</dt>
                        <dd class="col-sm-7">
                            @Model.Report.SubmittedBy.Name
                            @if (Model.Report.SubmittedBy.OrganizationalUnit != null)
                            {
                                <br /><small class="text-muted">@Model.Report.SubmittedBy.OrganizationalUnit.Name</small>
                            }
                        </dd>

                        <dt class="col-sm-5">Created</dt>
                        <dd class="col-sm-7">@Model.Report.CreatedAt.ToString("MMM dd, yyyy HH:mm")</dd>

                        @if (Model.Report.SubmittedAt.HasValue)
                        {
                            <dt class="col-sm-5">Submitted</dt>
                            <dd class="col-sm-7">@Model.Report.SubmittedAt.Value.ToString("MMM dd, yyyy HH:mm")</dd>
                        }

                        @if (Model.Report.ReviewedAt.HasValue)
                        {
                            <dt class="col-sm-5">Reviewed</dt>
                            <dd class="col-sm-7">@Model.Report.ReviewedAt.Value.ToString("MMM dd, yyyy HH:mm")</dd>
                        }

                        @if (Model.Report.AssignedReviewer != null)
                        {
                            <dt class="col-sm-5">Reviewer</dt>
                            <dd class="col-sm-7">@Model.Report.AssignedReviewer.Name</dd>
                        }

                        @if (Model.Report.AmendmentCount > 0)
                        {
                            <dt class="col-sm-5">Amendments</dt>
                            <dd class="col-sm-7">@Model.Report.AmendmentCount</dd>
                        }
                    </dl>
                </div>
            </div>
        </div>

        <!-- Review Actions -->
        @if (Model.Report.Status == ReportStatus.Submitted || Model.Report.Status == ReportStatus.UnderReview)
        {
            <div class="col-md-6">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> Review Actions</h6>
                    </div>
                    <div class="card-body">
                        <form method="post" asp-page-handler="Review" asp-route-id="@Model.Report.Id">
                            <div class="mb-3">
                                <label asp-for="ReviewComments" class="form-label">Comments</label>
                                <textarea asp-for="ReviewComments" class="form-control" rows="3"
                                          placeholder="Add review comments..."></textarea>
                                <span asp-validation-for="ReviewComments" class="text-danger"></span>
                            </div>
                            <div class="btn-group w-100">
                                @if (Model.Report.Status == ReportStatus.Submitted)
                                {
                                    <button type="submit" name="ReviewAction" value="review"
                                            class="btn btn-warning">
                                        <i class="bi bi-search"></i> Start Review
                                    </button>
                                }
                                <button type="submit" name="ReviewAction" value="approve"
                                        class="btn btn-success"
                                        onclick="return confirm('Approve this report?');">
                                    <i class="bi bi-check-circle"></i> Approve
                                </button>
                                <button type="submit" name="ReviewAction" value="reject"
                                        class="btn btn-danger"
                                        onclick="return confirm('Reject this report?');">
                                    <i class="bi bi-x-circle"></i> Reject
                                </button>
                                <button type="submit" name="ReviewAction" value="amend"
                                        class="btn btn-outline-primary"
                                        onclick="return confirm('Send back for amendment?');">
                                    <i class="bi bi-pencil-square"></i> Amend
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        }
        else if (!string.IsNullOrEmpty(Model.Report.ReviewComments))
        {
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header"><h6 class="mb-0">Review Comments</h6></div>
                    <div class="card-body">
                        <p>@Model.Report.ReviewComments</p>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Report Data -->
    @{
        var sections = Model.Fields
            .GroupBy(f => f.Section ?? "General")
            .OrderBy(g => g.Min(f => f.SectionOrder));
    }

    @foreach (var section in sections)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0">@(section.Key)</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    @foreach (var field in section.OrderBy(f => f.FieldOrder))
                    {
                        var fieldValue = Model.FieldValues.GetValueOrDefault(field.Id);
                        var displayValue = fieldValue?.Value;

                        <dt class="col-sm-4">
                            @field.Label
                            <small class="text-muted">(@field.TypeDisplayName)</small>
                        </dt>
                        <dd class="col-sm-8">
                            @if (string.IsNullOrEmpty(displayValue))
                            {
                                <span class="text-muted fst-italic">Not provided</span>
                            }
                            else if (field.Type == FieldType.Checkbox)
                            {
                                @if (displayValue == "true")
                                {
                                    <i class="bi bi-check-circle-fill text-success"></i> <text>Yes</text>
                                }
                                else
                                {
                                    <i class="bi bi-x-circle text-secondary"></i> <text>No</text>
                                }
                            }
                            else if (field.Type == FieldType.RichText)
                            {
                                <div class="border rounded p-2 bg-light">@Html.Raw(displayValue)</div>
                            }
                            else if (field.Type == FieldType.Numeric && fieldValue?.NumericValue.HasValue == true)
                            {
                                <strong>@fieldValue.NumericValue.Value.ToString("N2")</strong>
                            }
                            else
                            {
                                @displayValue
                            }
                        </dd>
                    }
                </dl>
            </div>
        </div>
    }

    @if (Model.Attachments.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-paperclip"></i> Attachments (@Model.Attachments.Count)</h5>
            </div>
            <div class="list-group list-group-flush">
                @foreach (var attachment in Model.Attachments)
                {
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-file-earmark"></i>
                            <strong>@attachment.OriginalFileName</strong>
                            <small class="text-muted ms-2">@attachment.FileSizeDisplay</small>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Upward Flow Sections (Phase 4) -->
    @if (Model.Report.ReportTemplate.IncludeSuggestedActions && Model.SuggestedActions.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Suggested Actions (@Model.SuggestedActions.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Timeline</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var action in Model.SuggestedActions)
                            {
                                <tr>
                                    <td>
                                        <strong>@action.Title</strong>
                                        @if (!string.IsNullOrEmpty(action.Description))
                                        {
                                            <br /><small class="text-muted">@action.Description</small>
                                        }
                                        @if (!string.IsNullOrEmpty(action.Justification))
                                        {
                                            <br /><small><strong>Justification:</strong> @action.Justification</small>
                                        }
                                        @if (!string.IsNullOrEmpty(action.ExpectedOutcome))
                                        {
                                            <br /><small><strong>Expected Outcome:</strong> @action.ExpectedOutcome</small>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@ActionCategory.DisplayName(action.Category)</span></td>
                                    <td><span class="badge @ActionPriority.BadgeClass(action.Priority)">@action.Priority</span></td>
                                    <td>
                                        <span class="badge @ActionStatus.BadgeClass(action.Status)">@ActionStatus.DisplayName(action.Status)</span>
                                        @if (action.ReviewedBy != null)
                                        {
                                            <br /><small class="text-muted">by @action.ReviewedBy.Name</small>
                                        }
                                    </td>
                                    <td>@(action.Timeline ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (Model.Report.ReportTemplate.IncludeNeededResources && Model.ResourceRequests.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Resource Requests (@Model.ResourceRequests.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Urgency</th>
                                <th>Est. Cost</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.ResourceRequests)
                            {
                                <tr>
                                    <td>
                                        <strong>@request.Title</strong>
                                        @if (!string.IsNullOrEmpty(request.Quantity))
                                        {
                                            <span class="badge bg-secondary ms-1">Qty: @request.Quantity</span>
                                        }
                                        @if (!string.IsNullOrEmpty(request.Description))
                                        {
                                            <br /><small class="text-muted">@request.Description</small>
                                        }
                                        @if (!string.IsNullOrEmpty(request.Justification))
                                        {
                                            <br /><small><strong>Justification:</strong> @request.Justification</small>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@ResourceCategory.DisplayName(request.Category)</span></td>
                                    <td><span class="badge @ResourceUrgency.BadgeClass(request.Urgency)">@request.Urgency</span></td>
                                    <td>
                                        @if (request.EstimatedCost.HasValue)
                                        {
                                            <text>@request.EstimatedCost.Value.ToString("N2") @request.Currency</text>
                                            @if (request.ApprovedAmount.HasValue)
                                            {
                                                <br /><small class="text-success">Approved: @request.ApprovedAmount.Value.ToString("N2")</small>
                                            }
                                        }
                                        else
                                        {
                                            <text>-</text>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @ResourceStatus.BadgeClass(request.Status)">@ResourceStatus.DisplayName(request.Status)</span>
                                        @if (request.ReviewedBy != null)
                                        {
                                            <br /><small class="text-muted">by @request.ReviewedBy.Name</small>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (Model.Report.ReportTemplate.IncludeNeededSupport && Model.SupportRequests.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-life-preserver"></i> Support Requests (@Model.SupportRequests.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Urgency</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var request in Model.SupportRequests)
                            {
                                <tr>
                                    <td>
                                        <strong>@request.Title</strong>
                                        @if (!string.IsNullOrEmpty(request.Description))
                                        {
                                            <br /><small class="text-muted">@request.Description</small>
                                        }
                                        @if (!string.IsNullOrEmpty(request.CurrentSituation))
                                        {
                                            <br /><small><strong>Current:</strong> @request.CurrentSituation</small>
                                        }
                                        @if (!string.IsNullOrEmpty(request.DesiredOutcome))
                                        {
                                            <br /><small><strong>Desired:</strong> @request.DesiredOutcome</small>
                                        }
                                        @if (!string.IsNullOrEmpty(request.Resolution))
                                        {
                                            <br /><small class="text-success"><strong>Resolution:</strong> @request.Resolution</small>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@SupportCategory.DisplayName(request.Category)</span></td>
                                    <td><span class="badge @SupportUrgency.BadgeClass(request.Urgency)">@request.Urgency</span></td>
                                    <td><span class="badge @SupportStatus.BadgeClass(request.Status)">@SupportStatus.DisplayName(request.Status)</span></td>
                                    <td>@(request.AssignedTo?.Name ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Confirmation Tags (Phase 5) -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-person-check"></i> Confirmation Requests (@Model.ConfirmationTags.Count)</h5>
            <button class="btn btn-sm btn-outline-dark" type="button" data-bs-toggle="collapse" data-bs-target="#addConfirmationForm">
                <i class="bi bi-plus"></i> Request Confirmation
            </button>
        </div>
        <div class="card-body">
            <!-- Add Confirmation Form -->
            <div class="collapse mb-3" id="addConfirmationForm">
                <div class="border rounded p-3 bg-light">
                    <h6><i class="bi bi-person-plus"></i> Request Confirmation from User</h6>
                    <form method="post" asp-page-handler="AddConfirmationTag" asp-route-id="@Model.Report.Id">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Tag User *</label>
                                <select name="TagUserId" class="form-select" required>
                                    <option value="">Select user...</option>
                                    @foreach (var user in Model.AvailableUsers.Where(u => u.Id != Model.Report.SubmittedById))
                                    {
                                        <option value="@user.Id">@user.Name (@user.Email)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Section (optional)</label>
                                <input type="text" name="TagSectionReference" class="form-control" placeholder="e.g., Key Metrics" />
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Message (optional)</label>
                                <input type="text" name="TagMessage" class="form-control" placeholder="Please verify these figures..." />
                            </div>
                        </div>
                        <button type="submit" class="btn btn-warning"><i class="bi bi-send"></i> Send Request</button>
                    </form>
                </div>
            </div>

            @if (Model.ConfirmationTags.Count == 0)
            {
                <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No confirmation requests for this report.</p>
            }
            else
            {
                <div class="list-group">
                    @foreach (var tag in Model.ConfirmationTags)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>@tag.TaggedUser.Name</strong>
                                    <span class="badge @ConfirmationStatus.BadgeClass(tag.Status) ms-2">@ConfirmationStatus.DisplayName(tag.Status)</span>
                                    @if (!string.IsNullOrEmpty(tag.SectionReference))
                                    {
                                        <br /><small class="text-muted">Section: @tag.SectionReference</small>
                                    }
                                    @if (!string.IsNullOrEmpty(tag.Message))
                                    {
                                        <br /><small>@tag.Message</small>
                                    }
                                    @if (!string.IsNullOrEmpty(tag.Response))
                                    {
                                        <br /><small class="text-info"><strong>Response:</strong> @tag.Response</small>
                                    }
                                    <br /><small class="text-muted">Requested by @tag.RequestedBy.Name on @tag.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                                    @if (tag.RespondedAt.HasValue)
                                    {
                                        <small class="text-muted"> | Responded @tag.RespondedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                                    }
                                </div>
                                <div>
                                    @if (tag.IsPending)
                                    {
                                        <!-- Response form for tagged user -->
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                Respond
                                            </button>
                                            <div class="dropdown-menu p-3" style="min-width: 280px;">
                                                <form method="post" asp-page-handler="RespondToConfirmation" asp-route-id="@Model.Report.Id" asp-route-tagId="@tag.Id">
                                                    <div class="mb-2">
                                                        <label class="form-label">Response (optional)</label>
                                                        <textarea name="ConfirmationResponse" class="form-control" rows="2" placeholder="Add a note..."></textarea>
                                                    </div>
                                                    <div class="d-flex gap-1">
                                                        <button type="submit" name="ConfirmationAction" value="@ConfirmationStatus.Confirmed" class="btn btn-sm btn-success">
                                                            <i class="bi bi-check"></i> Confirm
                                                        </button>
                                                        <button type="submit" name="ConfirmationAction" value="@ConfirmationStatus.RevisionRequested" class="btn btn-sm btn-warning">
                                                            <i class="bi bi-pencil"></i> Request Revision
                                                        </button>
                                                        <button type="submit" name="ConfirmationAction" value="@ConfirmationStatus.Declined" class="btn btn-sm btn-danger">
                                                            <i class="bi bi-x"></i> Decline
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <form method="post" asp-page-handler="CancelConfirmation" asp-route-id="@Model.Report.Id" asp-route-tagId="@tag.Id" class="d-inline ms-1">
                                            <button type="submit" class="btn btn-sm btn-outline-secondary" onclick="return confirm('Cancel this confirmation request?');">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Comments (Phase 5) -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Discussion (@Model.Comments.Count comments)</h5>
        </div>
        <div class="card-body">
            <!-- Add Comment Form -->
            <form method="post" asp-page-handler="AddComment" asp-route-id="@Model.Report.Id" class="mb-3">
                <div class="mb-2">
                    <textarea name="NewCommentContent" class="form-control" rows="2" placeholder="Add a comment..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-send"></i> Post Comment</button>
            </form>

            @if (Model.Comments.Count == 0)
            {
                <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No comments yet. Be the first to comment!</p>
            }
            else
            {
                <div class="list-group">
                    @foreach (var comment in Model.Comments)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>@comment.Author.Name</strong>
                                    <small class="text-muted ms-2">@comment.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                                    @if (comment.IsEdited)
                                    {
                                        <small class="text-muted">(edited)</small>
                                    }
                                </div>
                                <form method="post" asp-page-handler="DeleteComment" asp-route-id="@Model.Report.Id" asp-route-commentId="@comment.Id">
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0" onclick="return confirm('Delete this comment?');">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                            <p class="mb-1 mt-1">@comment.Content</p>

                            <!-- Replies -->
                            @if (comment.Replies.Any())
                            {
                                <div class="ms-4 mt-2 border-start ps-3">
                                    @foreach (var reply in comment.Replies.OrderBy(r => r.CreatedAt))
                                    {
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong>@reply.Author.Name</strong>
                                                    <small class="text-muted ms-2">@reply.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                                                </div>
                                                <form method="post" asp-page-handler="DeleteComment" asp-route-id="@Model.Report.Id" asp-route-commentId="@reply.Id">
                                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0" onclick="return confirm('Delete this reply?');">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            <p class="mb-0 small">@reply.Content</p>
                                        </div>
                                    }
                                </div>
                            }

                            <!-- Reply Form -->
                            <div class="mt-2">
                                <button class="btn btn-sm btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#reply-@comment.Id">
                                    <i class="bi bi-reply"></i> Reply
                                </button>
                                <div class="collapse mt-2" id="reply-@comment.Id">
                                    <form method="post" asp-page-handler="AddComment" asp-route-id="@Model.Report.Id">
                                        <input type="hidden" name="ReplyToCommentId" value="@comment.Id" />
                                        <div class="input-group input-group-sm">
                                            <input type="text" name="NewCommentContent" class="form-control" placeholder="Write a reply..." required />
                                            <button type="submit" class="btn btn-outline-primary"><i class="bi bi-send"></i></button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Downward Flow Sections (Phase 6) -->

    <!-- Feedback -->
    @if (Model.Feedbacks.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-chat-square-text"></i> Management Feedback (@Model.Feedbacks.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @foreach (var feedback in Model.Feedbacks)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge @FeedbackCategory.BadgeClass(feedback.Category) me-2">
                                            <i class="bi @FeedbackCategory.Icon(feedback.Category)"></i>
                                            @FeedbackCategory.DisplayName(feedback.Category)
                                        </span>
                                        <span class="badge @FeedbackVisibility.BadgeClass(feedback.Visibility) me-2">
                                            @FeedbackVisibility.DisplayName(feedback.Visibility)
                                        </span>
                                        <span class="badge @FeedbackStatus.BadgeClass(feedback.Status)">
                                            @FeedbackStatus.DisplayName(feedback.Status)
                                        </span>
                                    </div>
                                    <h6 class="mb-1">@feedback.Subject</h6>
                                    <p class="mb-1">@feedback.Content</p>
                                    @if (!string.IsNullOrEmpty(feedback.SectionReference))
                                    {
                                        <small class="text-muted">Section: @feedback.SectionReference</small>
                                    }
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            By <strong>@feedback.Author.Name</strong> on @feedback.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                        </small>
                                    </div>

                                    @if (feedback.IsAcknowledged)
                                    {
                                        <div class="mt-2 p-2 bg-success bg-opacity-10 rounded">
                                            <small class="text-success">
                                                <i class="bi bi-check-circle"></i> Acknowledged
                                                @if (feedback.AcknowledgedAt.HasValue)
                                                {
                                                    <text>on @feedback.AcknowledgedAt.Value.ToString("MMM dd, yyyy")</text>
                                                }
                                            </small>
                                            @if (!string.IsNullOrEmpty(feedback.AcknowledgmentResponse))
                                            {
                                                <br /><small>@feedback.AcknowledgmentResponse</small>
                                            }
                                        </div>
                                    }
                                    else if (feedback.RequiresAcknowledgment)
                                    {
                                        <div class="mt-2">
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-clock"></i> Pending Acknowledgment
                                            </span>
                                        </div>
                                    }

                                    @if (feedback.Replies.Any())
                                    {
                                        <div class="ms-3 mt-2 border-start ps-3">
                                            @foreach (var reply in feedback.Replies.OrderBy(r => r.CreatedAt))
                                            {
                                                <div class="mb-2">
                                                    <small><strong>@reply.Author.Name</strong> replied:</small>
                                                    <p class="mb-0 small">@reply.Content</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Recommendations -->
    @if (Model.Recommendations.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-signpost-2"></i> Recommendations (@Model.Recommendations.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Target</th>
                                <th>Status</th>
                                <th>Due</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rec in Model.Recommendations)
                            {
                                <tr class="@(rec.IsOverdue ? "table-danger" : "")">
                                    <td>
                                        <strong>@rec.Title</strong>
                                        <br /><small class="text-muted">@(rec.Description.Length > 80 ? rec.Description.Substring(0, 80) + "..." : rec.Description)</small>
                                        @if (!string.IsNullOrEmpty(rec.Rationale))
                                        {
                                            <br /><small><strong>Rationale:</strong> @rec.Rationale</small>
                                        }
                                        <br /><small class="text-muted">Issued by @rec.IssuedBy.Name</small>
                                    </td>
                                    <td>
                                        <span class="badge @RecommendationCategory.BadgeClass(rec.Category)">
                                            @RecommendationCategory.DisplayName(rec.Category)
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @RecommendationPriority.BadgeClass(rec.Priority)">
                                            @rec.Priority
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @RecommendationScope.BadgeClass(rec.TargetScope)">
                                            @RecommendationScope.DisplayName(rec.TargetScope)
                                        </span>
                                        @if (rec.TargetOrgUnit != null)
                                        {
                                            <br /><small>@rec.TargetOrgUnit.Name</small>
                                        }
                                        @if (rec.TargetUser != null)
                                        {
                                            <br /><small>@rec.TargetUser.Name</small>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @RecommendationStatus.BadgeClass(rec.Status)">
                                            @RecommendationStatus.DisplayName(rec.Status)
                                        </span>
                                    </td>
                                    <td>
                                        @if (rec.DueDate.HasValue)
                                        {
                                            <small>@rec.DueDate.Value.ToString("MMM dd, yyyy")</small>
                                            @if (rec.IsOverdue)
                                            {
                                                <br /><span class="badge bg-danger">Overdue</span>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Decisions -->
    @if (Model.Decisions.Count > 0)
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Decisions (@Model.Decisions.Count)</h5>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    @foreach (var decision in Model.Decisions)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <span class="badge @DecisionRequestType.BadgeClass(decision.RequestType) me-2">
                                            <i class="bi @DecisionRequestType.Icon(decision.RequestType)"></i>
                                            @DecisionRequestType.DisplayName(decision.RequestType)
                                        </span>
                                        <span class="badge @DecisionOutcome.BadgeClass(decision.Outcome)">
                                            <i class="bi @DecisionOutcome.Icon(decision.Outcome)"></i>
                                            @DecisionOutcome.DisplayName(decision.Outcome)
                                        </span>
                                    </div>
                                    <h6 class="mb-1">@decision.Title</h6>
                                    <p class="mb-1"><strong>Justification:</strong> @decision.Justification</p>
                                    <small class="text-muted">Related to: @decision.RelatedRequestTitle</small>
                                    @if (!string.IsNullOrEmpty(decision.Conditions))
                                    {
                                        <p class="mb-1 mt-1"><small><strong>Conditions:</strong> @decision.Conditions</small></p>
                                    }
                                    @if (!string.IsNullOrEmpty(decision.Modifications))
                                    {
                                        <p class="mb-1"><small><strong>Modifications:</strong> @decision.Modifications</small></p>
                                    }
                                    @if (decision.ApprovedAmount.HasValue)
                                    {
                                        <p class="mb-1">
                                            <span class="badge bg-success">
                                                Approved: @decision.Currency @decision.ApprovedAmount.Value.ToString("N2")
                                            </span>
                                        </p>
                                    }
                                    @if (decision.EffectiveDate.HasValue)
                                    {
                                        <small class="text-muted">Effective: @decision.EffectiveDate.Value.ToString("MMM dd, yyyy")</small>
                                    }
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            Decided by <strong>@decision.DecidedBy.Name</strong> on @decision.CreatedAt.ToString("MMM dd, yyyy")
                                        </small>
                                    </div>

                                    @if (decision.IsAcknowledged)
                                    {
                                        <div class="mt-2 p-2 bg-success bg-opacity-10 rounded">
                                            <small class="text-success">
                                                <i class="bi bi-check-circle"></i> Acknowledged
                                                @if (decision.AcknowledgedAt.HasValue)
                                                {
                                                    <text>on @decision.AcknowledgedAt.Value.ToString("MMM dd, yyyy")</text>
                                                }
                                            </small>
                                            @if (!string.IsNullOrEmpty(decision.AcknowledgmentResponse))
                                            {
                                                <br /><small>@decision.AcknowledgmentResponse</small>
                                            }
                                        </div>
                                    }
                                    else if (decision.Outcome != DecisionOutcome.Pending)
                                    {
                                        <div class="mt-2">
                                            <span class="badge bg-warning text-dark">
                                                <i class="bi bi-clock"></i> Pending Acknowledgment
                                            </span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>
