@using ReportingSystem.Models
@model (Committee committee, ReportingSystem.Pages.Admin.Organization.IndexModel pageModel, int depth)
@{
    var (committee, pageModel, depth) = Model;
    var children = pageModel.GetChildren(committee.Id);
    var hasChildren = children.Any();
    var heads = committee.Memberships.Where(m => m.Role == CommitteeRole.Head && m.EffectiveTo == null).ToList();
    var members = committee.Memberships.Where(m => m.Role == CommitteeRole.Member && m.EffectiveTo == null).ToList();
    var levelBadge = committee.HierarchyLevel switch {
        HierarchyLevel.TopLevel => ("bg-danger", "L0"),
        HierarchyLevel.Directors => ("bg-warning text-dark", "L1"),
        HierarchyLevel.Functions => ("bg-info", "L2"),
        HierarchyLevel.Processes => ("bg-success", "L3"),
        HierarchyLevel.Tasks => ("bg-secondary", "L4"),
        _ => ("bg-secondary", "?")
    };
}

<div class="tree-node" style="margin-left: @(depth * 24)px;">
    <div class="d-flex align-items-center py-1 border-bottom">
        @if (hasChildren)
        {
            <a href="javascript:void(0)" onclick="toggleChildren(@committee.Id)" class="text-decoration-none me-1">
                <i id="icon-@committee.Id" class="bi bi-chevron-right"></i>
            </a>
        }
        else
        {
            <span class="me-1" style="width:16px;display:inline-block;"></span>
        }

        <span class="badge @levelBadge.Item1 me-2">@levelBadge.Item2</span>

        <a asp-page="Committees/Details" asp-route-id="@committee.Id" asp-route-returnTo="org" class="text-decoration-none fw-semibold me-2">
            @committee.Name
        </a>

        @if (!string.IsNullOrEmpty(committee.Sector))
        {
            <span class="badge bg-light text-dark border me-2">@committee.Sector</span>
        }

        @if (heads.Any())
        {
            <small class="text-muted me-2">
                <i class="bi bi-person-fill-gear"></i>
                @foreach (var h in heads) { if (h != heads.First()) { <text>, </text> } <a asp-page="/Admin/Users/Details" asp-route-id="@h.UserId" asp-route-returnTo="org" class="text-decoration-none">@h.User.Name</a> }
            </small>
        }

        <small class="text-muted ms-auto">
            @(heads.Count + members.Count) member(s)
            @if (hasChildren)
            {
                <text> | @children.Count sub</text>
            }
        </small>

        <div class="btn-group btn-group-sm ms-2">
            <a asp-page="Committees/Details" asp-route-id="@committee.Id" asp-route-returnTo="org" class="btn btn-outline-info btn-sm" title="Details">
                <i class="bi bi-eye"></i>
            </a>
            <a asp-page="Committees/Edit" asp-route-id="@committee.Id" class="btn btn-outline-primary btn-sm" title="Edit">
                <i class="bi bi-pencil"></i>
            </a>
        </div>
    </div>

    @if (hasChildren)
    {
        <div id="children-@committee.Id" class="d-none">
            @foreach (var child in children)
            {
                @await Html.PartialAsync("_CommitteeTreeNode", (child, pageModel, depth + 1))
            }
        </div>
    }
</div>
