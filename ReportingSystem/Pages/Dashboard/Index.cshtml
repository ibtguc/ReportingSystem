@page
@model ReportingSystem.Pages.Dashboard.IndexModel
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h2><i class="bi bi-speedometer2"></i> My Dashboard</h2>
    <span class="badge bg-primary fs-6">@Model.UserRole</span>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- ═══ Chairman Dashboard ═══ -->
@if (Model.ChairmanData != null)
{
    <div class="card border-danger mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-star-fill"></i> Executive Overview</h5>
        </div>
        <div class="card-body">
            <!-- Health Metrics -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-primary">@Model.ChairmanData.ReportsSubmittedThisMonth</div>
                            <small class="text-muted">Reports (30d)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-info">@Model.ChairmanData.DirectivesIssuedThisMonth</div>
                            <small class="text-muted">Directives (30d)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-success">@Model.ChairmanData.MeetingsHeldThisMonth</div>
                            <small class="text-muted">Meetings (30d)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center @(Model.ChairmanData.TotalOverdueItems > 0 ? "border-danger" : "")">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-danger">@Model.ChairmanData.TotalOverdueItems</div>
                            <small class="text-muted">Overdue Items</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <!-- Pending Executive Summaries -->
                <div class="col-md-6">
                    <h6><i class="bi bi-file-earmark-text"></i> Pending Executive Summaries</h6>
                    @if (Model.ChairmanData.PendingExecutiveSummaries.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var r in Model.ChairmanData.PendingExecutiveSummaries)
                            {
                                <a href="/Reports/Details/@r.Id" class="list-group-item list-group-item-action py-2">
                                    <div class="d-flex justify-content-between">
                                        <small class="fw-bold">@r.Title</small>
                                        <span class="badge bg-info">@r.Status</span>
                                    </div>
                                    <small class="text-muted">@r.Author?.Name — @r.CreatedAt.ToString("dd MMM")</small>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small">No pending executive summaries.</p>
                    }
                </div>

                <!-- Overdue Directives -->
                <div class="col-md-6">
                    <h6><i class="bi bi-exclamation-triangle text-danger"></i> Overdue Directives</h6>
                    @if (Model.ChairmanData.OverdueDirectives.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var d in Model.ChairmanData.OverdueDirectives)
                            {
                                <a href="/Directives/Details/@d.Id" class="list-group-item list-group-item-action py-2 list-group-item-danger">
                                    <div class="d-flex justify-content-between">
                                        <small class="fw-bold">@d.Title</small>
                                        <span class="badge bg-danger">@d.Deadline?.ToString("dd MMM")</span>
                                    </div>
                                    <small class="text-muted">@d.TargetCommittee?.Name — @d.Status</small>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small">No overdue directives.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

<!-- ═══ Chairman's Office Dashboard ═══ -->
@if (Model.OfficeData != null)
{
    <div class="card border-warning mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-building"></i> Chairman's Office Bridge</h5>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-primary">@Model.OfficeData.ReportsAwaitingReview</div>
                            <small class="text-muted">Reports Awaiting Approval</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-info">@Model.OfficeData.ActiveDirectives</div>
                            <small class="text-muted">Active Directives</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="fs-4 fw-bold text-success">@Model.OfficeData.UpcomingMeetings</div>
                            <small class="text-muted">Upcoming Meetings</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <h6><i class="bi bi-arrow-down-circle text-info"></i> Incoming Reports (L0)</h6>
                    @if (Model.OfficeData.IncomingReports.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var r in Model.OfficeData.IncomingReports.Take(5))
                            {
                                <a href="/Reports/Details/@r.Id" class="list-group-item list-group-item-action py-2">
                                    <small class="fw-bold">@r.Title</small>
                                    <br /><small class="text-muted">@r.Author?.Name — @r.Status</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No incoming reports.</p> }
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-arrow-up-circle text-success"></i> Executive Summaries</h6>
                    @if (Model.OfficeData.OutgoingExecutiveSummaries.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var r in Model.OfficeData.OutgoingExecutiveSummaries.Take(5))
                            {
                                <a href="/Reports/Details/@r.Id" class="list-group-item list-group-item-action py-2">
                                    <small class="fw-bold">@r.Title</small>
                                    <br /><small class="text-muted">@r.Status — @r.CreatedAt.ToString("dd MMM")</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No executive summaries.</p> }
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-megaphone text-warning"></i> Pending Directive Relays</h6>
                    @if (Model.OfficeData.PendingDirectiveRelays.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var d in Model.OfficeData.PendingDirectiveRelays.Take(5))
                            {
                                <a href="/Directives/Details/@d.Id" class="list-group-item list-group-item-action py-2">
                                    <small class="fw-bold">@d.Title</small>
                                    <br /><small class="text-muted">@d.Issuer?.Name — @d.Status</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No pending relays.</p> }
                </div>
            </div>
        </div>
    </div>
}

<!-- ═══ Committee Head Dashboard ═══ -->
@if (Model.HeadData != null)
{
    <div class="card border-info mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-people-fill"></i> Committee Management
                <small>(@string.Join(", ", Model.HeadData.ManagedCommittees.Select(c => c.Name)))</small>
            </h5>
        </div>
        <div class="card-body">
            @if (Model.HeadData.FinalizableReports.Any())
            {
                <div class="alert alert-warning d-flex align-items-center mb-3">
                    <i class="bi bi-clock-history fs-4 me-2"></i>
                    <div>
                        <strong>@Model.HeadData.FinalizableReports.Count report(s) past 3-day deadline</strong> — you can finalize these now.
                        @foreach (var r in Model.HeadData.FinalizableReports)
                        {
                            <a href="/Reports/Details/@r.Id" class="badge bg-warning text-dark text-decoration-none ms-1">@r.Title</a>
                        }
                    </div>
                </div>
            }
            <div class="row g-3">
                <div class="col-md-3">
                    <h6><i class="bi bi-check2-square"></i> Awaiting Approval</h6>
                    @if (Model.HeadData.PendingReports.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var r in Model.HeadData.PendingReports.Take(5))
                            {
                                var approvedCount = r.Approvals?.Count ?? 0;
                                <a href="/Reports/Details/@r.Id" class="list-group-item list-group-item-action py-2">
                                    <div class="d-flex justify-content-between">
                                        <small class="fw-bold">@r.Title</small>
                                        <span class="badge bg-info">@approvedCount approved</span>
                                    </div>
                                    <small class="text-muted">@r.Author?.Name — @r.Committee?.Name</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No reports awaiting approval.</p> }
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-megaphone"></i> Open Directives</h6>
                    @if (Model.HeadData.OpenDirectives.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var d in Model.HeadData.OpenDirectives.Take(5))
                            {
                                <a href="/Directives/Details/@d.Id" class="list-group-item list-group-item-action py-2">
                                    <small class="fw-bold">@d.Title</small>
                                    <br /><small class="text-muted">@d.Status @(d.Deadline.HasValue ? $"— Due {d.Deadline.Value:dd MMM}" : "")</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No open directives.</p> }
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-calendar-event"></i> Upcoming Meetings</h6>
                    @if (Model.HeadData.UpcomingMeetings.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var m in Model.HeadData.UpcomingMeetings.Take(5))
                            {
                                <a href="/Meetings/Details/@m.Id" class="list-group-item list-group-item-action py-2">
                                    <small class="fw-bold">@m.Title</small>
                                    <br /><small class="text-muted">@m.ScheduledAt.ToString("dd MMM HH:mm") — @m.Committee?.Name</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No upcoming meetings.</p> }
                </div>
                <div class="col-md-3">
                    <h6><i class="bi bi-exclamation-triangle text-danger"></i> Overdue Actions</h6>
                    @if (Model.HeadData.OverdueActionItems.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var a in Model.HeadData.OverdueActionItems.Take(5))
                            {
                                <a href="/Meetings/ActionItems" class="list-group-item list-group-item-action py-2 list-group-item-danger">
                                    <small class="fw-bold">@a.Title</small>
                                    <br /><small class="text-muted">@a.AssignedTo?.Name — Due @a.Deadline?.ToString("dd MMM")</small>
                                </a>
                            }
                        </div>
                    }
                    else { <p class="text-muted small">No overdue actions.</p> }
                </div>
            </div>
        </div>
    </div>
}

<!-- ═══ Personal Dashboard ═══ -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-person-fill"></i> My Tasks & Activity</h5>
    </div>
    <div class="card-body">
        @if (Model.PersonalData.ReportsAwaitingMyApproval.Any())
        {
            <div class="alert alert-info d-flex align-items-center mb-3">
                <i class="bi bi-check2-square fs-4 me-2"></i>
                <div>
                    <strong>@Model.PersonalData.ReportsAwaitingMyApproval.Count report(s) awaiting your approval</strong>
                    @foreach (var r in Model.PersonalData.ReportsAwaitingMyApproval)
                    {
                        <a href="/Reports/Details/@r.Id" class="badge bg-info text-decoration-none ms-1">@r.Title</a>
                    }
                </div>
            </div>
        }
        <div class="row g-3">
            <!-- My Pending Items -->
            <div class="col-md-4">
                <h6><i class="bi bi-file-earmark-text"></i> My Reports</h6>
                @{
                    var allMyReports = Model.PersonalData.DraftReports.Concat(Model.PersonalData.FeedbackRequested).ToList();
                }
                @if (allMyReports.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var r in allMyReports.Take(5))
                        {
                            <a href="/Reports/Details/@r.Id" class="list-group-item list-group-item-action py-2">
                                <div class="d-flex justify-content-between">
                                    <small class="fw-bold">@r.Title</small>
                                    @{
                                        var statusColor = r.Status == ReportingSystem.Models.ReportStatus.FeedbackRequested ? "bg-warning text-dark" : "bg-secondary";
                                    }
                                    <span class="badge @statusColor">@r.Status</span>
                                </div>
                                <small class="text-muted">@r.Committee?.Name</small>
                            </a>
                        }
                    </div>
                }
                else { <p class="text-muted small">No pending reports.</p> }

                <h6 class="mt-3"><i class="bi bi-megaphone"></i> Pending Directives</h6>
                @if (Model.PersonalData.PendingDirectives.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var d in Model.PersonalData.PendingDirectives.Take(5))
                        {
                            <a href="/Directives/Details/@d.Id" class="list-group-item list-group-item-action py-2">
                                <div class="d-flex justify-content-between">
                                    <small class="fw-bold">@d.Title</small>
                                    <span class="badge bg-warning text-dark">@d.Status</span>
                                </div>
                                <small class="text-muted">From @d.Issuer?.Name</small>
                            </a>
                        }
                    </div>
                }
                else { <p class="text-muted small">No pending directives.</p> }
            </div>

            <!-- Meetings & Action Items -->
            <div class="col-md-4">
                <h6><i class="bi bi-calendar-event"></i> Pending Meetings</h6>
                @if (Model.PersonalData.PendingMeetings.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var m in Model.PersonalData.PendingMeetings.Take(5))
                        {
                            <a href="/Meetings/Details/@m.Id" class="list-group-item list-group-item-action py-2">
                                <small class="fw-bold">@m.Title</small>
                                <br /><small class="text-muted">@m.ScheduledAt.ToString("dd MMM HH:mm") — @m.Status</small>
                            </a>
                        }
                    </div>
                }
                else { <p class="text-muted small">No pending meetings.</p> }

                <h6 class="mt-3"><i class="bi bi-list-task"></i> My Action Items</h6>
                @if (Model.PersonalData.MyActionItems.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var a in Model.PersonalData.MyActionItems.Take(5))
                        {
                            var overdue = a.Deadline.HasValue && a.Deadline.Value < DateTime.UtcNow;
                            <a href="/Meetings/ActionItems" class="list-group-item list-group-item-action py-2 @(overdue ? "list-group-item-danger" : "")">
                                <div class="d-flex justify-content-between">
                                    <small class="fw-bold">@a.Title</small>
                                    <span class="badge @(overdue ? "bg-danger" : "bg-secondary")">@a.Status</span>
                                </div>
                                @if (a.Deadline.HasValue)
                                {
                                    <small class="text-muted">Due @a.Deadline.Value.ToString("dd MMM")</small>
                                }
                            </a>
                        }
                    </div>
                }
                else { <p class="text-muted small">No pending action items.</p> }
            </div>

            <!-- Committees & Recent Activity -->
            <div class="col-md-4">
                <h6><i class="bi bi-people"></i> My Committees</h6>
                @if (Model.PersonalData.MyCommittees.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var c in Model.PersonalData.MyCommittees.Take(8))
                        {
                            <a href="/Admin/Organization/Committees/Details/@c.Id?returnTo=dashboard" class="list-group-item list-group-item-action py-2">
                                <div class="d-flex justify-content-between">
                                    <small>@c.Name</small>
                                    <span class="badge bg-light text-dark">@c.HierarchyLevel</span>
                                </div>
                            </a>
                        }
                    </div>
                }
                else { <p class="text-muted small">No committee memberships.</p> }

                <h6 class="mt-3"><i class="bi bi-bell"></i> Recent Activity</h6>
                @if (Model.PersonalData.RecentNotifications.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var n in Model.PersonalData.RecentNotifications.Take(5))
                        {
                            <div class="list-group-item py-2 @(!n.IsRead ? "list-group-item-light" : "")">
                                <small class="fw-bold">@n.Title</small>
                                <br /><small class="text-muted">@n.CreatedAt.ToString("dd MMM HH:mm")</small>
                            </div>
                        }
                    </div>
                    <a href="/Notifications" class="btn btn-sm btn-outline-primary mt-2">View All</a>
                }
                else { <p class="text-muted small">No recent activity.</p> }
            </div>
        </div>
    </div>
</div>
